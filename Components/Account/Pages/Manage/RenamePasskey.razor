@page "/Account/Manage/RenamePasskey/{Id}"
@layout BlazorApp1.Components.Layout.StoreLayout

@using BlazorApp1.Data
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Identity
@using System.Buffers.Text
@using Blazorise

@inject UserManager<ApplicationUser> UserManager
@inject IdentityRedirectManager RedirectManager

<PageTitle>Rename Passkey</PageTitle>

<div class="max-w-md mx-auto py-12 px-4">
    <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden">
        <div class="p-6 border-b border-gray-100">
            <h2 class="text-xl font-bold text-gray-900 flex items-center gap-2">
                <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.Edit" class="text-blue-600" />
                Rename Passkey
            </h2>
        </div>
        
        <div class="p-6">
            <EditForm Model="Input" OnValidSubmit="Rename" FormName="rename-passkey" method="post">
                <DataAnnotationsValidator />
                
                <div class="mb-6">
                    @if (passkey?.Name is { } name)
                    {
                        <p class="text-gray-600">Enter a new name for your <strong>"@name"</strong> passkey.</p>
                    }
                    else
                    {
                        <p class="text-gray-600">Enter a name for your passkey.</p>
                    }
                </div>

                <Microsoft.AspNetCore.Components.Forms.ValidationSummary class="text-red-600 bg-red-50 p-3 rounded-lg mb-4 text-sm" role="alert" />
                
                <div class="mb-6">
                    <label for="Input.Name" class="block text-sm font-medium text-gray-700 mb-2">Passkey Name</label>
                    <InputText @bind-Value="Input.Name" id="Input.Name" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition" placeholder="e.g. MacBook Pro, iPhone" />
                    <ValidationMessage For="() => Input.Name" class="text-red-600 text-sm mt-1" />
                </div>
                
                <div class="flex gap-3">
                    <a href="/Account/Manage/Passkeys" class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 font-semibold rounded-lg hover:bg-gray-50 text-center transition no-underline">
                        Cancel
                    </a>
                    <button type="submit" class="flex-1 px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition shadow-sm">
                        Save
                    </button>
                </div>
            </EditForm>
        </div>
    </div>
</div>

@code {
    private ApplicationUser? user;
    private UserPasskeyInfo? passkey;

    [CascadingParameter]
    private HttpContext HttpContext { get; set; } = default!;

    [Parameter]
    public string? Id { get; set; }

    [SupplyParameterFromForm]
    private InputModel Input { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        Input ??= new();

        user = (await UserManager.GetUserAsync(HttpContext.User))!;
        if (user is null)
        {
            RedirectManager.RedirectToInvalidUser(UserManager, HttpContext);
            return;
        }

        byte[] credentialId;
        try
        {
            credentialId = Base64Url.DecodeFromChars(Id);
        }
        catch (FormatException)
        {
            RedirectManager.RedirectToWithStatus("Account/Manage/Passkeys", "Error: The specified passkey ID had an invalid format.", HttpContext);
            return;
        }

        passkey = await UserManager.GetPasskeyAsync(user, credentialId);
        if (passkey is null)
        {
            RedirectManager.RedirectToWithStatus("Account/Manage/Passkeys", "Error: The specified passkey could not be found.", HttpContext);
            return;
        }
    }

    private async Task Rename()
    {
        passkey!.Name = Input.Name;
        var result = await UserManager.AddOrUpdatePasskeyAsync(user!, passkey);
        if (!result.Succeeded)
        {
            RedirectManager.RedirectToWithStatus("Account/Manage/Passkeys", "Error: The passkey could not be updated.", HttpContext);
            return;
        }

        RedirectManager.RedirectToWithStatus("Account/Manage/Passkeys", "Passkey updated successfully.", HttpContext);
    }

    private sealed class InputModel
    {
        [Required]
        [StringLength(200, ErrorMessage = "Passkey names must be no longer than {1} characters.")]
        public string Name { get; set; } = "";
    }
}
