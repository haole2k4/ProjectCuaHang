@page "/admin/employees"
@rendermode InteractiveServer

@using StoreManagementAPI.DTOs
@using StoreManagementAPI.Services
@using Blazorise

@inject IEmployeeService EmployeeService
@inject IJSRuntime JSRuntime

<PageTitle>Quản lý nhân viên</PageTitle>

<div class="flex justify-between items-center mb-6">
    <div>
        <Heading Size="HeadingSize.Is3" class="text-gray-900 font-bold">
            Quản lý nhân viên
        </Heading>
        <Paragraph class="text-gray-600 mb-0">Quản lý thông tin nhân viên và tài khoản</Paragraph>
    </div>
    <Button Color="Color.Primary" Clicked="OpenCreateModal" class="!text-white !bg-blue-600 hover:!bg-blue-700 shadow-md">
        <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.Plus" class="mr-2" /> Thêm nhân viên
    </Button>
</div>

@if (!string.IsNullOrEmpty(successMessage))
{
    <Alert Color="Color.Success" Visible class="mb-4">
        <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.CheckCircle" class="mr-2" />
        @successMessage
    </Alert>
}

<!-- Filter Section -->
<Card class="!bg-white shadow-md mb-4">
    <CardBody>
        <div class="grid grid-cols-4 gap-4">
            <div>
                <label class="text-sm font-medium text-gray-700 mb-1 block">Tìm kiếm</label>
                <TextEdit @bind-Text="searchTerm" Placeholder="Tên, email, SĐT..." />
            </div>
            <div>
                <label class="text-sm font-medium text-gray-700 mb-1 block">Loại nhân viên</label>
                <Select TValue="string" @bind-SelectedValue="filterType">
                    <SelectItem Value="@("")">Tất cả</SelectItem>
                    <SelectItem Value="@("sales")">Bán hàng</SelectItem>
                    <SelectItem Value="@("warehouse")">Nhập hàng</SelectItem>
                </Select>
            </div>
            <div>
                <label class="text-sm font-medium text-gray-700 mb-1 block">Trạng thái</label>
                <Select TValue="string" @bind-SelectedValue="filterStatus">
                    <SelectItem Value="@("")">Tất cả</SelectItem>
                    <SelectItem Value="@("active")">Hoạt động</SelectItem>
                    <SelectItem Value="@("inactive")">Không hoạt động</SelectItem>
                </Select>
            </div>
            <div class="flex items-end">
                <Button Color="Color.Secondary" Clicked="ApplyFilters" class="w-full">
                    <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.Search" class="mr-2" /> Tìm kiếm
                </Button>
            </div>
        </div>
    </CardBody>
</Card>

<!-- Employees Table -->
<Card class="!bg-white shadow-xl border border-gray-200 rounded-xl overflow-hidden">
    <CardBody Padding="Padding.Is0">
        <div class="overflow-x-auto">
            <Table class="mb-0 w-full">
                <TableHeader>
                    <TableRow class="bg-white border-b-2 border-gray-200">
                        <TableHeaderCell class="px-6 py-4 text-left text-gray-900 font-bold text-sm uppercase">Họ tên</TableHeaderCell>
                        <TableHeaderCell class="px-6 py-4 text-left text-gray-900 font-bold text-sm uppercase">Số điện thoại</TableHeaderCell>
                        <TableHeaderCell class="px-6 py-4 text-left text-gray-900 font-bold text-sm uppercase">Email</TableHeaderCell>
                        <TableHeaderCell class="px-6 py-4 text-center text-gray-900 font-bold text-sm uppercase">Loại</TableHeaderCell>
                        <TableHeaderCell class="px-6 py-4 text-center text-gray-900 font-bold text-sm uppercase">Tài khoản</TableHeaderCell>
                        <TableHeaderCell class="px-6 py-4 text-center text-gray-900 font-bold text-sm uppercase">Mật khẩu</TableHeaderCell>
                        <TableHeaderCell class="px-6 py-4 text-center text-gray-900 font-bold text-sm uppercase">Trạng thái</TableHeaderCell>
                        <TableHeaderCell class="px-6 py-4 text-center text-gray-900 font-bold text-sm uppercase">Thao tác</TableHeaderCell>
                    </TableRow>
                </TableHeader>
                <TableBody class="bg-white divide-y divide-gray-200">
                    @if (filteredEmployees != null && filteredEmployees.Any())
                    {
                        @foreach (var employee in filteredEmployees)
                        {
                            <TableRow class="hover:bg-gray-50 transition-colors">
                                <TableRowCell class="px-6 py-4">
                                    <span class="font-semibold text-gray-900">@employee.FullName</span>
                                </TableRowCell>
                                <TableRowCell class="px-6 py-4 text-gray-700">@employee.Phone</TableRowCell>
                                <TableRowCell class="px-6 py-4 text-gray-700">@employee.Email</TableRowCell>
                                <TableRowCell class="px-6 py-4 text-center">
                                    @if (employee.EmployeeType == "sales")
                                    {
                                        <Badge Color="Color.Primary" class="!bg-blue-100 !text-blue-800">Bán hàng</Badge>
                                    }
                                    else
                                    {
                                        <Badge Color="Color.Info" class="!bg-cyan-100 !text-cyan-800">Nhập hàng</Badge>
                                    }
                                </TableRowCell>
                                <TableRowCell class="px-6 py-4 text-center">
                                    @if (!string.IsNullOrEmpty(employee.Username))
                                    {
                                        <span class="text-green-600 font-medium">@employee.Username</span>
                                    }
                                    else
                                    {
                                        <span class="text-gray-400">Chưa có</span>
                                    }
                                </TableRowCell>
                                <TableRowCell class="px-6 py-4 text-center">
                                    @if (!string.IsNullOrEmpty(employee.PlaintextPassword))
                                    {
                                        <span class="font-mono text-sm bg-gray-100 px-2 py-1 rounded">@employee.PlaintextPassword</span>
                                    }
                                    else
                                    {
                                        <span class="text-gray-400">-</span>
                                    }
                                </TableRowCell>
                                <TableRowCell class="px-6 py-4 text-center">
                                    @if (employee.Status == "active")
                                    {
                                        <Badge Color="Color.Success" class="!bg-green-100 !text-green-800">Hoạt động</Badge>
                                    }
                                    else
                                    {
                                        <Badge Color="Color.Secondary" class="!bg-gray-100 !text-gray-800">Không hoạt động</Badge>
                                    }
                                </TableRowCell>
                                <TableRowCell class="px-6 py-4 text-center">
                                    <Button Color="Color.Warning" Size="Size.Small" Clicked="@(() => OpenEditModal(employee))" class="!bg-yellow-50 !text-yellow-600 hover:!bg-yellow-100 mr-2">
                                        <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.Edit" />
                                    </Button>
                                    <Button Color="Color.Danger" Size="Size.Small" Clicked="@(() => DeleteEmployee(employee.EmployeeId))" class="!bg-red-50 !text-red-600 hover:!bg-red-100">
                                        <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.Trash" />
                                    </Button>
                                </TableRowCell>
                            </TableRow>
                        }
                    }
                    else
                    {
                        <TableRow>
                            <TableRowCell ColumnSpan="7" class="px-6 py-8 text-center text-gray-500">
                                <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.Inbox" class="text-4xl mb-2" />
                                <p>Không tìm thấy nhân viên nào</p>
                            </TableRowCell>
                        </TableRow>
                    }
                </TableBody>
            </Table>
        </div>
    </CardBody>
</Card>

<!-- Create/Edit Modal -->
<Modal @ref="employeeModal">
    <ModalContent Size="ModalSize.Large">
        <ModalHeader class="bg-white border-b border-gray-200">
            <ModalTitle class="text-gray-900 font-bold">@modalTitle</ModalTitle>
            <CloseButton Clicked="@(() => employeeModal.Hide())" />
        </ModalHeader>
        <ModalBody class="bg-white">
            <div class="space-y-4">
                <div>
                    <label class="text-sm font-semibold text-gray-700 mb-1 block">Họ tên <span class="text-red-500">*</span></label>
                    <TextEdit @bind-Text="currentEmployee.FullName" Placeholder="Nhập họ tên nhân viên" />
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-sm font-semibold text-gray-700 mb-1 block">Số điện thoại <span class="text-red-500">*</span></label>
                        <TextEdit @bind-Text="currentEmployee.Phone" Placeholder="Nhập số điện thoại" />
                    </div>
                    <div>
                        <label class="text-sm font-semibold text-gray-700 mb-1 block">Email <span class="text-red-500">*</span></label>
                        <TextEdit @bind-Text="currentEmployee.Email" Placeholder="Nhập email" />
                    </div>
                </div>
                
                <div>
                    <label class="text-sm font-semibold text-gray-700 mb-1 block">Loại nhân viên <span class="text-red-500">*</span></label>
                    <Select TValue="string" @bind-SelectedValue="currentEmployee.EmployeeType">
                        <SelectItem Value="@("sales")">Bán hàng (Quản lý đơn hàng, sản phẩm, danh mục)</SelectItem>
                        <SelectItem Value="@("warehouse")">Nhập hàng (Quản lý kho, phiếu nhập)</SelectItem>
                    </Select>
                </div>

                @if (!isEditMode)
                {
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <p class="text-sm font-semibold text-blue-900 mb-2">
                            <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.InfoCircle" class="mr-2" />
                            Tạo tài khoản đăng nhập
                        </p>
                        <p class="text-sm text-blue-700">Nhập thông tin để tạo tài khoản đăng nhập cho nhân viên. Bỏ trống nếu chưa cần.</p>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-sm font-semibold text-gray-700 mb-1 block">Tên đăng nhập</label>
                            <TextEdit @bind-Text="currentEmployee.Username" Placeholder="Nhập username" />
                        </div>
                        <div>
                            <label class="text-sm font-semibold text-gray-700 mb-1 block">Mật khẩu</label>
                            <TextEdit @bind-Text="currentEmployee.Password" Role="TextRole.Password" Placeholder="Nhập mật khẩu" />
                        </div>
                    </div>
                }
            </div>
        </ModalBody>
        <ModalFooter class="bg-gray-50 border-t border-gray-200">
            <Button Color="Color.Secondary" Clicked="@(() => employeeModal.Hide())" class="!bg-white !border-2 !border-gray-300 !text-gray-900 hover:!bg-gray-100">Hủy</Button>
            <Button Color="Color.Primary" Clicked="SaveEmployee" class="!bg-blue-600 hover:!bg-blue-700 !text-white shadow-md">
                Lưu
            </Button>
        </ModalFooter>
    </ModalContent>
</Modal>

@code {
    private List<EmployeeDto> employees = new();
    private List<EmployeeDto> filteredEmployees = new();
    private CreateEmployeeDto currentEmployee = new() { EmployeeType = "sales" };
    private Modal employeeModal = default!;
    private string modalTitle = "";
    private bool isEditMode = false;
    private int editingEmployeeId = 0;

    // Filters
    private string searchTerm = string.Empty;
    private string filterType = string.Empty;
    private string filterStatus = string.Empty;
    private string? successMessage;

    protected override async Task OnInitializedAsync()
    {
        await LoadEmployees();
    }

    private async Task LoadEmployees()
    {
        var result = await EmployeeService.GetAllEmployeesAsync();
        employees = result.ToList();
        ApplyFilters();
    }

    private void ApplyFilters()
    {
        filteredEmployees = employees.Where(e =>
        {
            bool matchSearch = string.IsNullOrWhiteSpace(searchTerm) ||
                e.FullName.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                e.Email.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                e.Phone.Contains(searchTerm, StringComparison.OrdinalIgnoreCase);

            bool matchType = string.IsNullOrEmpty(filterType) || e.EmployeeType == filterType;
            bool matchStatus = string.IsNullOrEmpty(filterStatus) || e.Status == filterStatus;

            return matchSearch && matchType && matchStatus;
        }).ToList();
    }

    private void OpenCreateModal()
    {
        isEditMode = false;
        modalTitle = "Thêm nhân viên mới";
        currentEmployee = new CreateEmployeeDto { EmployeeType = "sales" };
        employeeModal.Show();
    }

    private void OpenEditModal(EmployeeDto employee)
    {
        isEditMode = true;
        modalTitle = "Chỉnh sửa nhân viên";
        editingEmployeeId = employee.EmployeeId;
        currentEmployee = new CreateEmployeeDto
        {
            FullName = employee.FullName,
            Phone = employee.Phone,
            Email = employee.Email,
            EmployeeType = employee.EmployeeType
        };
        employeeModal.Show();
    }

    private async Task SaveEmployee()
    {
        try
        {
            if (string.IsNullOrWhiteSpace(currentEmployee.FullName) ||
                string.IsNullOrWhiteSpace(currentEmployee.Phone) ||
                string.IsNullOrWhiteSpace(currentEmployee.Email))
            {
                await JSRuntime.InvokeVoidAsync("alert", "Vui lòng điền đầy đủ thông tin bắt buộc!");
                return;
            }

            if (!isEditMode)
            {
                // Validate username/password pair
                if (!string.IsNullOrWhiteSpace(currentEmployee.Username) && string.IsNullOrWhiteSpace(currentEmployee.Password))
                {
                    await JSRuntime.InvokeVoidAsync("alert", "Vui lòng nhập mật khẩu cho tài khoản!");
                    return;
                }

                await EmployeeService.CreateEmployeeAsync(currentEmployee);
                successMessage = "Thêm nhân viên thành công!";
            }
            else
            {
                var updateDto = new UpdateEmployeeDto
                {
                    FullName = currentEmployee.FullName,
                    Phone = currentEmployee.Phone,
                    Email = currentEmployee.Email,
                    EmployeeType = currentEmployee.EmployeeType
                };
                await EmployeeService.UpdateEmployeeAsync(editingEmployeeId, updateDto);
                successMessage = "Cập nhật nhân viên thành công!";
            }

            employeeModal.Hide();
            await LoadEmployees();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Lỗi: {ex.Message}");
        }
    }

    private async Task DeleteEmployee(int employeeId)
    {
        bool confirmed = await JSRuntime.InvokeAsync<bool>("confirm", "Bạn có chắc chắn muốn xóa nhân viên này?");
        if (!confirmed) return;

        try
        {
            await EmployeeService.DeleteEmployeeAsync(employeeId);
            successMessage = "Xóa nhân viên thành công!";
            await LoadEmployees();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Lỗi: {ex.Message}");
        }
    }
}
