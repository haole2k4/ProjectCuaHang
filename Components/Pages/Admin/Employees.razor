@page "/admin/employees"
@rendermode InteractiveServer
@attribute [Authorize(Roles = "Admin")]

@using StoreManagementAPI.DTOs
@using StoreManagementAPI.Services
@using Blazorise

@inject IEmployeeService EmployeeService
@inject IJSRuntime JSRuntime

<PageTitle>Quản lý nhân viên</PageTitle>

<div class="flex justify-between items-center mb-6">
    <div>
        <Heading Size="HeadingSize.Is3" class="text-gray-900 font-bold">
            Quản lý nhân viên
        </Heading>
        <Paragraph class="text-gray-600 mb-0">Quản lý thông tin nhân viên và tài khoản</Paragraph>
    </div>
    <Button Color="Color.Primary" Clicked="OpenCreateModal" class="!text-white !bg-blue-600 hover:!bg-blue-700 shadow-md">
        <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.Plus" class="mr-2" /> Thêm nhân viên
    </Button>
</div>

<!-- Filter Section -->
<Card class="!bg-white shadow-md mb-4">
    <CardBody>
        <div class="grid grid-cols-4 gap-4">
            <div>
                <label class="text-sm font-medium text-gray-700 mb-1 block">Tìm kiếm</label>
                <TextEdit Text="@searchTerm"
                          TextChanged="@OnSearchChanged"
                          Placeholder="Tên, email, SĐT..."
                          Autocomplete="Autocomplete.Off"
                          class="!bg-white !text-gray-900 !border-2 !border-gray-300" />
            </div>
            <div>
                <label class="text-sm font-medium text-gray-700 mb-1 block">Loại nhân viên</label>
                <Select TValue="string" SelectedValue="@filterType" SelectedValueChanged="@OnTypeChanged" class="!bg-white !text-gray-900 !border-2 !border-gray-300">
                    <SelectItem Value="@("")">Tất cả</SelectItem>
                    <SelectItem Value="@("sales")">Bán hàng</SelectItem>
                    <SelectItem Value="@("warehouse")">Nhập hàng</SelectItem>
                </Select>
            </div>
            <div>
                <label class="text-sm font-medium text-gray-700 mb-1 block">Trạng thái</label>
                <Select TValue="string" SelectedValue="@filterStatus" SelectedValueChanged="@OnStatusChanged" class="!bg-white !text-gray-900 !border-2 !border-gray-300">
                    <SelectItem Value="@("")">Tất cả</SelectItem>
                    <SelectItem Value="@("active")">Hoạt động</SelectItem>
                    <SelectItem Value="@("inactive")">Không hoạt động</SelectItem>
                </Select>
            </div>
            <div class="flex items-end">
                <Button Color="Color.Light" Clicked="ClearFilters" class="w-full !border-2 !border-gray-400">
                    <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.Redo" class="mr-2" /> Xóa bộ lọc
                </Button>
            </div>
        </div>
    </CardBody>
</Card>

<!-- Employees Table -->
<Card class="!bg-white shadow-xl border border-gray-200 rounded-xl overflow-hidden">
    <CardBody Padding="Padding.Is0">
        <div class="overflow-x-auto">
            <Table class="mb-0 w-full">
                <TableHeader>
                    <TableRow class="bg-white border-b-2 border-gray-200">
                        <TableHeaderCell class="px-6 py-4 text-left text-gray-900 font-bold text-sm uppercase">Họ tên</TableHeaderCell>
                        <TableHeaderCell class="px-6 py-4 text-left text-gray-900 font-bold text-sm uppercase">Số điện thoại</TableHeaderCell>
                        <TableHeaderCell class="px-6 py-4 text-left text-gray-900 font-bold text-sm uppercase">Email</TableHeaderCell>
                        <TableHeaderCell class="px-6 py-4 text-center text-gray-900 font-bold text-sm uppercase">Loại</TableHeaderCell>
                        <TableHeaderCell class="px-6 py-4 text-center text-gray-900 font-bold text-sm uppercase">Tài khoản</TableHeaderCell>
                        <TableHeaderCell class="px-6 py-4 text-center text-gray-900 font-bold text-sm uppercase">Mật khẩu</TableHeaderCell>
                        <TableHeaderCell class="px-6 py-4 text-center text-gray-900 font-bold text-sm uppercase">Trạng thái</TableHeaderCell>
                        <TableHeaderCell class="px-6 py-4 text-center text-gray-900 font-bold text-sm uppercase">Thao tác</TableHeaderCell>
                    </TableRow>
                </TableHeader>
                <TableBody class="bg-white divide-y divide-gray-200">
                    @if (filteredEmployees != null && filteredEmployees.Any())
                    {
                        @foreach (var employee in filteredEmployees)
                        {
                            <TableRow class="hover:bg-gray-50 transition-colors">
                                <TableRowCell class="px-6 py-4">
                                    <span class="font-semibold text-gray-900">@employee.FullName</span>
                                </TableRowCell>
                                <TableRowCell class="px-6 py-4 text-gray-700">@employee.Phone</TableRowCell>
                                <TableRowCell class="px-6 py-4 text-gray-700">@employee.Email</TableRowCell>
                                <TableRowCell class="px-6 py-4 text-center">
                                    @if (employee.EmployeeType == "sales")
                                    {
                                        <Badge Color="Color.Primary" class="!bg-blue-100 !text-blue-800">Bán hàng</Badge>
                                    }
                                    else
                                    {
                                        <Badge Color="Color.Info" class="!bg-cyan-100 !text-cyan-800">Nhập hàng</Badge>
                                    }
                                </TableRowCell>
                                <TableRowCell class="px-6 py-4 text-center">
                                    @if (!string.IsNullOrEmpty(employee.Username))
                                    {
                                        <span class="text-green-600 font-medium">@employee.Username</span>
                                    }
                                    else
                                    {
                                        <span class="text-gray-400">Chưa có</span>
                                    }
                                </TableRowCell>
                                <TableRowCell class="px-6 py-4 text-center">
                                    @if (!string.IsNullOrEmpty(employee.PlaintextPassword))
                                    {
                                        <span class="font-mono text-sm bg-gray-100 px-2 py-1 rounded">@employee.PlaintextPassword</span>
                                    }
                                    else
                                    {
                                        <span class="text-gray-400">-</span>
                                    }
                                </TableRowCell>
                                <TableRowCell class="px-6 py-4 text-center">
                                    @if (employee.Status == "active")
                                    {
                                        <Badge Color="Color.Success" class="!bg-green-100 !text-green-800">Hoạt động</Badge>
                                    }
                                    else
                                    {
                                        <Badge Color="Color.Secondary" class="!bg-gray-100 !text-gray-800">Không hoạt động</Badge>
                                    }
                                </TableRowCell>
                                <TableRowCell class="px-6 py-4 text-center">
                                    <Button Color="Color.Warning" Size="Size.Small" Clicked="@(() => OpenEditModal(employee))" class="!bg-yellow-50 !text-yellow-600 hover:!bg-yellow-100 mr-2">
                                        <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.Edit" />
                                    </Button>
                                    <Button Color="Color.Danger" Size="Size.Small" Clicked="@(() => DeleteEmployee(employee.EmployeeId))" class="!bg-red-50 !text-red-600 hover:!bg-red-100">
                                        <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.Trash" />
                                    </Button>
                                </TableRowCell>
                            </TableRow>
                        }
                    }
                    else
                    {
                        <TableRow>
                            <TableRowCell ColumnSpan="7" class="px-6 py-8 text-center text-gray-500">
                                <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.Inbox" class="text-4xl mb-2" />
                                <p>Không tìm thấy nhân viên nào</p>
                            </TableRowCell>
                        </TableRow>
                    }
                </TableBody>
            </Table>
        </div>
    </CardBody>
</Card>

<!-- Toast Notification -->
@if (showToast)
{
    <div class="fixed bottom-6 right-6 z-50 animate-slide-up">
        <div class="@toastClass text-white px-6 py-4 rounded-xl shadow-2xl flex items-center gap-3 max-w-md">
            <div class="flex-shrink-0">
                <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center">
                    <i class="@toastIcon text-lg"></i>
                </div>
            </div>
            <div class="flex-1">
                <p class="font-semibold">@toastMessage</p>
            </div>
            <button @onclick="() => showToast = false"
                    class="flex-shrink-0 text-white/80 hover:text-white transition">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>
}

<!-- Create/Edit Modal -->
<Modal @ref="employeeModal">
    <ModalContent Size="ModalSize.Large">
        <ModalHeader class="bg-white border-b border-gray-200">
            <ModalTitle class="text-gray-900 font-bold">@modalTitle</ModalTitle>
            <CloseButton Clicked="@(() => employeeModal.Hide())" />
        </ModalHeader>
        <ModalBody class="bg-white">
            <div id="employee-form" class="space-y-4">
                <div>
                    <label class="text-sm font-semibold text-gray-700 mb-1 block">Họ tên <span class="text-red-500">*</span></label>
                    <TextEdit @bind-Text="currentEmployee.FullName" Placeholder="Nhập họ tên nhân viên" Autocomplete="Autocomplete.Off" />
                    @if (validationErrors.ContainsKey("FullName"))
                    {
                        <p class="text-red-600 text-sm mt-1 font-semibold">@validationErrors["FullName"]</p>
                    }
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-sm font-semibold text-gray-700 mb-1 block">Số điện thoại <span class="text-red-500">*</span></label>
                        <TextEdit @bind-Text="currentEmployee.Phone" Placeholder="Nhập số điện thoại" Autocomplete="Autocomplete.Off" />
                        @if (validationErrors.ContainsKey("Phone"))
                        {
                            <p class="text-red-600 text-sm mt-1 font-semibold">@validationErrors["Phone"]</p>
                        }
                    </div>
                    <div>
                        <label class="text-sm font-semibold text-gray-700 mb-1 block">Email <span class="text-red-500">*</span></label>
                        <TextEdit @bind-Text="currentEmployee.Email" Placeholder="Nhập email" Autocomplete="Autocomplete.Off" />
                        @if (validationErrors.ContainsKey("Email"))
                        {
                            <p class="text-red-600 text-sm mt-1 font-semibold">@validationErrors["Email"]</p>
                        }
                    </div>
                </div>
                
                <div>
                    <label class="text-sm font-semibold text-gray-700 mb-1 block">Loại nhân viên <span class="text-red-500">*</span></label>
                    <Select TValue="string" @bind-SelectedValue="currentEmployee.EmployeeType">
                        <SelectItem Value="@("sales")">Bán hàng (Quản lý đơn hàng, sản phẩm, danh mục)</SelectItem>
                        <SelectItem Value="@("warehouse")">Nhập hàng (Quản lý kho, phiếu nhập)</SelectItem>
                    </Select>
                </div>

                @if (!isEditMode)
                {
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <p class="text-sm font-semibold text-blue-900 mb-2">
                            <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.InfoCircle" class="mr-2" />
                            Tạo tài khoản đăng nhập
                        </p>
                        <p class="text-sm text-blue-700">Nhập thông tin để tạo tài khoản đăng nhập cho nhân viên. Bỏ trống nếu chưa cần.</p>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-sm font-semibold text-gray-700 mb-1 block">Tên đăng nhập</label>
                            <TextEdit @bind-Text="currentEmployee.Username" Placeholder="Nhập username" Autocomplete="Autocomplete.Off" />
                        </div>
                        <div>
                            <label class="text-sm font-semibold text-gray-700 mb-1 block">Mật khẩu</label>
                            <TextEdit @bind-Text="currentEmployee.Password" Role="TextRole.Password" Placeholder="Nhập mật khẩu" Autocomplete="Autocomplete.Off" />
                        </div>
                    </div>
                }
            </div>
        </ModalBody>
        <ModalFooter class="bg-gray-50 border-t border-gray-200">
            <Button Color="Color.Secondary" Clicked="@(() => employeeModal.Hide())" class="!bg-white !border-2 !border-gray-300 !text-gray-900 hover:!bg-gray-100">Hủy</Button>
            <Button Color="Color.Primary" Clicked="SaveEmployee" class="!bg-blue-600 hover:!bg-blue-700 !text-white shadow-md">
                Lưu
            </Button>
        </ModalFooter>
    </ModalContent>
</Modal>

<style>
    @@keyframes slide-up {
        from {
            transform: translateY(100%);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    .animate-slide-up {
        animation: slide-up 0.3s ease-out;
    }
</style>

@code {
    private List<EmployeeDto> employees = new();
    private List<EmployeeDto> filteredEmployees = new();
    private CreateEmployeeDto currentEmployee = new() { EmployeeType = "sales" };
    private Modal employeeModal = default!;
    private string modalTitle = "";
    private bool isEditMode = false;
    private int editingEmployeeId = 0;
    private Dictionary<string, string> validationErrors = new();

    // Filters
    private string searchTerm = string.Empty;
    private string filterType = string.Empty;
    private string filterStatus = string.Empty;

    // Toast notification
    private bool showToast = false;
    private string toastMessage = "";
    private string toastClass = "";
    private string toastIcon = "";

    protected override async Task OnInitializedAsync()
    {
        await LoadEmployees();
    }

    private async Task LoadEmployees()
    {
        var result = await EmployeeService.GetAllEmployeesAsync();
        employees = result.ToList();
        ApplyFilters();
    }

    private void ApplyFilters()
    {
        filteredEmployees = employees.Where(e =>
        {
            bool matchSearch = string.IsNullOrWhiteSpace(searchTerm) ||
                e.FullName.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                e.Email.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                e.Phone.Contains(searchTerm, StringComparison.OrdinalIgnoreCase);

            bool matchType = string.IsNullOrEmpty(filterType) || e.EmployeeType == filterType;
            bool matchStatus = string.IsNullOrEmpty(filterStatus) || e.Status == filterStatus;

            return matchSearch && matchType && matchStatus;
        }).ToList();
    }

    private void OnSearchChanged(string value)
    {
        searchTerm = value;
        ApplyFilters();
    }

    private void OnTypeChanged(string value)
    {
        filterType = value;
        ApplyFilters();
    }

    private void OnStatusChanged(string value)
    {
        filterStatus = value;
        ApplyFilters();
    }

    private void ClearFilters()
    {
        searchTerm = string.Empty;
        filterType = string.Empty;
        filterStatus = string.Empty;
        ApplyFilters();
    }

    private void OpenCreateModal()
    {
        isEditMode = false;
        modalTitle = "Thêm nhân viên mới";
        currentEmployee = new CreateEmployeeDto { EmployeeType = "sales", Email = string.Empty, Phone = string.Empty, FullName = string.Empty, Username = string.Empty, Password = string.Empty };
        validationErrors.Clear();
        employeeModal.Show();
        
        // Clear browser autocomplete
        _ = Task.Delay(100).ContinueWith(_ => 
        {
            InvokeAsync(async () => 
            {
                await JSRuntime.InvokeVoidAsync("clearAutocomplete", "employee-form");
            });
        });
    }

    private void OpenEditModal(EmployeeDto employee)
    {
        isEditMode = true;
        modalTitle = "Chỉnh sửa nhân viên";
        editingEmployeeId = employee.EmployeeId;
        currentEmployee = new CreateEmployeeDto
        {
            FullName = employee.FullName,
            Phone = employee.Phone,
            Email = employee.Email,
            EmployeeType = employee.EmployeeType
        };
        validationErrors.Clear();
        employeeModal.Show();
    }

    private async Task SaveEmployee()
    {
        try
        {
            validationErrors.Clear();
            bool hasErrors = false;

            if (string.IsNullOrWhiteSpace(currentEmployee.FullName))
            {
                validationErrors["FullName"] = "Họ tên là bắt buộc";
                hasErrors = true;
            }

            if (string.IsNullOrWhiteSpace(currentEmployee.Phone))
            {
                validationErrors["Phone"] = "Số điện thoại là bắt buộc";
                hasErrors = true;
            }
            else if (!System.Text.RegularExpressions.Regex.IsMatch(currentEmployee.Phone, @"^[0-9]{10,11}$"))
            {
                validationErrors["Phone"] = "Số điện thoại phải có 10-11 chữ số";
                hasErrors = true;
            }

            if (string.IsNullOrWhiteSpace(currentEmployee.Email))
            {
                validationErrors["Email"] = "Email là bắt buộc";
                hasErrors = true;
            }
            else if (!System.Text.RegularExpressions.Regex.IsMatch(currentEmployee.Email, @"^[^@\s]+@[^@\s]+\.[^@\s]+$"))
            {
                validationErrors["Email"] = "Định dạng email không hợp lệ";
                hasErrors = true;
            }

            if (hasErrors)
            {
                return;
            }

            // Check if phone already exists
            if (!string.IsNullOrWhiteSpace(currentEmployee.Phone))
            {
                var phoneExists = await EmployeeService.CheckPhoneExists(currentEmployee.Phone, isEditMode ? editingEmployeeId : null);
                if (phoneExists)
                {
                    validationErrors["Phone"] = "Số điện thoại đã tồn tại";
                    return;
                }
            }

            // Check if email already exists
            if (!string.IsNullOrWhiteSpace(currentEmployee.Email))
            {
                var emailExists = await EmployeeService.CheckEmailExists(currentEmployee.Email, isEditMode ? editingEmployeeId : null);
                if (emailExists)
                {
                    validationErrors["Email"] = "Email đã tồn tại";
                    return;
                }
            }

            if (!isEditMode)
            {
                // Validate username/password pair
                if (!string.IsNullOrWhiteSpace(currentEmployee.Username) && string.IsNullOrWhiteSpace(currentEmployee.Password))
                {
                    await JSRuntime.InvokeVoidAsync("alert", "Vui lòng nhập mật khẩu cho tài khoản!");
                    return;
                }

                await EmployeeService.CreateEmployeeAsync(currentEmployee);
                employeeModal.Hide();
                await LoadEmployees();
                ShowToast("Thêm nhân viên thành công!", "bg-green-600", "fas fa-check");
            }
            else
            {
                var updateDto = new UpdateEmployeeDto
                {
                    FullName = currentEmployee.FullName,
                    Phone = currentEmployee.Phone,
                    Email = currentEmployee.Email,
                    EmployeeType = currentEmployee.EmployeeType
                };
                await EmployeeService.UpdateEmployeeAsync(editingEmployeeId, updateDto);
                employeeModal.Hide();
                await LoadEmployees();
                ShowToast("Cập nhật nhân viên thành công!", "bg-green-600", "fas fa-check");
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Lỗi: {ex.Message}");
        }
    }

    private async Task DeleteEmployee(int employeeId)
    {
        bool confirmed = await JSRuntime.InvokeAsync<bool>("confirm", "Bạn có chắc chắn muốn xóa nhân viên này?");
        if (!confirmed) return;

        try
        {
            await EmployeeService.DeleteEmployeeAsync(employeeId);
            await LoadEmployees();
            ShowToast("Xóa nhân viên thành công!", "bg-green-600", "fas fa-check");
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Lỗi: {ex.Message}");
        }
    }

    private void ShowToast(string message, string cssClass, string icon)
    {
        toastMessage = message;
        toastClass = cssClass;
        toastIcon = icon;
        showToast = true;

        Task.Delay(3000).ContinueWith(_ =>
        {
            showToast = false;
            InvokeAsync(StateHasChanged);
        });
    }
}

<script>
    window.clearAutocomplete = function(formId) {
        const form = document.getElementById(formId);
        if (form) {
            const inputs = form.querySelectorAll('input[type="text"], input[type="email"], input[type="password"]');
            inputs.forEach(input => {
                input.value = '';
                input.setAttribute('autocomplete', 'off');
                input.setAttribute('data-form-type', 'other');
            });
        }
    };
</script>
