@page "/admin/customers"
@rendermode InteractiveServer
@attribute [Authorize(Roles = "Admin")]

@using StoreManagementAPI.Data
@using StoreManagementAPI.Models
@using Microsoft.EntityFrameworkCore
@using Blazorise
@using Microsoft.AspNetCore.Identity
@using BlazorApp1.Data

@inject StoreDbContext DbContext
@inject IJSRuntime JSRuntime
@inject UserManager<ApplicationUser> UserManager
@inject RoleManager<IdentityRole> RoleManager

<PageTitle>Customers - Admin</PageTitle>

<div class="flex justify-between items-center mb-6">
    <div>
        <Heading Size="HeadingSize.Is3" class="!text-gray-900 font-bold">Customers</Heading>
        <Paragraph class="text-gray-600 mb-0">Manage your customer base</Paragraph>
    </div>
    <Button Color="Color.Primary" Clicked="OpenAddModal" class="!text-white !bg-blue-600 hover:!bg-blue-700 shadow-md">
        <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.Plus" class="mr-2" /> Add Customer
    </Button>
</div>

<!-- Stats Cards -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
    <Card class="shadow-md border-0 !bg-white">
        <CardBody class="p-6">
            <div class="flex items-center justify-between">
                <div>
                    <Paragraph class="!text-gray-600 text-sm mb-1">Total Customers</Paragraph>
                    <Heading Size="HeadingSize.Is3" class="!text-gray-900 mb-0">@customers?.Count</Heading>
                </div>
                <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
                    <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.Users" class="text-blue-600 text-xl" />
                </div>
            </div>
        </CardBody>
    </Card>

    <Card class="shadow-md border-0 !bg-white">
        <CardBody class="p-6">
            <div class="flex items-center justify-between">
                <div>
                    <Paragraph class="!text-gray-600 text-sm mb-1">Active</Paragraph>
                    <Heading Size="HeadingSize.Is3" class="!text-green-600 mb-0">@customers?.Count(c => c.Status == "active")</Heading>
                </div>
                <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">
                    <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.UserCheck" class="text-green-600 text-xl" />
                </div>
            </div>
        </CardBody>
    </Card>

    <Card class="shadow-md border-0 !bg-white">
        <CardBody class="p-6">
            <div class="flex items-center justify-between">
                <div>
                    <Paragraph class="!text-gray-600 text-sm mb-1">Total Orders</Paragraph>
                    <Heading Size="HeadingSize.Is3" class="!text-purple-600 mb-0">@customers?.Sum(c => c.Orders?.Count ?? 0)</Heading>
                </div>
                <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center">
                    <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.ShoppingCart" class="text-purple-600 text-xl" />
                </div>
            </div>
        </CardBody>
    </Card>

    <Card class="shadow-md border-0 !bg-white">
        <CardBody class="p-6">
            <div class="flex items-center justify-between">
                <div>
                    <Paragraph class="!text-gray-600 text-sm mb-1">New This Month</Paragraph>
                    <Heading Size="HeadingSize.Is3" class="!text-orange-600 mb-0">@customers?.Count(c => c.CreatedAt >= DateTime.Now.AddMonths(-1))</Heading>
                </div>
                <div class="w-12 h-12 bg-orange-100 rounded-xl flex items-center justify-center">
                    <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.UserPlus" class="text-orange-600 text-xl" />
                </div>
            </div>
        </CardBody>
    </Card>
</div>

<!-- Filter Section -->
<Card class="!bg-white shadow-md mb-4">
    <CardBody>
        <div class="grid grid-cols-4 gap-4">
            <div>
                <label class="text-sm font-medium text-gray-700 mb-1 block">Search</label>
                <TextEdit Text="@searchTerm"
                          TextChanged="@OnSearchChanged"
                          Placeholder="Name, email, phone..."
                          Autocomplete="Autocomplete.Off"
                          class="!bg-white !text-gray-900 !border-2 !border-gray-300" />
            </div>
            <div>
                <label class="text-sm font-medium text-gray-700 mb-1 block">Role</label>
                <Select TValue="string" SelectedValue="@filterRole" SelectedValueChanged="@OnRoleChanged" class="!bg-white !text-gray-900 !border-2 !border-gray-300">
                    <SelectItem Value="@("")">All Roles</SelectItem>
                    <SelectItem Value="@("Customer")">Customer</SelectItem>
                    <SelectItem Value="@("Admin")">Admin</SelectItem>
                    <SelectItem Value="@("SalesStaff")">Sales Staff</SelectItem>
                    <SelectItem Value="@("WarehouseStaff")">Warehouse Staff</SelectItem>
                </Select>
            </div>
            <div>
                <label class="text-sm font-medium text-gray-700 mb-1 block">Status</label>
                <Select TValue="string" SelectedValue="@filterStatus" SelectedValueChanged="@OnStatusChanged" class="!bg-white !text-gray-900 !border-2 !border-gray-300">
                    <SelectItem Value="@("")">All Status</SelectItem>
                    <SelectItem Value="@("active")">Active</SelectItem>
                    <SelectItem Value="@("inactive")">Inactive</SelectItem>
                </Select>
            </div>
            <div class="flex items-end">
                <Button Color="Color.Light" Clicked="ClearFilters" class="w-full !border-2 !border-gray-400">
                    <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.Redo" class="mr-2" /> Clear Filters
                </Button>
            </div>
        </div>
    </CardBody>
</Card>

<!-- Customers Table -->
<Card class="!bg-white shadow-xl border border-gray-200 rounded-xl overflow-hidden">
    <CardBody Padding="Padding.Is0">
        <div class="overflow-x-auto">
            <Table class="mb-0 w-full">
                @* <TableHeader>
                    <TableRow class="bg-white border-b-2 border-gray-200">
                        <TableHeaderCell class="px-6 py-4 text-center text-gray-900 font-bold text-sm uppercase tracking-wider">ID</TableHeaderCell>
                        <TableHeaderCell class="px-6 py-4 text-center text-gray-900 font-bold text-sm uppercase tracking-wider">Customer</TableHeaderCell>
                        <TableHeaderCell class="px-6 py-4 text-center text-gray-900 font-bold text-sm uppercase tracking-wider">Email</TableHeaderCell>
                        <TableHeaderCell class="px-6 py-4 text-center text-gray-900 font-bold text-sm uppercase tracking-wider">Phone</TableHeaderCell>
                        <TableHeaderCell class="px-6 py-4 text-center text-gray-900 font-bold text-sm uppercase tracking-wider">Role</TableHeaderCell>
                        <TableHeaderCell class="px-6 py-4 text-center text-gray-900 font-bold text-sm uppercase tracking-wider">Orders</TableHeaderCell>
                        <TableHeaderCell class="px-6 py-4 text-center text-gray-900 font-bold text-sm uppercase tracking-wider">Status</TableHeaderCell>
                        <TableHeaderCell class="px-6 py-4 text-center text-gray-900 font-bold text-sm uppercase tracking-wider">Actions</TableHeaderCell>
                    </TableRow>
                </TableHeader> *@
                <TableHeader>
                    <TableRow class="!bg-gray-100 border-b border-gray-200">
                        <TableHeaderCell class="!bg-gray-100 !text-gray-700 px-6 py-4 text-center font-bold text-sm uppercase tracking-wider">ID</TableHeaderCell>
                        <TableHeaderCell class="!bg-gray-100 !text-gray-700 px-6 py-4 text-center font-bold text-sm uppercase tracking-wider">Customer</TableHeaderCell>
                        <TableHeaderCell class="!bg-gray-100 !text-gray-700 px-6 py-4 text-center font-bold text-sm uppercase tracking-wider">Email</TableHeaderCell>
                        <TableHeaderCell class="!bg-gray-100 !text-gray-700 px-6 py-4 text-center font-bold text-sm uppercase tracking-wider">Phone</TableHeaderCell>
                        <TableHeaderCell class="!bg-gray-100 !text-gray-700 px-6 py-4 text-center font-bold text-sm uppercase tracking-wider">Role</TableHeaderCell>
                        <TableHeaderCell class="!bg-gray-100 !text-gray-700 px-6 py-4 text-center font-bold text-sm uppercase tracking-wider">Orders</TableHeaderCell>
                        <TableHeaderCell class="!bg-gray-100 !text-gray-700 px-6 py-4 text-center font-bold text-sm uppercase tracking-wider">Status</TableHeaderCell>
                        <TableHeaderCell class="!bg-gray-100 !text-gray-700 px-6 py-4 text-center font-bold text-sm uppercase tracking-wider">Actions</TableHeaderCell>
                    </TableRow>
                </TableHeader>
                <TableBody class="bg-white divide-y divide-gray-200">
                    @if (customers != null && customers.Any())
                    {
                        @foreach (var customer in customers)
                        {
                            @* <TableRow class="bg-white hover:bg-gray-100 transition-colors duration-150"> *@
                            <TableRow class="!bg-white hover:!bg-blue-50 transition-colors duration-150 border-b border-gray-100">
                                <TableRowCell class="px-6 py-4 text-center">
                                    <span class="text-gray-600 font-medium">#@customer.CustomerId</span>
                                </TableRowCell>
                                <TableRowCell class="px-6 py-4 text-center">
                                    <div class="flex items-center justify-center gap-3">
                                        <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-white font-bold shadow-md">
                                            @(customer.Name?.Substring(0, 1).ToUpper() ?? "C")
                                        </div>
                                        <div class="text-left">
                                            <div class="font-bold text-gray-900">@customer.Name</div>
                                            <div class="text-gray-600 text-sm">Since @customer.CreatedAt.ToString("dd/MM/yyyy")</div>
                                        </div>
                                    </div>
                                </TableRowCell>
                                <TableRowCell class="px-6 py-4 text-center">
                                    <span class="text-gray-900">@customer.Email</span>
                                </TableRowCell>
                                <TableRowCell class="px-6 py-4 text-center">
                                    <span class="text-gray-900">@customer.Phone</span>
                                </TableRowCell>
                                <TableRowCell class="px-6 py-4 text-center">
                                    <span class="inline-flex items-center px-2 py-1 rounded text-xs font-semibold @(GetCustomerRole(customer.ApplicationUserId) == "Admin" ? "bg-purple-100 text-purple-800" : "bg-gray-100 text-gray-800")">
                                        @GetCustomerRole(customer.ApplicationUserId)
                                    </span>
                                </TableRowCell>
                                <TableRowCell class="px-6 py-4 text-center">
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-semibold bg-blue-100 text-blue-800">
                                        @customer.Orders.Count orders
                                    </span>
                                </TableRowCell>
                                <TableRowCell class="px-6 py-4 text-center">
                                    @if (customer.Status == "active")
                                    {
                                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-semibold bg-green-100 text-green-800">
                                            <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.Check" class="mr-1" /> Active
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-semibold bg-red-100 text-red-800">
                                            <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.Lock" class="mr-1" /> Locked
                                        </span>
                                    }
                                </TableRowCell>
                                <TableRowCell class="px-6 py-4 text-center">
                                    <Buttons class="gap-2 justify-end">
                                        <Button Color="Color.Primary" Size="Size.Small" Clicked="() => OpenEditModal(customer)" class="!bg-blue-600 !text-white hover:!bg-blue-700 shadow-sm" Title="Edit">
                                            <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.Edit" />
                                        </Button>
                                        @if (customer.Status == "active")
                                        {
                                            <Button Color="Color.Warning" Size="Size.Small" Clicked="() => ToggleLockCustomer(customer)" class="!bg-orange-600 !text-white hover:!bg-orange-700 shadow-sm" Title="Lock Account">
                                                <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.Lock" />
                                            </Button>
                                        }
                                        else
                                        {
                                            <Button Color="Color.Success" Size="Size.Small" Clicked="() => ToggleLockCustomer(customer)" class="!bg-green-600 !text-white hover:!bg-green-700 shadow-sm" Title="Unlock Account">
                                                <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.LockOpen" />
                                            </Button>
                                        }
                                        <Button Color="Color.Danger" Size="Size.Small" Clicked="() => DeleteCustomer(customer)" class="!bg-red-600 !text-white hover:!bg-red-700 shadow-sm" Title="Delete">
                                            <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.Trash" />
                                        </Button>
                                    </Buttons>
                                </TableRowCell>
                            </TableRow>
                        }
                    }
                    else
                    {
                        <TableRow class="bg-white">
                            <TableRowCell ColumnSpan="8" class="text-center py-12">
                                <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.Users" class="text-gray-400 text-4xl mb-3" />
                                <p class="text-gray-600 font-medium">No customers found</p>
                            </TableRowCell>
                        </TableRow>
                    }
                </TableBody>
            </Table>
        </div>
        
        <PaginationComponent CurrentPage="@currentPage" PageSize="@pageSize" TotalItems="@totalItems" OnPageChanged="@HandlePageChanged" />
    </CardBody>
</Card>

<!-- Toast Notification -->
@if (showToast)
{
    <div class="fixed bottom-6 right-6 z-50 animate-slide-up">
        <div class="@toastClass text-white px-6 py-4 rounded-xl shadow-2xl flex items-center gap-3 max-w-md">
            <div class="flex-shrink-0">
                <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center">
                    <i class="@toastIcon text-lg"></i>
                </div>
            </div>
            <div class="flex-1">
                <p class="font-semibold">@toastMessage</p>
            </div>
            <button @onclick="() => showToast = false"
                    class="flex-shrink-0 text-white/80 hover:text-white transition">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>
}

<!-- Custom Confirm Dialog -->
<Modal @ref="confirmModal">
    <ModalContent Centered Size="ModalSize.Default">
        <ModalHeader class="border-b">
            <ModalTitle class="!text-blue-600 !font-bold !text-xl">@confirmTitle</ModalTitle>
            <CloseButton Clicked="() => ConfirmResult(false)" />
        </ModalHeader>
        <ModalBody class="py-6 px-6">
            <p class="text-gray-600 text-sm leading-relaxed">@confirmMessage</p>
        </ModalBody>
        <ModalFooter class="border-t bg-gray-50 px-6 py-3">
            <div class="flex justify-end gap-3">
                <Button Color="Color.Danger" Clicked="() => ConfirmResult(false)" class="!bg-red-600 !text-white hover:!bg-red-700 px-6 font-medium">
                    No
                </Button>
                <Button Color="Color.Success" Clicked="() => ConfirmResult(true)" class="!bg-green-600 !text-white hover:!bg-green-700 px-6 font-medium">
                    Yes
                </Button>
            </div>
        </ModalFooter>
    </ModalContent>
</Modal>

<!-- Customer Modal -->
<Modal @ref="customerModal">
    <ModalContent Size="ModalSize.Large">
        <ModalHeader class="!bg-white border-b border-gray-200">
            <ModalTitle class="!text-blue-600 !font-bold !text-xl">@(isEditMode ? "Edit Customer" : "Add Customer")</ModalTitle>
            <CloseButton Clicked="CloseModal" />
        </ModalHeader>
        <ModalBody class="bg-white">
            @if (errorMessage != null)
            {
                <Alert Color="Color.Danger" Visible="true">
                    <AlertMessage>@errorMessage</AlertMessage>
                </Alert>
            }
            <div class="grid grid-cols-2 gap-4">
                <Field>
                    <FieldLabel class="!text-gray-900 !font-bold">Full Name *</FieldLabel>
                    <TextEdit @bind-Text="@customerForm.Name" Placeholder="Enter customer name" class="!bg-white !text-gray-900 !border-2 !border-gray-300" />
                    @if (validationErrors.ContainsKey("Name"))
                    {
                        <p class="text-red-600 text-sm mt-1 font-semibold">@validationErrors["Name"]</p>
                    }
                </Field>
                <Field>
                    <FieldLabel class="!text-gray-900 !font-bold">Email *</FieldLabel>
                    <TextEdit @bind-Text="@customerForm.Email" Role="TextRole.Email" Placeholder="Enter email" ReadOnly="@isEditMode" class="!bg-white !text-gray-900 !border-2 !border-gray-300" />
                    @if (validationErrors.ContainsKey("Email"))
                    {
                        <p class="text-red-600 text-sm mt-1 font-semibold">@validationErrors["Email"]</p>
                    }
                </Field>
            </div>
            @if (!isEditMode)
            {
                <Field class="mt-3">
                    <FieldLabel class="!text-gray-900 !font-bold">Password *</FieldLabel>
                    <TextEdit @bind-Text="@customerForm.Password" Role="TextRole.Password" Placeholder="Enter password (min 6 characters)" class="!bg-white !text-gray-900 !border-2 !border-gray-300" />
                    @if (validationErrors.ContainsKey("Password"))
                    {
                        <p class="text-red-600 text-sm mt-1 font-semibold">@validationErrors["Password"]</p>
                    }
                </Field>
            }
            <Field class="mt-3">
                <FieldLabel class="!text-gray-900 !font-bold">Phone *</FieldLabel>
                <TextEdit @bind-Text="@customerForm.Phone" Placeholder="Enter phone number" class="!bg-white !text-gray-900 !border-2 !border-gray-300" />
                @if (validationErrors.ContainsKey("Phone"))
                {
                    <p class="text-red-600 text-sm mt-1 font-semibold">@validationErrors["Phone"]</p>
                }
            </Field>
            <div class="grid grid-cols-2 gap-4 mt-3">
                <Field>
                    <FieldLabel class="!text-gray-900 !font-bold">Address</FieldLabel>
                    <TextEdit @bind-Text="@customerForm.Address" Placeholder="Enter address" class="!bg-white !text-gray-900 !border-2 !border-gray-300" />
                </Field>
                <Field>
                    <FieldLabel class="!text-gray-900 !font-bold">Status</FieldLabel>
                    <Select TValue="string" SelectedValue="@customerForm.Status" SelectedValueChanged="@((value) => customerForm.Status = value)" class="!bg-white !text-gray-900 !border-2 !border-gray-300">
                        <SelectItem Value="@("active")">Active</SelectItem>
                        <SelectItem Value="@("inactive")">Locked</SelectItem>
                    </Select>
                </Field>
            </div>
        </ModalBody>
        <ModalFooter class="bg-gray-50 border-t border-gray-200">
            <Button Color="Color.Secondary" Clicked="CloseModal" class="!bg-white !border-2 !border-gray-300 !text-gray-900 hover:!bg-gray-100 shadow-sm">Cancel</Button>
            <Button Color="Color.Primary" Clicked="SaveCustomer" Loading="@isSaving" class="!bg-blue-600 hover:!bg-blue-700 !text-white shadow-md">
                <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.Save" class="mr-2" /> Save
            </Button>
        </ModalFooter>
    </ModalContent>
</Modal>

<style>
    @@keyframes slide-up {
        from {
            transform: translateY(100%);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    .animate-slide-up {
        animation: slide-up 0.3s ease-out;
    }
</style>

@code {
    private List<Customer>? allCustomers;
    private List<Customer>? customers;
    private Dictionary<string, string> customerRoles = new();
    private Modal customerModal = null!;
    private Modal confirmModal = null!;
    private bool isEditMode = false;
    private bool isSaving = false;
    private string? errorMessage;
    private Dictionary<string, string> validationErrors = new();
    private CustomerFormModel customerForm = new();

    // Toast notification
    private bool showToast = false;
    private string toastMessage = "";
    private string toastClass = "";
    private string toastIcon = "";
    
    // Confirm dialog
    private TaskCompletionSource<bool>? confirmTcs;
    private string confirmTitle = "";
    private string confirmMessage = "";

    // Pagination
    private int currentPage = 1;
    private int pageSize = 10;
    private int totalItems = 0;

    // Filters
    private string searchTerm = string.Empty;
    private string filterRole = string.Empty;
    private string filterStatus = string.Empty;
    private List<Customer>? filteredCustomers;

    protected override async Task OnInitializedAsync()
    {
        await EnsureRolesExist();
        await LoadData();
    }

    private async Task EnsureRolesExist()
    {
        if (!await RoleManager.RoleExistsAsync("Admin"))
        {
            await RoleManager.CreateAsync(new IdentityRole("Admin"));
        }
        if (!await RoleManager.RoleExistsAsync("Customer"))
        {
            await RoleManager.CreateAsync(new IdentityRole("Customer"));
        }
    }

    private async Task LoadData()
    {
        allCustomers = await DbContext.Customers
            .Include(c => c.Orders)
            .Where(c => c.Status != "deleted")  // Exclude soft deleted
            .OrderByDescending(c => c.CreatedAt)
            .ToListAsync();

        // Load roles for all customers
        customerRoles.Clear();
        if (allCustomers != null)
        {
            foreach (var customer in allCustomers)
            {
                if (!string.IsNullOrEmpty(customer.ApplicationUserId))
                {
                    var user = await UserManager.FindByIdAsync(customer.ApplicationUserId);
                    if (user != null)
                    {
                        var roles = await UserManager.GetRolesAsync(user);
                        customerRoles[customer.ApplicationUserId] = roles.FirstOrDefault() ?? "Customer";
                    }
                }
            }
        }

        ApplyFilters();
    }

    private void ApplyFilters()
    {
        if (allCustomers == null)
        {
            filteredCustomers = new List<Customer>();
            totalItems = 0;
            customers = new List<Customer>();
            return;
        }

        filteredCustomers = allCustomers.Where(c =>
        {
            bool matchSearch = string.IsNullOrWhiteSpace(searchTerm) ||
                c.Name.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                (c.Email != null && c.Email.Contains(searchTerm, StringComparison.OrdinalIgnoreCase)) ||
                (c.Phone != null && c.Phone.Contains(searchTerm, StringComparison.OrdinalIgnoreCase));

            bool matchRole = string.IsNullOrEmpty(filterRole) ||
                GetCustomerRole(c.ApplicationUserId) == filterRole;

            bool matchStatus = string.IsNullOrEmpty(filterStatus) || c.Status == filterStatus;

            return matchSearch && matchRole && matchStatus;
        }).ToList();

        totalItems = filteredCustomers.Count;
        UpdatePagedData();
    }

    private void UpdatePagedData()
    {
        if (filteredCustomers != null)
        {
            customers = filteredCustomers
                .Skip((currentPage - 1) * pageSize)
                .Take(pageSize)
                .ToList();
        }
    }

    private void OnSearchChanged(string value)
    {
        searchTerm = value;
        currentPage = 1;
        ApplyFilters();
    }

    private void OnRoleChanged(string value)
    {
        filterRole = value;
        currentPage = 1;
        ApplyFilters();
    }

    private void OnStatusChanged(string value)
    {
        filterStatus = value;
        currentPage = 1;
        ApplyFilters();
    }

    private void ClearFilters()
    {
        searchTerm = string.Empty;
        filterRole = string.Empty;
        filterStatus = string.Empty;
        currentPage = 1;
        ApplyFilters();
    }

    private void HandlePageChanged(int page)
    {
        currentPage = page;
        UpdatePagedData();
        StateHasChanged();
    }

    private string GetCustomerRole(string? userId)
    {
        if (string.IsNullOrEmpty(userId)) return "Customer";
        return customerRoles.TryGetValue(userId, out var role) ? role : "Customer";
    }

    private void OpenAddModal()
    {
        isEditMode = false;
        customerForm = new CustomerFormModel { Role = "Customer", Status = "active" };
        errorMessage = null;
        validationErrors.Clear();
        customerModal.Show();
    }

    private void OpenEditModal(Customer customer)
    {
        isEditMode = true;
        customerForm = new CustomerFormModel
        {
            CustomerId = customer.CustomerId,
            Name = customer.Name,
            Email = customer.Email ?? "",
            Phone = customer.Phone ?? "",
            Address = customer.Address ?? "",
            Status = customer.Status,
            ApplicationUserId = customer.ApplicationUserId,
            Role = GetCustomerRole(customer.ApplicationUserId)
        };
        errorMessage = null;
        validationErrors.Clear();
        customerModal.Show();
    }

    private async Task SaveCustomer()
    {
        errorMessage = null;
        validationErrors.Clear();
        bool hasErrors = false;

        if (string.IsNullOrWhiteSpace(customerForm.Name))
        {
            validationErrors["Name"] = "Full name is required";
            hasErrors = true;
        }

        if (string.IsNullOrWhiteSpace(customerForm.Email))
        {
            validationErrors["Email"] = "Email is required";
            hasErrors = true;
        }
        else if (!System.Text.RegularExpressions.Regex.IsMatch(customerForm.Email, @"^[^@\s]+@[^@\s]+\.[^@\s]+$"))
        {
            validationErrors["Email"] = "Email format is invalid";
            hasErrors = true;
        }

        if (string.IsNullOrWhiteSpace(customerForm.Phone))
        {
            validationErrors["Phone"] = "Phone number is required";
            hasErrors = true;
        }
        else if (!System.Text.RegularExpressions.Regex.IsMatch(customerForm.Phone, @"^[0-9]{10,11}$"))
        {
            validationErrors["Phone"] = "Phone must be 10-11 digits";
            hasErrors = true;
        }

        if (!isEditMode && string.IsNullOrWhiteSpace(customerForm.Password))
        {
            validationErrors["Password"] = "Password is required";
            hasErrors = true;
        }

        if (hasErrors)
        {
            return;
        }

        isSaving = true;

        try
        {
            if (isEditMode)
            {
                var customer = await DbContext.Customers.FindAsync(customerForm.CustomerId);
                if (customer != null)
                {
                    customer.Name = customerForm.Name;
                    customer.Email = customerForm.Email;
                    customer.Phone = customerForm.Phone;
                    customer.Address = customerForm.Address;
                    customer.Status = customerForm.Status;

                    // Update role if user exists
                    if (!string.IsNullOrEmpty(customer.ApplicationUserId))
                    {
                        var user = await UserManager.FindByIdAsync(customer.ApplicationUserId);
                        if (user != null)
                        {
                            var currentRoles = await UserManager.GetRolesAsync(user);
                            if (currentRoles.Any())
                            {
                                await UserManager.RemoveFromRolesAsync(user, currentRoles);
                            }
                            var addRoleResult = await UserManager.AddToRoleAsync(user, customerForm.Role);
                            if (!addRoleResult.Succeeded)
                            {
                                errorMessage = "Failed to update role: " + string.Join(", ", addRoleResult.Errors.Select(e => e.Description));
                                isSaving = false;
                                return;
                            }
                            // Update cache
                            customerRoles[customer.ApplicationUserId] = customerForm.Role;
                        }
                    }

                    await DbContext.SaveChangesAsync();
                }
            }
            else
            {
                // Create Identity user first
                var user = new ApplicationUser
                {
                    UserName = customerForm.Email,
                    Email = customerForm.Email,
                    EmailConfirmed = true
                };

                var result = await UserManager.CreateAsync(user, customerForm.Password);
                if (result.Succeeded)
                {
                    await UserManager.AddToRoleAsync(user, "Customer");

                    // Create customer record
                    var customer = new Customer
                    {
                        Name = customerForm.Name,
                        Email = customerForm.Email,
                        Phone = customerForm.Phone,
                        Address = customerForm.Address,
                        Status = customerForm.Status,
                        ApplicationUserId = user.Id,
                        CreatedAt = DateTime.Now
                    };

                    DbContext.Customers.Add(customer);
                    await DbContext.SaveChangesAsync();
                }
                else
                {
                    errorMessage = string.Join(", ", result.Errors.Select(e => e.Description));
                    isSaving = false;
                    return;
                }
            }

            await LoadData();
            customerModal.Hide();

            ShowToast(
                isEditMode ? "Customer updated successfully!" : "Customer created successfully!",
                "bg-green-600",
                "fas fa-check"
            );
        }
        catch (Exception ex)
        {
            errorMessage = $"Error saving customer: {ex.Message}";
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task ToggleLockCustomer(Customer customer)
    {
        var newStatus = customer.Status == "active" ? "inactive" : "active";
        var action = newStatus == "inactive" ? "lock" : "unlock";
        
        var confirmed = await ShowConfirmDialog(
            $"Are you sure you want to {action} this account?",
            $"This will {action} the account for {customer.Name}. The user will {(newStatus == "inactive" ? "not be able to log in" : "be able to log in again")}. Do you want to proceed?"
        );
        if (!confirmed) return;

        customer.Status = newStatus;
        
        // Also lock/unlock the Identity user
        if (!string.IsNullOrEmpty(customer.ApplicationUserId))
        {
            var user = await UserManager.FindByIdAsync(customer.ApplicationUserId);
            if (user != null)
            {
                if (newStatus == "inactive")
                {
                    await UserManager.SetLockoutEndDateAsync(user, DateTimeOffset.MaxValue);
                }
                else
                {
                    await UserManager.SetLockoutEndDateAsync(user, null);
                }
            }
        }

        await DbContext.SaveChangesAsync();
        await LoadData();
    }

    private async Task DeleteCustomer(Customer customer)
    {
        var confirmed = await ShowConfirmDialog(
            "Delete Customer",
            $"Are you sure you want to delete {customer.Name}? This customer will be marked as deleted."
        );
        if (!confirmed) return;

        try
        {
            // Soft delete: change status to "deleted"
            customer.Status = "deleted";
            await DbContext.SaveChangesAsync();
            await LoadData();

            ShowToast($"Customer {customer.Name} has been deleted successfully", "bg-green-600", "fas fa-check");
        }
        catch (Exception ex)
        {
            ShowToast($"Error deleting customer: {ex.Message}", "bg-red-600", "fas fa-times");
        }
    }

    private void CloseModal()
    {
        customerModal.Hide();
        errorMessage = null;
        validationErrors.Clear();
    }

    private async Task<bool> ShowConfirmDialog(string title, string message)
    {
        confirmTitle = title;
        confirmMessage = message;
        confirmTcs = new TaskCompletionSource<bool>();
        await confirmModal.Show();
        return await confirmTcs.Task;
    }

    private async Task ConfirmResult(bool result)
    {
        confirmTcs?.SetResult(result);
        await confirmModal.Hide();
    }

    private class CustomerFormModel
    {
        public int CustomerId { get; set; }
        public string Name { get; set; } = "";
        public string Email { get; set; } = "";
        public string Password { get; set; } = "";
        public string Phone { get; set; } = "";
        public string Address { get; set; } = "";
        public string Role { get; set; } = "Customer";
        public string Status { get; set; } = "active";
        public string? ApplicationUserId { get; set; }
    }

    private void ShowToast(string message, string cssClass, string icon)
    {
        toastMessage = message;
        toastClass = cssClass;
        toastIcon = icon;
        showToast = true;

        Task.Delay(3000).ContinueWith(_ =>
        {
            showToast = false;
            InvokeAsync(StateHasChanged);
        });
    }
}
