@page "/admin/dashboard"
@rendermode InteractiveServer
@attribute [Authorize(Roles = "Admin, SalesStaff, WarehouseStaff")]

@using StoreManagementAPI.Services
@using StoreManagementAPI.DTOs
@using StoreManagementAPI.Data
@using StoreManagementAPI.Models
@using Microsoft.EntityFrameworkCore
@using Blazorise

@inject IStatisticsService StatisticsService
@inject StoreDbContext DbContext
@inject NavigationManager NavigationManager

<PageTitle>Admin Dashboard - E-Store</PageTitle>

<div class="dashboard-container">
    <!-- Header with Refresh -->
    <div class="flex justify-between items-center mb-6">
        <div>
            <h3 class="text-2xl font-bold text-gray-900 mb-1">Dashboard Overview</h3>
            <p class="text-gray-600 mb-0">Welcome back! Here's what's happening with your store.</p>
        </div>
        <div class="flex gap-3">
            <Button Color="Color.Light" Clicked="ToggleFiltersModal" Class="!bg-white !text-gray-900 !border-gray-300 hover:!bg-gray-50 shadow-md">
                <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.SlidersH" class="mr-2 text-gray-700" /> Filters
            </Button>
            <Button Color="Color.Primary" Clicked="RefreshData" Loading="@isLoading" Class="!bg-blue-600 !text-white hover:!bg-blue-700 shadow-md">
                <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.SyncAlt" class="mr-2" /> Refresh
            </Button>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="flex items-center justify-center py-20">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
        </div>
    }
    else if (statistics != null)
    {
        <!-- Main Stats Cards Row -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            <!-- Balance/Revenue Card -->
            <div class="lg:col-span-2">
                <Card class="h-full shadow-xl border border-gray-200 !bg-white">
                    <CardBody class="p-6">
                        <div class="flex justify-between items-start mb-6">
                            <div>
                                <p class="text-sm text-gray-600 mb-1 font-medium">Total Revenue</p>
                                <h2 class="text-4xl font-bold text-gray-900 mb-2">
                                    $@statistics.MonthRevenue.ToString("N2")
                                </h2>
                                <div class="flex items-center gap-3">
                                    @{
                                        var trendPercent = statistics.TodayRevenue > 0 ? 
                                            Math.Round((statistics.TodayRevenue / (statistics.MonthRevenue / 30)) * 100 - 100, 1) : 0;
                                        var isPositive = trendPercent >= 0;
                                    }
                                    <span class="@(isPositive ? "bg-green-100 text-green-700" : "bg-red-100 text-red-700") px-3 py-1 rounded-full text-sm font-bold">
                                        <Icon Name="@(isPositive ? Blazorise.Icons.FontAwesome.FontAwesomeIcons.ArrowUp : Blazorise.Icons.FontAwesome.FontAwesomeIcons.ArrowDown)" class="mr-1" />
                                        @Math.Abs(trendPercent)%
                                    </span>
                                    <span class="text-gray-600 text-sm font-medium">vs daily average</span>
                                </div>
                            </div>
                            <Button Color="Color.Light" Size="Size.Small" Class="!bg-gray-100 !text-gray-900 hover:!bg-gray-200 !border-gray-300 shadow-sm" Clicked="@(() => NavigationManager.NavigateTo("/admin/orders"))">
                                View Details
                            </Button>
                        </div>

                        <!-- Revenue Chart (Bar Chart Representation) -->
                        <div class="revenue-chart mt-4">
                            <div class="flex justify-between gap-2 h-48">
                                @if (statistics.RevenueByDate != null && statistics.RevenueByDate.Any())
                                {
                                    var maxRevenue = statistics.RevenueByDate.Max(r => r.Revenue);
                                    var recentData = statistics.RevenueByDate.TakeLast(12).ToList();
                                    
                                    @foreach (var item in recentData)
                                    {
                                        var heightPercent = maxRevenue > 0 ? (double)(item.Revenue / maxRevenue) * 100 : 0;
                                        var isHighest = item.Revenue == maxRevenue;
                                        
                                        <div class="flex-1 flex flex-col items-center gap-2 justify-end group">
                                            <div class="relative w-full flex justify-center items-end" style="height: 170px;">
                                                <div class="opacity-0 group-hover:opacity-100 transition-opacity absolute left-1/2 -translate-x-1/2 bg-gray-900 text-white text-xs px-2 py-1 rounded whitespace-nowrap shadow-md z-10"
                                                     style="bottom: @(heightPercent.ToString("F2", System.Globalization.CultureInfo.InvariantCulture))%; margin-bottom: 4px;">
                                                    $@item.Revenue.ToString("N0")
                                                </div>
                                                <div class="w-8 rounded-t-md transition-all cursor-pointer @(isHighest ? "bg-blue-600" : "bg-blue-400 hover:bg-blue-500")"
                                                     style="height: @(heightPercent.ToString("F2", System.Globalization.CultureInfo.InvariantCulture))%">
                                                </div>
                                            </div>
                                            <span class="text-xs text-gray-600 font-medium">@DateTime.Parse(item.Date).ToString("dd/MM/yyyy")</span>
                                        </div>
                                    }
                                }
                                else
                                {
                                    <div class="w-full text-center text-gray-500">No revenue data available</div>
                                }
                            </div>
                        </div>
                    </CardBody>
                </Card>
            </div>

            <!-- Cashflow Card -->
            <div>
                <Card class="h-full shadow-xl border border-gray-200 !bg-white">
                    <CardBody class="p-6">
                        <div class="flex justify-between items-start mb-4">
                            <p class="text-sm text-gray-600 mb-0 font-medium">Cashflow</p>
                            <a href="/admin/orders" class="text-blue-600 text-sm hover:underline font-bold">View more</a>
                        </div>
                        
                        <h3 class="text-3xl font-bold text-gray-900 mb-6">
                            $@statistics.MonthRevenue.ToString("N2")
                        </h3>

                        <!-- Circular Progress -->
                        <div class="flex justify-center mb-6">
                            <div class="relative w-32 h-32">
                                @{
                                    var profitPercent = statistics.MonthRevenue > 0 
                                        ? (int)Math.Round((statistics.MonthProfit / statistics.MonthRevenue) * 100) 
                                        : 0;
                                    var expensePercent = 100 - profitPercent;
                                    var circumference = 352;
                                    var profitOffset = circumference - (circumference * profitPercent / 100);
                                }
                                <svg class="w-full h-full transform -rotate-90">
                                    <circle cx="64" cy="64" r="56" stroke="#e5e7eb" stroke-width="12" fill="none" />
                                    <!-- Profit Circle (Green) -->
                                    <circle cx="64" cy="64" r="56" stroke="#22c55e" stroke-width="12" fill="none"
                                            stroke-dasharray="@circumference" stroke-dashoffset="@profitOffset" stroke-linecap="round" />
                                </svg>
                                <div class="absolute inset-0 flex items-center justify-center">
                                    <span class="text-2xl font-bold text-gray-900">@profitPercent%</span>
                                </div>
                            </div>
                        </div>

                        <!-- Stats -->
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <div class="flex items-center gap-2">
                                    <div class="w-3 h-3 rounded-full bg-green-500"></div>
                                    <span class="text-sm text-gray-900 font-bold">Income</span>
                                </div>
                                <div class="text-right">
                                    <span class="font-bold text-gray-900">$@statistics.MonthRevenue.ToString("N2")</span>
                                    <span class="@(statistics.IncomeGrowth >= 0 ? "text-green-600" : "text-red-600") text-xs ml-2 font-bold">
                                        @(statistics.IncomeGrowth >= 0 ? "↑" : "↓") @Math.Abs(statistics.IncomeGrowth)%
                                    </span>
                                </div>
                            </div>
                            <div class="flex justify-between items-center">
                                <div class="flex items-center gap-2">
                                    <div class="w-3 h-3 rounded-full bg-orange-500"></div>
                                    <span class="text-sm text-gray-900 font-bold">Expenses</span>
                                </div>
                                <div class="text-right">
                                    <span class="font-bold text-gray-900">$@statistics.MonthExpenses.ToString("N2")</span>
                                    <span class="@(statistics.ExpenseGrowth >= 0 ? "text-orange-600" : "text-green-600") text-xs ml-2 font-bold">
                                        @(statistics.ExpenseGrowth >= 0 ? "↑" : "↓") @Math.Abs(statistics.ExpenseGrowth)%
                                    </span>
                                </div>
                            </div>
                        </div>
                    </CardBody>
                </Card>
            </div>
        </div>

        <!-- Second Row: Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
            <!-- Today's Orders -->
            <Card class="shadow-xl border border-gray-200 hover:shadow-2xl transition-shadow !bg-white">
                <CardBody class="p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600 mb-1 font-bold">Today's Orders</p>
                            <h3 class="text-3xl font-bold text-gray-900 mb-0">@statistics.TodayOrders</h3>
                        </div>
                        <div class="w-12 h-12 bg-blue-500 rounded-2xl flex items-center justify-center shadow-lg">
                            <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.ShoppingCart" class="text-white text-lg" />
                        </div>
                    </div>
                    <div class="mt-4">
                        <Progress Value="@GetProgressValue(statistics.TodayOrders, statistics.MonthOrders)" Color="Color.Primary" class="h-2 rounded-full" />
                    </div>
                </CardBody>
            </Card>

            <!-- Month Orders -->
            <Card class="shadow-xl border border-gray-200 hover:shadow-2xl transition-shadow !bg-white">
                <CardBody class="p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600 mb-1 font-bold">Month Orders</p>
                            <h3 class="text-3xl font-bold text-gray-900 mb-0">@statistics.MonthOrders</h3>
                        </div>
                        <div class="w-12 h-12 bg-green-500 rounded-2xl flex items-center justify-center shadow-lg">
                            <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.FileAlt" class="text-white text-lg" />
                        </div>
                    </div>
                    <div class="mt-4">
                        <Progress Value="75" Color="Color.Success" class="h-2 rounded-full" />
                    </div>
                </CardBody>
            </Card>

            <!-- Active Customers -->
            <Card class="shadow-xl border border-gray-200 hover:shadow-2xl transition-shadow !bg-white">
                <CardBody class="p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600 mb-1 font-bold">Active Customers</p>
                            <h3 class="text-3xl font-bold text-gray-900 mb-0">@statistics.ActiveCustomers</h3>
                        </div>
                        <div class="w-12 h-12 bg-purple-500 rounded-2xl flex items-center justify-center shadow-lg">
                            <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.Users" class="text-white text-lg" />
                        </div>
                    </div>
                    <div class="mt-4">
                        <Progress Value="@GetProgressValue(statistics.ActiveCustomers, statistics.TotalCustomers)" Color="Color.Info" class="h-2 rounded-full" />
                    </div>
                </CardBody>
            </Card>

            <!-- Low Stock Alert -->
            <Card class="shadow-xl border border-gray-200 hover:shadow-2xl transition-shadow !bg-white">
                <CardBody class="p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600 mb-1 font-bold">Low Stock Items</p>
                            <h3 class="text-3xl font-bold text-gray-900 mb-0">@statistics.LowStockProducts</h3>
                        </div>
                        <div class="w-12 h-12 bg-red-500 rounded-2xl flex items-center justify-center shadow-lg">
                            <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.ExclamationTriangle" class="text-white text-lg" />
                        </div>
                    </div>
                    <div class="mt-4">
                        <Progress Value="@GetProgressValue(statistics.LowStockProducts, statistics.TotalProducts)" Color="Color.Danger" class="h-2 rounded-full" />
                    </div>
                </CardBody>
            </Card>
        </div>

        <!-- Order Status Distribution Chart -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <Card class="shadow-xl border border-gray-200 !bg-white rounded-2xl overflow-hidden">
                <div class="bg-gradient-to-r from-blue-50 to-purple-50 border-b border-gray-200 p-6">
                    <h5 class="text-xl font-bold text-gray-900 mb-0">Order Status Distribution</h5>
                </div>
                <CardBody class="p-6 bg-white flex justify-center items-center">
                    <div class="flex flex-col items-center w-full">
                        <div class="relative w-64 h-64">
                            @{
                                var statusCounts = statistics.OrdersByStatus
                                    .OrderByDescending(x => x.Count)
                                    .ToList();
                                
                                var totalOrders = statusCounts?.Sum(x => x.Count) ?? 0;
                                double currentAngle = 0;
                                var colors = new Dictionary<string, string>
                                {
                                    { "pending", "#eab308" }, // Yellow
                                    { "completed", "#3b82f6" }, // Blue
                                    { "paid", "#3b82f6" }, // Blue
                                    { "cancelled", "#ef4444" }, // Red
                                    { "canceled", "#ef4444" }, // Red (alt)
                                    { "processing", "#06b6d4" } // Cyan
                                };
                            }

                            <svg viewBox="0 0 100 100" class="w-full h-full transform -rotate-90">
                                @if (totalOrders > 0 && statusCounts != null)
                                {
                                    foreach (var item in statusCounts)
                                    {
                                        var percent = (double)item.Count / totalOrders;
                                        var dashArray = (percent * 100).ToString("F4", System.Globalization.CultureInfo.InvariantCulture);
                                        var offset = (-currentAngle).ToString("F4", System.Globalization.CultureInfo.InvariantCulture);
                                        
                                        <circle r="15.9155" cx="50" cy="50" fill="transparent"
                                                stroke="@(colors.ContainsKey(item.Status.ToLower()) ? colors[item.Status.ToLower()] : "#9ca3af")"
                                                stroke-width="32"
                                                stroke-dasharray="@dashArray 100"
                                                stroke-dashoffset="@offset" />
                                        
                                        currentAngle += percent * 100;
                                    }
                                }
                                else
                                {
                                    <circle r="15.9155" cx="50" cy="50" fill="transparent" stroke="#e5e7eb" stroke-width="32" />
                                }
                            </svg>
                        </div>

                        <!-- Legend -->
                        <div class="flex flex-wrap justify-center gap-4 mt-6">
                            @if (statusCounts != null)
                            {
                                foreach (var item in statusCounts)
                                {
                                     <div class="flex items-center gap-2">
                                         <div class="w-3 h-3 rounded-full" style="background-color: @(colors.ContainsKey(item.Status.ToLower()) ? colors[item.Status.ToLower()] : "#9ca3af")"></div>
                                         <span class="text-sm text-gray-600 capitalize font-medium">@item.Status: @item.Count</span>
                                     </div>
                                }
                            }
                        </div>
                    </div>
                </CardBody>
            </Card>

            <Card class="shadow-xl border border-gray-200 !bg-white rounded-2xl overflow-hidden">
                <div class="bg-gradient-to-r from-blue-50 to-purple-50 border-b border-gray-200 p-6">
                    <h5 class="text-xl font-bold text-gray-900 mb-0">Status Details</h5>
                </div>
                <CardBody class="p-0 bg-white">
                    <Table Hoverable class="mb-0">
                        <TableHeader>
                            <TableRow class="bg-gray-50">
                                <TableHeaderCell class="text-gray-700 font-bold">Status</TableHeaderCell>
                                <TableHeaderCell class="text-center text-gray-700 font-bold">Count</TableHeaderCell>
                                <TableHeaderCell class="text-right text-gray-700 font-bold">Total Amount</TableHeaderCell>
                            </TableRow>
                        </TableHeader>
                        <TableBody>
                            @{
                                var statusDetails = statistics.OrdersByStatus
                                    .OrderByDescending(x => x.Count)
                                    .ToList();

                                if (statusDetails != null && statusDetails.Any())
                                {
                                    foreach (var item in statusDetails)
                                    {
                                        var colorClass = item.Status.ToLower() switch
                                        {
                                            "pending" => "text-yellow-600 bg-yellow-50 border-yellow-200",
                                            "completed" or "paid" => "text-blue-600 bg-blue-50 border-blue-200",
                                            "cancelled" or "canceled" => "text-red-600 bg-red-50 border-red-200",
                                            "processing" => "text-cyan-600 bg-cyan-50 border-cyan-200",
                                            _ => "text-gray-600 bg-gray-50 border-gray-200"
                                        };

                                        <TableRow>
                                            <TableRowCell>
                                                <span class="px-3 py-1 rounded-full text-xs font-bold border @colorClass uppercase">
                                                    @item.Status
                                                </span>
                                            </TableRowCell>
                                            <TableRowCell class="text-center font-bold text-gray-900">@item.Count</TableRowCell>
                                            <TableRowCell class="text-right font-bold text-gray-900">$@item.TotalAmount.ToString("N2")</TableRowCell>
                                        </TableRow>
                                    }
                                }
                                else
                                {
                                    <TableRow>
                                        <TableRowCell ColumnSpan="3" class="text-center py-8 text-gray-500">No data available</TableRowCell>
                                    </TableRow>
                                }
                            }
                        </TableBody>
                    </Table>
                </CardBody>
            </Card>
        </div>

        <!-- Third Row: Chart and Top Products -->
        <div class="mb-6">
            <!-- Top Selling Products -->
            <div>
                <Card class="shadow-xl border border-gray-200 h-full !bg-white rounded-2xl overflow-hidden">
                    <div class="bg-gradient-to-r from-blue-50 to-purple-50 border-b border-gray-200 p-6 pb-4">
                        <div class="flex justify-between items-center">
                            <h5 class="text-xl font-bold text-gray-900 mb-0">Top Products</h5>
                            <a href="/admin/products" class="text-blue-600 text-sm hover:text-blue-700 hover:underline font-bold transition-colors">View all →</a>
                        </div>
                    </div>
                    <CardBody class="p-6 bg-white">
                        <div class="space-y-4">
                            @if (statistics.TopSellingProducts != null && statistics.TopSellingProducts.Any())
                            {
                                <Table Hoverable class="mb-0">
                                    <TableHeader>
                                        <TableRow class="bg-gray-50">
                                            <TableHeaderCell class="text-gray-700 font-bold">ID</TableHeaderCell>
                                            <TableHeaderCell class="text-gray-700 font-bold">Product</TableHeaderCell>
                                            <TableHeaderCell class="text-gray-700 font-bold">Category</TableHeaderCell>
                                            <TableHeaderCell class="text-center text-gray-700 font-bold">Sold</TableHeaderCell>
                                            <TableHeaderCell class="text-right text-gray-700 font-bold">Revenue</TableHeaderCell>
                                        </TableRow>
                                    </TableHeader>
                                    <TableBody>
                                        @foreach (var product in statistics.TopSellingProducts.Take(5))
                                        {
                                            <TableRow class="hover:bg-gray-50 cursor-pointer" @onclick="@(() => NavigationManager.NavigateTo($"/admin/products"))">
                                                <TableRowCell>
                                                    <span class="text-gray-600 text-sm font-bold">#@product.ProductId</span>
                                                </TableRowCell>
                                                <TableRowCell>
                                                    <div class="flex items-center gap-3">
                                                        <div class="w-10 h-10 bg-gray-100 rounded-lg flex items-center justify-center flex-shrink-0 overflow-hidden">
                                                            @if (!string.IsNullOrEmpty(product.ImageUrl))
                                                            {
                                                                <img src="@product.ImageUrl" class="w-full h-full object-cover" alt="@product.ProductName" />
                                                            }
                                                            else
                                                            {
                                                                <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.BoxOpen" class="text-gray-400" />
                                                            }
                                                        </div>
                                                        <span class="font-bold text-gray-900 text-sm">@product.ProductName</span>
                                                    </div>
                                                </TableRowCell>
                                                <TableRowCell>
                                                    <span class="px-2 py-1 rounded-full bg-blue-50 text-blue-700 text-xs font-bold border border-blue-100">
                                                        @product.CategoryName
                                                    </span>
                                                </TableRowCell>
                                                <TableRowCell class="text-center">
                                                    <span class="text-gray-900 font-bold text-sm">@product.TotalQuantitySold</span>
                                                </TableRowCell>
                                                <TableRowCell class="text-right">
                                                    <span class="text-gray-900 font-bold text-sm">$@product.TotalRevenue.ToString("N0")</span>
                                                </TableRowCell>
                                            </TableRow>
                                        }
                                    </TableBody>
                                </Table>
                            }
                            else
                            {
                                <div class="text-center py-8">
                                    <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.BoxOpen" class="text-4xl text-gray-300 mb-3" />
                                    <p class="text-gray-500">No products data</p>
                                </div>
                            }
                        </div>
                    </CardBody>
                </Card>
            </div>
        </div>

        <!-- Filters Modal -->
        @if (showFiltersModal)
        {
            <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" @onclick="ToggleFiltersModal">
                <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-md w-full mx-4" @onclick:stopPropagation>
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-900">Filters</h3>
                        <button @onclick="ToggleFiltersModal" class="text-gray-500 hover:text-gray-700">
                            <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.Times" class="text-xl" />
                        </button>
                    </div>
                    
                    <div class="space-y-4">
                        <div class="bg-blue-50 p-3 rounded-lg mb-4">
                            <p class="text-sm text-blue-800 font-medium mb-0">
                                <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.InfoCircle" class="mr-1" />
                                Thống kê hiển thị cho 7 ngày gần nhất.
                            </p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-bold text-gray-900 mb-2">Status</label>
                            <div class="space-y-2">
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="checkbox" @onchange="@(e => UpdateStatusFilter("completed", e.Value))" checked="@(selectedStatuses.Contains("completed"))" class="w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-500" />
                                    <span class="text-sm text-gray-900">Completed</span>
                                </label>
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="checkbox" @onchange="@(e => UpdateStatusFilter("pending", e.Value))" checked="@(selectedStatuses.Contains("pending"))" class="w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-500" />
                                    <span class="text-sm text-gray-900">Pending</span>
                                </label>
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="checkbox" @onchange="@(e => UpdateStatusFilter("cancelled", e.Value))" checked="@(selectedStatuses.Contains("cancelled"))" class="w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-500" />
                                    <span class="text-sm text-gray-900">Cancelled</span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="flex gap-3 pt-4">
                            <Button Color="Color.Light" Clicked="ToggleFiltersModal" Class="flex-1 !bg-gray-100 !text-gray-900 hover:!bg-gray-200 rounded-lg">
                                Cancel
                            </Button>
                            <Button Color="Color.Primary" Clicked="ApplyFilters" Class="flex-1 !bg-blue-600 !text-white hover:!bg-blue-700 rounded-lg">
                                Apply Filters
                            </Button>
                        </div>
                    </div>
                </div>
            </div>
        }

        <!-- Fourth Row: Recent Transactions -->
        <Card class="shadow-xl border border-gray-200 !bg-white rounded-2xl overflow-hidden">
            <div class="bg-gradient-to-r from-blue-50 to-purple-50 border-b border-gray-200 p-6">
                <div class="flex justify-between items-center">
                    <h5 class="text-xl font-bold text-gray-900 mb-0">Recent Transactions</h5>
                    <div class="flex gap-3">
                        <Button Color="Color.Primary" Size="Size.Small" To="/admin/orders" Type="ButtonType.Link" Class="!bg-blue-600 !text-white hover:!bg-blue-700 rounded-lg shadow-md px-4">
                            View All Orders <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.ArrowRight" class="ml-2" />
                        </Button>
                        <Button Color="Color.Success" Size="Size.Small" To="/admin/purchase-orders" Type="ButtonType.Link" Class="!bg-green-600 !text-white hover:!bg-green-700 rounded-lg shadow-md px-4">
                            View Purchase Orders <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.ArrowRight" class="ml-2" />
                        </Button>
                    </div>
                </div>
            </div>
            <CardBody Padding="Padding.Is0" class="overflow-hidden">
                <div class="overflow-x-auto">
                    <Table Hoverable class="mb-0">
                        <TableHeader>
                            <TableRow class="bg-white border-b-2 border-gray-200">
                                <TableHeaderCell class="px-6 py-4 text-left text-gray-900 font-bold text-sm uppercase tracking-wide">Date</TableHeaderCell>
                                <TableHeaderCell class="px-6 py-4 text-center text-gray-900 font-bold text-sm uppercase tracking-wide">Type</TableHeaderCell>
                                <TableHeaderCell class="px-6 py-4 text-left text-gray-900 font-bold text-sm uppercase tracking-wide">Partner</TableHeaderCell>
                                <TableHeaderCell class="px-6 py-4 text-left text-gray-900 font-bold text-sm uppercase tracking-wide">Reference</TableHeaderCell>
                                <TableHeaderCell class="px-6 py-4 text-right text-gray-900 font-bold text-sm uppercase tracking-wide">Amount</TableHeaderCell>
                                <TableHeaderCell class="px-6 py-4 text-center text-gray-900 font-bold text-sm uppercase tracking-wide">Status</TableHeaderCell>
                            </TableRow>
                        </TableHeader>
                        <TableBody class="bg-white divide-y divide-gray-200">
                            @if (recentTransactions != null && recentTransactions.Any())
                            {
                                @foreach (var transaction in recentTransactions)
                                {
                                    <TableRow class="bg-white hover:bg-gradient-to-r hover:from-blue-50 hover:to-purple-50 transition-all">
                                        <TableRowCell class="px-6 py-4">
                                            <div>
                                                <span class="text-gray-900 font-bold text-sm">@transaction.Date.ToString("dd/MM/yyyy")</span>
                                                <span class="text-gray-600 text-xs block mt-0.5 font-medium">@transaction.Date.ToString("HH:mm")</span>
                                            </div>
                                        </TableRowCell>
                                        <TableRowCell class="px-6 py-4 text-center">
                                            @if (transaction.Type == "Sale")
                                            {
                                                <Badge Color="Color.Success" class="px-3 py-1.5 rounded-full">Bán hàng</Badge>
                                            }
                                            else
                                            {
                                                <Badge Color="Color.Warning" class="px-3 py-1.5 rounded-full">Nhập kho</Badge>
                                            }
                                        </TableRowCell>
                                        <TableRowCell class="px-6 py-4">
                                            <div class="flex items-center gap-3">
                                                <div class="w-9 h-9 bg-gradient-to-br @(transaction.Type == "Sale" ? "from-blue-500 to-purple-600" : "from-orange-500 to-red-600") rounded-full flex items-center justify-center text-white text-sm font-bold shadow-md">
                                                    @(transaction.PartnerName?.Substring(0, 1).ToUpper() ?? "?")
                                                </div>
                                                <span class="text-gray-900 font-bold text-sm">@(transaction.PartnerName ?? "Unknown")</span>
                                            </div>
                                        </TableRowCell>
                                        <TableRowCell class="px-6 py-4">
                                            <span class="text-gray-900 font-bold text-sm">@transaction.ReferenceCode</span>
                                        </TableRowCell>
                                        <TableRowCell class="px-6 py-4 text-right">
                                            @if (transaction.Type == "Sale")
                                            {
                                                <span class="font-bold text-green-600 text-sm">+$@transaction.Amount.ToString("N2")</span>
                                            }
                                            else
                                            {
                                                <span class="font-bold text-red-600 text-sm">-$@transaction.Amount.ToString("N2")</span>
                                            }
                                        </TableRowCell>
                                        <TableRowCell class="px-6 py-4 text-center">
                                            <Badge Color="@GetStatusColor(transaction.Status)" class="px-3 py-1.5 rounded-full">
                                                <span class="flex items-center gap-1.5 justify-center">
                                                    <span class="w-2 h-2 rounded-full @GetStatusDotClass(transaction.Status)"></span>
                                                    <span class="font-bold text-xs">@transaction.Status</span>
                                                </span>
                                            </Badge>
                                        </TableRowCell>
                                    </TableRow>
                                }
                            }
                            else
                            {
                                <TableRow class="bg-white">
                                    <TableRowCell ColumnSpan="6" class="text-center py-12">
                                        <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.Inbox" class="text-4xl text-gray-300 mb-3" />
                                        <p class="text-gray-600 font-medium">No transactions found</p>
                                    </TableRowCell>
                                </TableRow>
                            }
                        </TableBody>
                    </Table>
                </div>
            </CardBody>
        </Card>
    }
</div>

@code {
    private DashboardStatisticsDto? statistics;
    private List<TransactionDto>? recentTransactions;
    private bool isLoading = true;
    private bool showFiltersModal = false;
    private int selectedDays = 7;
    private List<string> selectedStatuses = new List<string> { "completed", "pending" };

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        isLoading = true;
        
        try
        {
            statistics = await StatisticsService.GetDashboardStatisticsAsync(selectedDays, selectedStatuses);
            recentTransactions = await StatisticsService.GetRecentTransactionsAsync(10);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading dashboard data: {ex.Message}");
        }
        
        isLoading = false;
    }

    private async Task RefreshData()
    {
        await LoadData();
    }

    private void ToggleFiltersModal()
    {
        showFiltersModal = !showFiltersModal;
    }

    private async Task ApplyFilters()
    {
        showFiltersModal = false;
        await LoadData();
    }

    private void UpdateStatusFilter(string status, object? isChecked)
    {
        if (isChecked is bool checkedValue)
        {
            if (checkedValue && !selectedStatuses.Contains(status))
            {
                selectedStatuses.Add(status);
            }
            else if (!checkedValue && selectedStatuses.Contains(status))
            {
                selectedStatuses.Remove(status);
            }
        }
    }

    private int GetProgressValue(int current, int max)
    {
        if (max <= 0) return 0;
        var result = (int)Math.Round((current / (decimal)max) * 100);
        return Math.Min(result, 100);
    }

    private Color GetStatusColor(string status) => status.ToLower() switch
    {
        "pending" => Color.Warning,
        "completed" or "paid" => Color.Success,
        "cancelled" or "canceled" => Color.Danger,
        "processing" => Color.Info,
        _ => Color.Secondary
    };

    private string GetStatusDotClass(string status) => status.ToLower() switch
    {
        "pending" => "bg-yellow-500",
        "completed" or "paid" => "bg-green-500",
        "cancelled" or "canceled" => "bg-red-500",
        "processing" => "bg-blue-500",
        _ => "bg-gray-500"
    };
}
