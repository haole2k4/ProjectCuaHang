@page "/admin/inventory"
@rendermode InteractiveServer

@using StoreManagementAPI.Data
@using StoreManagementAPI.Models
@using StoreManagementAPI.Services
@using StoreManagementAPI.DTOs
@using Microsoft.EntityFrameworkCore
@using Blazorise
@using System.Text

@inject StoreDbContext DbContext
@inject IStatisticsService StatisticsService
@inject IJSRuntime JSRuntime

<PageTitle>Inventory - Admin</PageTitle>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="bg-red-50 border-l-4 border-red-500 text-red-800 px-4 py-3 rounded-lg mb-6 flex items-start">
        <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.ExclamationCircle" class="mr-3 mt-0.5 text-red-500" />
        <div>
            <p class="font-bold">Error Loading Inventory</p>
            <p class="text-sm">@errorMessage</p>
        </div>
    </div>
}

@if (!string.IsNullOrEmpty(successMessage))
{
    <div class="bg-green-50 border-l-4 border-green-500 text-green-800 px-4 py-3 rounded-lg mb-6 flex items-start">
        <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.CheckCircle" class="mr-3 mt-0.5 text-green-500" />
        <div>
            <p class="font-bold">Success</p>
            <p class="text-sm">@successMessage</p>
        </div>
    </div>
}

@if (isLoading)
{
    <div class="flex items-center justify-center py-12">
        <div class="text-center">
            <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.Spinner" class="text-blue-600 text-4xl mb-3 animate-spin" />
            <p class="text-gray-600 font-medium">Loading inventory data...</p>
        </div>
    </div>
}
else
{
    <div class="flex justify-between items-center mb-6">
        <div>
            <Heading Size="HeadingSize.Is3" class="text-gray-900 font-bold">Inventory</Heading>
            <Paragraph class="text-gray-600 mb-0">Monitor stock levels and warehouse inventory</Paragraph>
        </div>
        <div class="flex gap-3">
            <Button Color="Color.Light" Clicked="ExportToExcel" class="!bg-white !border-2 !border-gray-300 !text-gray-900 hover:!bg-gray-100 shadow-sm">
                <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.Download" class="mr-2" /> Export
            </Button>
            <Button Color="Color.Primary" Clicked="OpenAddStockModal" class="!text-white !bg-blue-600 hover:!bg-blue-700 shadow-md">
                <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.Plus" class="mr-2" /> Add Stock
            </Button>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
        <Card class="shadow-md border-0 !bg-white">
            <CardBody class="p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <Paragraph class="text-gray-600 text-sm mb-1">Total Products</Paragraph>
                        <Heading Size="HeadingSize.Is3" class="text-gray-900 mb-0">@(inventoryStats?.TotalProducts ?? 0)
                        </Heading>
                    </div>
                    <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
                        <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.BoxOpen" class="text-blue-600 text-xl" />
                    </div>
                </div>
            </CardBody>
        </Card>

        <Card class="shadow-md border-0 !bg-white">
            <CardBody class="p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <Paragraph class="text-gray-600 text-sm mb-1">Low Stock</Paragraph>
                        <Heading Size="HeadingSize.Is3" class="text-orange-600 mb-0">@(inventoryStats?.LowStockProducts ?? 0)
                        </Heading>
                    </div>
                    <div class="w-12 h-12 bg-orange-100 rounded-xl flex items-center justify-center">
                        <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.ExclamationTriangle" class="text-orange-600 text-xl" />
                    </div>
                </div>
            </CardBody>
        </Card>

        <Card class="shadow-md border-0 !bg-white">
            <CardBody class="p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <Paragraph class="text-gray-600 text-sm mb-1">Out of Stock</Paragraph>
                        <Heading Size="HeadingSize.Is3" class="text-red-600 mb-0">@(inventoryStats?.OutOfStockProducts ?? 0)
                        </Heading>
                    </div>
                    <div class="w-12 h-12 bg-red-100 rounded-xl flex items-center justify-center">
                        <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.TimesCircle" class="text-red-600 text-xl" />
                    </div>
                </div>
            </CardBody>
        </Card>

        <Card class="shadow-md border-0 !bg-white">
            <CardBody class="p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <Paragraph class="text-gray-600 text-sm mb-1">Total Value</Paragraph>
                        <Heading Size="HeadingSize.Is3" class="text-gray-900 mb-0">$@((inventoryStats?.TotalInventoryValue ?? 0).ToString("N0"))</Heading>
                    </div>
                    <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">
                        <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.DollarSign" class="text-green-600 text-xl" />
                    </div>
                </div>
            </CardBody>
        </Card>
    </div>

    <!-- Low Stock Items -->
    <Card class="!bg-white shadow-xl border border-gray-200 rounded-xl overflow-hidden">
        <CardHeader class="bg-white border-b border-gray-200 p-6">
            <Heading Size="HeadingSize.Is5" class="text-gray-900 font-bold mb-0">Low Stock Items</Heading>
        </CardHeader>
        <CardBody Padding="Padding.Is0">
            <div class="overflow-x-auto">
                <Table class="mb-0 w-full">
                    <TableHeader>
                        <TableRow class="bg-white border-b-2 border-gray-200">
                            <TableHeaderCell class="px-6 py-4 text-gray-900 font-bold text-sm uppercase tracking-wider">Product</TableHeaderCell>
                            <TableHeaderCell class="px-6 py-4 text-gray-900 font-bold text-sm uppercase tracking-wider">Warehouse</TableHeaderCell>
                            <TableHeaderCell class="px-6 py-4 text-gray-900 font-bold text-sm uppercase tracking-wider">Current Stock</TableHeaderCell>
                            <TableHeaderCell class="px-6 py-4 text-gray-900 font-bold text-sm uppercase tracking-wider">Price</TableHeaderCell>
                            <TableHeaderCell class="px-6 py-4 text-gray-900 font-bold text-sm uppercase tracking-wider text-right">Actions</TableHeaderCell>
                        </TableRow>
                    </TableHeader>
                    <TableBody class="bg-white divide-y divide-gray-200">
                        @if (inventoryStats?.LowStockItems != null && inventoryStats.LowStockItems.Any())
                        {
                            @foreach (var item in inventoryStats.LowStockItems.Take(10))
                            {
                                <TableRow class="bg-white hover:bg-gray-100 transition-colors duration-150">
                                    <TableRowCell class="px-6 py-4">
                                        <div class="flex items-center gap-3">
                                            <div class="w-10 h-10 bg-gray-100 rounded-lg flex items-center justify-center">
                                                <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.BoxOpen" class="text-gray-400" />
                                            </div>
                                            <span class="font-bold text-gray-900">@item.ProductName</span>
                                        </div>
                                    </TableRowCell>
                                    <TableRowCell class="px-6 py-4">
                                        <span class="text-gray-900 font-medium">@item.WarehouseName</span>
                                    </TableRowCell>
                                    <TableRowCell class="px-6 py-4">
                                        @if (item.CurrentStock == 0)
                                        {
                                            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-semibold bg-red-100 text-red-800">
                                                @item.CurrentStock units
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-semibold bg-orange-100 text-orange-800">
                                                @item.CurrentStock units
                                            </span>
                                        }
                                    </TableRowCell>
                                    <TableRowCell class="px-6 py-4">
                                        <span class="font-bold text-gray-900">$@item.Price.ToString("N2")</span>
                                    </TableRowCell>
                                    <TableRowCell class="px-6 py-4 text-right">
                                        <Button Color="Color.Primary" Size="Size.Small" Clicked="() => OpenRestockModal(item)" class="!bg-blue-600 hover:!bg-blue-700 !text-white shadow-sm">
                                            <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.Plus" class="mr-1" /> Restock
                                        </Button>
                                    </TableRowCell>
                                </TableRow>
                            }
                        }
                        else
                        {
                            <TableRow class="bg-white">
                                <TableRowCell ColumnSpan="5" class="text-center py-12">
                                    <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.CheckCircle" class="text-green-500 text-4xl mb-3" />
                                    <p class="text-gray-600 font-medium">All products are well stocked!</p>
                                </TableRowCell>
                            </TableRow>
                        }
                    </TableBody>
                </Table>
            </div>
        </CardBody>
    </Card>
}

<!-- Add Stock Modal -->
<Modal @ref="addStockModal">
    <ModalContent Size="ModalSize.Large">
        <ModalHeader class="bg-white border-b border-gray-200">
            <ModalTitle class="text-gray-900 font-bold">Add Stock</ModalTitle>
            <CloseButton Clicked="CloseAddStockModal" />
        </ModalHeader>
        <ModalBody class="bg-white">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-bold text-gray-900 mb-2">Product *</label>
                    <Select TValue="int" @bind-SelectedValue="stockForm.ProductId" class="w-full !border-gray-300">
                        <SelectItem Value="0">Select Product</SelectItem>
                        @foreach (var product in allProducts)
                        {
                            <SelectItem Value="@product.ProductId">@product.ProductName</SelectItem>
                        }
                    </Select>
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-900 mb-2">Warehouse *</label>
                    <Select TValue="int?" @bind-SelectedValue="stockForm.WarehouseId" class="w-full !border-gray-300">
                        <SelectItem Value="@((int?)null)">Select Warehouse</SelectItem>
                        @foreach (var warehouse in warehouses)
                        {
                            <SelectItem Value="@warehouse.WarehouseId">@warehouse.WarehouseName</SelectItem>
                        }
                    </Select>
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-900 mb-2">Quantity *</label>
                    <NumericEdit TValue="int" @bind-Value="stockForm.Quantity" Min="1" Placeholder="Enter quantity" class="w-full !border-gray-300" />
                </div>

                @if (!string.IsNullOrEmpty(modalErrorMessage))
                {
                    <Alert Color="Color.Danger" Visible class="!bg-red-50 !border-red-200 !text-red-900">
                        @modalErrorMessage
                    </Alert>
                }
            </div>
        </ModalBody>
        <ModalFooter class="bg-gray-50 border-t border-gray-200">
            <Button Color="Color.Secondary" Clicked="CloseAddStockModal" class="!bg-white !border-2 !border-gray-300 !text-gray-900 hover:!bg-gray-100 shadow-sm">Cancel</Button>
            <Button Color="Color.Primary" Clicked="SaveStock" Loading="isSavingStock" class="!bg-blue-600 hover:!bg-blue-700 !text-white shadow-md">
                Add Stock
            </Button>
        </ModalFooter>
    </ModalContent>
</Modal>

<!-- Restock Modal -->
<Modal @ref="restockModal">
    <ModalContent Size="ModalSize.Default">
        <ModalHeader class="bg-white border-b border-gray-200">
            <ModalTitle class="text-gray-900 font-bold">Restock: @selectedProduct?.ProductName</ModalTitle>
            <CloseButton Clicked="CloseRestockModal" />
        </ModalHeader>
        <ModalBody class="bg-white">
            <div class="space-y-4">
                <div class="bg-gray-50 p-4 rounded-lg">
                    <p class="text-sm text-gray-600 mb-1">Current Stock</p>
                    <p class="text-2xl font-bold text-gray-900">@selectedProduct?.CurrentStock units</p>
                    <p class="text-sm text-gray-600 mt-2">Warehouse: @selectedProduct?.WarehouseName</p>
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-900 mb-2">Add Quantity *</label>
                    <NumericEdit TValue="int" @bind-Value="restockQuantity" Min="1" Placeholder="Enter quantity to add" class="w-full !border-gray-300" />
                    <p class="text-sm text-gray-500 mt-1">New stock will be: @(selectedProduct?.CurrentStock + restockQuantity) units</p>
                </div>

                @if (!string.IsNullOrEmpty(modalErrorMessage))
                {
                    <Alert Color="Color.Danger" Visible class="!bg-red-50 !border-red-200 !text-red-900">
                        @modalErrorMessage
                    </Alert>
                }
            </div>
        </ModalBody>
        <ModalFooter class="bg-gray-50 border-t border-gray-200">
            <Button Color="Color.Secondary" Clicked="CloseRestockModal" class="!bg-white !border-2 !border-gray-300 !text-gray-900 hover:!bg-gray-100 shadow-sm">Cancel</Button>
            <Button Color="Color.Primary" Clicked="SaveRestock" Loading="isSavingStock" class="!bg-blue-600 hover:!bg-blue-700 !text-white shadow-md">
                Restock
            </Button>
        </ModalFooter>
    </ModalContent>
</Modal>

@code {
    private InventoryStatisticsDto? inventoryStats;
    private string? errorMessage;
    private string? successMessage;
    private string? modalErrorMessage;
    private bool isLoading = true;
    private bool isSavingStock = false;

    private Modal addStockModal = null!;
    private Modal restockModal = null!;

    private List<Product> allProducts = new();
    private List<Warehouse> warehouses = new();

    private StockFormModel stockForm = new();
    private LowStockProductDto? selectedProduct;
    private int restockQuantity = 10;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        try
        {
            isLoading = true;
            errorMessage = null;
            
            inventoryStats = await StatisticsService.GetInventoryStatisticsAsync(10);
            
            allProducts = await DbContext.Products
                .Where(p => p.Status == "active")
                .OrderBy(p => p.ProductName)
                .ToListAsync();
            
            warehouses = await DbContext.Warehouses
                .Where(w => w.Status == "active")
                .OrderBy(w => w.WarehouseName)
                .ToListAsync();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading inventory statistics: {ex.Message}";
            Console.WriteLine($"Inventory Error: {ex}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private void OpenAddStockModal()
    {
        stockForm = new StockFormModel { Quantity = 10 };
        modalErrorMessage = null;
        addStockModal.Show();
    }

    private void CloseAddStockModal()
    {
        addStockModal.Hide();
        modalErrorMessage = null;
    }

    private void OpenRestockModal(LowStockProductDto product)
    {
        selectedProduct = product;
        restockQuantity = 10;
        modalErrorMessage = null;
        restockModal.Show();
    }

    private void CloseRestockModal()
    {
        restockModal.Hide();
        modalErrorMessage = null;
        selectedProduct = null;
    }

    private async Task SaveStock()
    {
        modalErrorMessage = null;
        
        if (stockForm.ProductId <= 0)
        {
            modalErrorMessage = "Please select a product";
            return;
        }

        if (stockForm.Quantity <= 0)
        {
            modalErrorMessage = "Quantity must be greater than 0";
            return;
        }

        isSavingStock = true;
        try
        {
            var inventory = await DbContext.Inventories
                .FirstOrDefaultAsync(i => i.ProductId == stockForm.ProductId && i.WarehouseId == stockForm.WarehouseId);

            if (inventory != null)
            {
                inventory.Quantity += stockForm.Quantity;
                inventory.UpdatedAt = DateTime.Now;
            }
            else
            {
                inventory = new StoreManagementAPI.Models.Inventory
                {
                    ProductId = stockForm.ProductId,
                    WarehouseId = stockForm.WarehouseId,
                    Quantity = stockForm.Quantity,
                    UpdatedAt = DateTime.Now
                };
                DbContext.Inventories.Add(inventory);
            }

            await DbContext.SaveChangesAsync();
            
            successMessage = $"Successfully added {stockForm.Quantity} units to inventory";
            CloseAddStockModal();
            await LoadData();
            
            await Task.Delay(3000);
            successMessage = null;
        }
        catch (Exception ex)
        {
            modalErrorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            isSavingStock = false;
        }
    }

    private async Task SaveRestock()
    {
        if (selectedProduct == null) return;
        
        modalErrorMessage = null;
        
        if (restockQuantity <= 0)
        {
            modalErrorMessage = "Quantity must be greater than 0";
            return;
        }

        isSavingStock = true;
        try
        {
            var inventory = await DbContext.Inventories
                .FirstOrDefaultAsync(i => i.ProductId == selectedProduct.ProductId);

            if (inventory != null)
            {
                inventory.Quantity += restockQuantity;
                inventory.UpdatedAt = DateTime.Now;
                await DbContext.SaveChangesAsync();
                
                successMessage = $"Successfully restocked {selectedProduct.ProductName} with {restockQuantity} units";
                CloseRestockModal();
                await LoadData();
                
                await Task.Delay(3000);
                successMessage = null;
            }
            else
            {
                modalErrorMessage = "Inventory record not found";
            }
        }
        catch (Exception ex)
        {
            modalErrorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            isSavingStock = false;
        }
    }

    private async Task ExportToExcel()
    {
        try
        {
            var allInventory = await DbContext.Inventories
                .Include(i => i.Product)
                .Include(i => i.Warehouse)
                .OrderBy(i => i.Product!.ProductName)
                .ToListAsync();

            var csv = new StringBuilder();
            csv.AppendLine("Product Name,Warehouse,Current Stock,Price,Total Value,Last Updated");

            foreach (var item in allInventory)
            {
                csv.AppendLine($"\"{item.Product?.ProductName}\",\"{item.Warehouse?.WarehouseName ?? "Main"}\",{item.Quantity},{item.Product?.Price ?? 0},{item.Quantity * (item.Product?.Price ?? 0)},{item.UpdatedAt:yyyy-MM-dd HH:mm:ss}");
            }

            var fileName = $"Inventory_Export_{DateTime.Now:yyyyMMdd_HHmmss}.csv";
            var bytes = Encoding.UTF8.GetBytes(csv.ToString());
            var base64 = Convert.ToBase64String(bytes);

            await JSRuntime.InvokeVoidAsync("downloadFile", fileName, base64);
            
            successMessage = "Inventory exported successfully!";
            await Task.Delay(3000);
            successMessage = null;
        }
        catch (Exception ex)
        {
            errorMessage = $"Error exporting: {ex.Message}";
            await Task.Delay(3000);
            errorMessage = null;
        }
    }

    private class StockFormModel
    {
        public int ProductId { get; set; }
        public int? WarehouseId { get; set; }
        public int Quantity { get; set; }
    }
}
