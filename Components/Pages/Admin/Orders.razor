@page "/admin/orders"
@rendermode InteractiveServer
@attribute [Authorize(Roles = "Admin, SalesStaff")]

@using StoreManagementAPI.Data
@using StoreManagementAPI.Models
@using StoreManagementAPI.DTOs
@using StoreManagementAPI.Services
@using Microsoft.EntityFrameworkCore
@using Blazorise

@inject StoreDbContext DbContext
@inject NavigationManager NavigationManager
@inject IOrderService OrderService

<PageTitle>Orders - Admin</PageTitle>

<div class="flex justify-between items-center mb-6">
    <div>
        <Heading Size="HeadingSize.Is3" class="!text-gray-900 font-bold">Orders</Heading>
        <Paragraph class="text-gray-600 mb-0">Manage customer orders</Paragraph>
    </div>
    <div class="flex gap-3">
        <Button Color="Color.Primary" Clicked="OpenCreateOrderModal" class="!bg-blue-600 hover:!bg-blue-700 !text-white shadow-sm">
            <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.Plus" class="mr-2" /> Create Order
        </Button>
        <Button Color="Color.Light" class="!bg-white !border-2 !border-gray-300 !text-gray-900 hover:!bg-gray-100 shadow-sm">
            <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.Filter" class="mr-2" /> Filter
        </Button>
        <Button Color="Color.Light" class="!bg-white !border-2 !border-gray-300 !text-gray-900 hover:!bg-gray-100 shadow-sm">
            <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.Download" class="mr-2" /> Export
        </Button>
    </div>
</div>

<!-- Stats Cards -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
    <Card class="shadow-md border-0 !bg-white">
        <CardBody class="p-6">
            <div class="flex items-center justify-between">
                <div>
                    <Paragraph class="!text-gray-600 text-sm mb-1">Total Orders</Paragraph>
                    <Heading Size="HeadingSize.Is3" class="!text-gray-900 mb-0">@orders?.Count</Heading>
                </div>
                <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
                    <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.ShoppingBag" class="text-blue-600 text-xl" />
                </div>
            </div>
        </CardBody>
    </Card>

    <Card class="shadow-md border-0 !bg-white">
        <CardBody class="p-6">
            <div class="flex items-center justify-between">
                <div>
                    <Paragraph class="!text-gray-600 text-sm mb-1">Pending</Paragraph>
                    <Heading Size="HeadingSize.Is3" class="!text-orange-600 mb-0">@orders?.Count(o => o.Status == "pending")</Heading>
                </div>
                <div class="w-12 h-12 bg-orange-100 rounded-xl flex items-center justify-center">
                    <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.Clock" class="text-orange-600 text-xl" />
                </div>
            </div>
        </CardBody>
    </Card>

    <Card class="shadow-md border-0 !bg-white">
        <CardBody class="p-6">
            <div class="flex items-center justify-between">
                <div>
                    <Paragraph class="!text-gray-600 text-sm mb-1">Completed</Paragraph>
                    <Heading Size="HeadingSize.Is3" class="!text-green-600 mb-0">@orders?.Count(o => o.Status == "completed" || o.Status == "paid")</Heading>
                </div>
                <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">
                    <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.CheckCircle" class="text-green-600 text-xl" />
                </div>
            </div>
        </CardBody>
    </Card>

    <Card class="shadow-md border-0 !bg-white">
        <CardBody class="p-6">
            <div class="flex items-center justify-between">
                <div>
                    <Paragraph class="!text-gray-600 text-sm mb-1">Revenue</Paragraph>
                    <Heading Size="HeadingSize.Is3" class="!text-gray-900 mb-0">$@(orders?.Sum(o => o.TotalAmount).ToString("N0") ?? "0")</Heading>
                </div>
                <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center">
                    <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.DollarSign" class="text-purple-600 text-xl" />
                </div>
            </div>
        </CardBody>
    </Card>
</div>

<!-- Advanced Search Panel -->
<Card class="!bg-white shadow-md border border-gray-200 rounded-xl overflow-hidden mb-6">
    <CardBody>
        <div class="flex items-center justify-between mb-4">
            <Heading Size="HeadingSize.Is5" class="!text-gray-900 !font-bold mb-0">
                <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.Search" class="mr-2" />
                Search & Filter Orders
            </Heading>
            <Button Color="Color.Light" Size="Size.Small" Clicked="ClearFilters" class="!border-2 !border-gray-400 !text-gray-900 !bg-white hover:!bg-gray-100">
                <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.Redo" class="mr-1" /> Clear
            </Button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <!-- Search Term -->
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Order ID / Customer</label>
                <TextEdit Text="@searchCriteria.SearchTerm"
                          TextChanged="@OnSearchTextChanged"
                          Placeholder="Search..."
                          class="w-full !border-gray-300 !bg-white !text-gray-900 !border-2" />
            </div>

            <!-- Status Filter -->
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Status</label>
                <Select TValue="string?"
                        SelectedValue="searchCriteria.Status"
                        SelectedValueChanged="@OnStatusChanged"
                        class="w-full !border-gray-300 !bg-white !text-gray-900 !border-2">
                    <SelectItem Value="@((string?)null)">All Status</SelectItem>
                    <SelectItem Value="@("pending")">Pending</SelectItem>
                    <SelectItem Value="@("processing")">Processing</SelectItem>
                    <SelectItem Value="@("completed")">Completed</SelectItem>
                    <SelectItem Value="@("paid")">Paid</SelectItem>
                    <SelectItem Value="@("cancelled")">Cancelled</SelectItem>
                </Select>
            </div>

            <!-- Amount Range -->
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Amount Range</label>
                <div class="grid grid-cols-2 gap-2">
                    <NumericEdit TValue="decimal?"
                                 Value="searchCriteria.MinAmount"
                                 ValueChanged="@OnMinAmountChanged"
                                 Placeholder="Min"
                                 class="w-full !border-gray-300 !bg-white !text-gray-900 !border-2"
                                 Decimals="0" />
                    <NumericEdit TValue="decimal?"
                                 Value="searchCriteria.MaxAmount"
                                 ValueChanged="@OnMaxAmountChanged"
                                 Placeholder="Max"
                                 class="w-full !border-gray-300 !bg-white !text-gray-900 !border-2"
                                 Decimals="0" />
                </div>
                @if (!string.IsNullOrEmpty(amountErrorMessage))
                {
                    <div class="mt-2 text-red-600 text-sm font-semibold">
                        <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.ExclamationTriangle" class="mr-1" />
                        @amountErrorMessage
                    </div>
                }
            </div>

            <!-- Date Range -->
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Date Range</label>
                <div class="grid grid-cols-2 gap-2">
                    <DateEdit TValue="DateTime?"
                              Date="searchCriteria.StartDate"
                              DateChanged="@OnStartDateChanged"
                              Placeholder="Start"
                              class="w-full !border-gray-300 !bg-white !text-gray-900 !border-2" />
                    <DateEdit TValue="DateTime?"
                              Date="searchCriteria.EndDate"
                              DateChanged="@OnEndDateChanged"
                              Placeholder="End"
                              class="w-full !border-gray-300 !bg-white !text-gray-900 !border-2" />
                </div>
                @if (!string.IsNullOrEmpty(dateErrorMessage))
                {
                    <div class="mt-2 text-red-600 text-sm font-semibold">
                        <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.ExclamationTriangle" class="mr-1" />
                        @dateErrorMessage
                    </div>
                }
            </div>
        </div>

        @if (searchResult != null)
        {
            <div class="mt-4 pt-4 border-t border-gray-200">
                <span class="text-gray-600">
                    Found <span class="font-bold text-blue-600">@searchResult.TotalCount</span> orders
                </span>
            </div>
        }
    </CardBody>
</Card>

<!-- Orders Table -->
<Card class="!bg-white shadow-xl border border-gray-200 rounded-xl overflow-hidden">
    <CardBody Padding="Padding.Is0">
        <div class="overflow-x-auto">
            <Table class="mb-0 w-full">
                @* <TableHeader>
                    <TableRow class="bg-white border-b-2 border-gray-200">
                        <TableHeaderCell class="px-6 py-4 text-center text-gray-900 font-bold text-sm uppercase tracking-wider">Order
                            ID</TableHeaderCell>
                        <TableHeaderCell class="px-6 py-4 text-center text-gray-900 font-bold text-sm uppercase tracking-wider">
                            Customer</TableHeaderCell>
                        <TableHeaderCell class="px-6 py-4 text-center text-gray-900 font-bold text-sm uppercase tracking-wider">
                            Date</TableHeaderCell>
                        <TableHeaderCell class="px-6 py-4 text-center text-gray-900 font-bold text-sm uppercase tracking-wider">
                            Status</TableHeaderCell>
                        <TableHeaderCell class="px-6 py-4 text-center text-gray-900 font-bold text-sm uppercase tracking-wider">
                            Amount</TableHeaderCell>
                        <TableHeaderCell class="px-6 py-4 text-center text-gray-900 font-bold text-sm uppercase tracking-wider">
                            Actions</TableHeaderCell>
                    </TableRow>
                </TableHeader> *@
                <TableHeader>
                    <TableRow class="!bg-gray-100 border-b border-gray-200">
                        <TableHeaderCell class="!bg-gray-100 !text-gray-700 px-6 py-4 text-center font-bold text-sm uppercase tracking-wider">Order ID</TableHeaderCell>
                        <TableHeaderCell class="!bg-gray-100 !text-gray-700 px-6 py-4 text-center font-bold text-sm uppercase tracking-wider">Customer</TableHeaderCell>
                        <TableHeaderCell class="!bg-gray-100 !text-gray-700 px-6 py-4 text-center font-bold text-sm uppercase tracking-wider">Date</TableHeaderCell>
                        <TableHeaderCell class="!bg-gray-100 !text-gray-700 px-6 py-4 text-center font-bold text-sm uppercase tracking-wider">Status</TableHeaderCell>
                        <TableHeaderCell class="!bg-gray-100 !text-gray-700 px-6 py-4 text-center font-bold text-sm uppercase tracking-wider">Amount</TableHeaderCell>
                        <TableHeaderCell class="!bg-gray-100 !text-gray-700 px-6 py-4 text-center font-bold text-sm uppercase tracking-wider">Actions</TableHeaderCell>
                    </TableRow>
                </TableHeader>
                <TableBody class="bg-white divide-y divide-gray-200">
                    @if (orders != null && orders.Any())
                    {
                        @foreach (var order in orders)
                        {
                            @* <TableRow class="bg-white hover:bg-gray-100 transition-colors duration-150"> *@
                            <TableRow class="!bg-white hover:!bg-blue-50 transition-colors duration-150 border-b border-gray-100">
                                <TableRowCell class="px-6 py-4 text-center">
                                    <span class="font-bold text-gray-900">#ORD-@order.OrderId.ToString("D6")</span>
                                </TableRowCell>
                                <TableRowCell class="px-6 py-4 text-center">
                                    <div class="flex items-center gap-3">
                                        <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-white text-xs font-bold shadow-md">
                                            @(order.Customer?.Name?.Substring(0, 1).ToUpper() ?? "G")
                                        </div>
                                        <span class="text-gray-900 font-medium">@(order.Customer?.Name ?? "Guest")</span>
                                    </div>
                                </TableRowCell>
                                <TableRowCell class="px-6 py-4 text-center">
                                    <span class="text-gray-900">@order.OrderDate.ToString("dd/MM/yyyy")</span>
                                </TableRowCell>
                                <TableRowCell class="px-6 py-4 text-center">
                                    @{
                                        var statusClass = order.Status.ToLower() switch
                                        {
                                            "pending" => "bg-orange-100 text-orange-800",
                                            "completed" or "paid" => "bg-green-100 text-green-800",
                                            "cancelled" or "canceled" => "bg-red-100 text-red-800",
                                            "processing" => "bg-blue-100 text-blue-800",
                                            _ => "bg-gray-100 text-gray-800"
                                        };
                                    }
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-semibold @statusClass">
                                        @order.Status
                                    </span>
                                </TableRowCell>
                                <TableRowCell class="px-6 py-4 text-center">
                                    <span class="font-bold text-gray-900">$@order.TotalAmount.ToString("N2")</span>
                                </TableRowCell>
                                <TableRowCell class="px-6 py-4 text-right">
                                    <div class="flex gap-2 justify-end">
                                        <button @onclick="() => ViewOrder(order.OrderId)"
                                                class="px-3 py-1.5 bg-blue-50 text-blue-600 hover:bg-blue-100 border border-blue-200 rounded-lg transition text-sm font-medium flex items-center gap-1.5">
                                            <i class="fas fa-eye"></i>
                                            <span>View</span>
                                        </button>
                                        @if (order.Status.ToLower() == "pending")
                                        {
                                            <button @onclick='() => UpdateOrderStatus(order.OrderId, "processing")'
                                                    class="px-3 py-1.5 bg-blue-600 text-white hover:bg-blue-700 rounded-lg transition text-sm font-medium flex items-center gap-1.5">
                                                <i class="fas fa-check"></i>
                                                <span>Process</span>
                                            </button>
                                        }
                                        @if (order.Status.ToLower() == "processing")
                                        {
                                            <button @onclick='() => UpdateOrderStatus(order.OrderId, "completed")'
                                                    class="px-3 py-1.5 bg-green-600 text-white hover:bg-green-700 rounded-lg transition text-sm font-medium flex items-center gap-1.5">
                                                <i class="fas fa-check-circle"></i>
                                                <span>Complete</span>
                                            </button>
                                        }
                                        @if (order.Status.ToLower() != "cancelled" && order.Status.ToLower() != "completed")
                                        {
                                            <button @onclick="() => CancelOrder(order.OrderId)"
                                                    class="px-3 py-1.5 bg-red-50 text-red-600 hover:bg-red-100 border border-red-200 rounded-lg transition text-sm font-medium flex items-center gap-1.5">
                                                <i class="fas fa-times"></i>
                                                <span>Cancel</span>
                                            </button>
                                        }
                                    </div>
                                </TableRowCell>
                            </TableRow>
                        }
                    }
                    else
                    {
                        <TableRow class="bg-white">
                            <TableRowCell ColumnSpan="6" class="text-center py-12">
                                <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.ShoppingBag" class="text-gray-400 text-4xl mb-3" />
                                <p class="text-gray-600 font-medium">No orders found</p>
                            </TableRowCell>
                        </TableRow>
                    }
                </TableBody>
            </Table>
        </div>

        <PaginationComponent CurrentPage="@currentPage" PageSize="@pageSize" TotalItems="@totalItems" OnPageChanged="@HandlePageChanged" />
    </CardBody>
</Card>

<!-- Toast Notification -->
@if (showToast)
{
    <div class="fixed bottom-6 right-6 z-50 animate-slide-up">
        <div class="@toastClass text-white px-6 py-4 rounded-xl shadow-2xl flex items-center gap-3 max-w-md">
            <div class="flex-shrink-0">
                <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center">
                    <i class="@toastIcon text-lg"></i>
                </div>
            </div>
            <div class="flex-1">
                <p class="font-semibold">@toastMessage</p>
            </div>
            <button @onclick="() => showToast = false"
                    class="flex-shrink-0 text-white/80 hover:text-white transition">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>
}

<!-- Order Details Modal -->
@if (showDetailsModal && selectedOrder != null)
{
    <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4" @onclick="CloseDetailsModal">
        <div class="bg-white rounded-xl shadow-2xl max-w-3xl w-full max-h-[90vh] border border-gray-200 flex flex-col" @onclick:stopPropagation>
            <!-- Header - Fixed -->
            <div class="bg-white border-b-2 border-black px-6 py-4 rounded-t-xl flex-shrink-0">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-xl font-bold text-black">Order Details</h3>
                        <p class="text-gray-600 text-sm">#ORD-@selectedOrder.OrderId.ToString("D6")</p>
                    </div>
                    <button @onclick="CloseDetailsModal"
                            class="w-8 h-8 bg-gray-100 hover:bg-gray-200 rounded-lg flex items-center justify-center transition">
                        <i class="fas fa-times text-black"></i>
                    </button>
                </div>
            </div>

            <!-- Content - Scrollable -->
            <div class="p-6 space-y-5 overflow-y-auto flex-1">
                <!-- Customer & Order Info -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="border border-gray-300 rounded-lg p-4 bg-white">
                        <h4 class="text-xs font-bold text-gray-700 uppercase mb-3">Customer Information</h4>
                        <div class="space-y-2">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-gray-900 rounded-full flex items-center justify-center text-white font-bold text-sm">
                                    @(selectedOrder.Customer?.Name?.Substring(0, 1).ToUpper() ?? "G")
                                </div>
                                <div>
                                    <p class="font-bold text-black text-sm">@(selectedOrder.Customer?.Name ?? "Guest Customer")</p>
                                    <p class="text-xs text-gray-600">@(selectedOrder.Customer?.Email ?? "N/A")</p>
                                </div>
                            </div>
                            <div class="pt-2 border-t border-gray-200 space-y-1">
                                <p class="text-xs text-black"><i class="fas fa-phone w-4 text-gray-600"></i> @(selectedOrder.Customer?.Phone ?? "N/A")</p>
                                <p class="text-xs text-black"><i class="fas fa-map-marker-alt w-4 text-gray-600"></i> @(selectedOrder.Customer?.Address ?? "N/A")</p>
                            </div>
                        </div>
                    </div>

                    <div class="border border-gray-300 rounded-lg p-4 bg-white">
                        <h4 class="text-xs font-bold text-gray-700 uppercase mb-3">Order Information</h4>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Order Date:</span>
                                <span class="font-semibold text-black">@selectedOrder.OrderDate.ToString("MMM dd, yyyy HH:mm")</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Status:</span>
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold @GetStatusClass(selectedOrder.Status)">
                                    @selectedOrder.Status.ToUpper()
                                </span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Payment:</span>
                                <span class="font-semibold text-black">@(selectedOrder.Payments?.FirstOrDefault()?.PaymentMethod ?? "N/A")</span>
                            </div>
                            @if (selectedOrder.Payments != null && selectedOrder.Payments.Any())
                            {
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Payment Date:</span>
                                    <span class="font-semibold text-black">@selectedOrder.Payments.First().PaymentDate.ToString("MMM dd, yyyy HH:mm")</span>
                                </div>
                            }
                        </div>
                    </div>
                </div>

                <!-- Order Items -->
                <div>
                    <h4 class="text-xs font-bold text-gray-700 uppercase mb-3">Order Items</h4>
                    <div class="border border-gray-300 rounded-lg overflow-hidden">
                        <table class="w-full">
                            <thead class="bg-gray-100 border-b border-gray-300">
                                <tr>
                                    <th class="px-4 py-2 text-left text-xs font-bold text-black uppercase">Product</th>
                                    <th class="px-4 py-2 text-center text-xs font-bold text-black uppercase">Qty</th>
                                    <th class="px-4 py-2 text-right text-xs font-bold text-black uppercase">Price</th>
                                    <th class="px-4 py-2 text-right text-xs font-bold text-black uppercase">Total</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                @if (selectedOrder.OrderItems != null && selectedOrder.OrderItems.Any())
                                {
                                    @foreach (var item in selectedOrder.OrderItems)
                                    {
                                        <tr class="bg-white">
                                            <td class="px-4 py-3">
                                                <div class="flex items-center gap-2">
                                                    @if (!string.IsNullOrEmpty(item.Product?.ImageUrl))
                                                    {
                                                        <img src="@item.Product.ImageUrl" alt="@item.Product.ProductName" class="w-10 h-10 object-cover rounded-lg border border-gray-200" />
                                                    }
                                                    else
                                                    {
                                                        <div class="w-10 h-10 bg-gray-200 rounded-lg flex items-center justify-center">
                                                            <i class="fas fa-box text-gray-500 text-sm"></i>
                                                        </div>
                                                    }
                                                    <div>
                                                        <p class="font-semibold text-black text-sm">@(item.Product?.ProductName ?? "Unknown Product")</p>
                                                    </div>
                                                </div>
                                            </td>
                                            <td class="px-4 py-3 text-center">
                                                <span class="inline-flex items-center justify-center w-7 h-7 bg-gray-200 text-black rounded-md font-semibold text-xs">
                                                    @item.Quantity
                                                </span>
                                            </td>
                                            <td class="px-4 py-3 text-right font-medium text-black text-sm">$@item.Price.ToString("N2")</td>
                                            <td class="px-4 py-3 text-right font-bold text-black text-sm">$@item.Subtotal.ToString("N2")</td>
                                        </tr>
                                    }
                                }
                                else
                                {
                                    <tr>
                                        <td colspan="4" class="px-4 py-8 text-center text-gray-500 text-sm">No items found</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Order Summary -->
                <div class="border-2 border-gray-300 rounded-lg p-4 bg-gray-50">
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between text-black">
                            <span>Subtotal:</span>
                            <span class="font-medium">$@((selectedOrder.TotalAmount + selectedOrder.DiscountAmount).ToString("N2"))</span>
                        </div>
                        @if (selectedOrder.DiscountAmount > 0)
                        {
                            <div class="flex justify-between text-green-600">
                                <span><i class="fas fa-tag mr-1"></i>Discount:</span>
                                <span class="font-medium">-$@selectedOrder.DiscountAmount.ToString("N2")</span>
                            </div>
                        }
                        <div class="flex justify-between text-black">
                            <span>Tax:</span>
                            <span class="font-medium">$0.00</span>
                        </div>
                        <div class="flex justify-between text-black">
                            <span>Shipping:</span>
                            <span class="font-medium">$0.00</span>
                        </div>
                        <div class="border-t-2 border-gray-400 pt-2 mt-2">
                            <div class="flex justify-between items-center">
                                <span class="text-base font-bold text-black">Total Amount:</span>
                                <span class="text-xl font-bold text-black">$@selectedOrder.TotalAmount.ToString("N2")</span>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Footer - Fixed -->
            <div class="border-t border-gray-300 px-6 py-4 bg-white rounded-b-xl flex-shrink-0">
                <div class="flex justify-between items-center">
                    <button @onclick='() => NavigateToBill(selectedOrder.OrderId)'
                            class="px-4 py-2 bg-gray-900 hover:bg-black text-white text-sm font-semibold rounded-lg transition">
                        <i class="fas fa-print mr-1"></i> Print Invoice
                    </button>
                    <div class="flex gap-2">
                        @if (selectedOrder.Status.ToLower() == "pending")
                        {
                            <button @onclick='() => UpdateOrderStatusFromModal(selectedOrder.OrderId, "processing")'
                                    class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold rounded-lg transition">
                                <i class="fas fa-check mr-1"></i> Process
                            </button>
                        }
                        @if (selectedOrder.Status.ToLower() == "processing")
                        {
                            <button @onclick='() => UpdateOrderStatusFromModal(selectedOrder.OrderId, "completed")'
                                    class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white text-sm font-semibold rounded-lg transition">
                                <i class="fas fa-check-circle mr-1"></i> Complete
                            </button>
                        }
                        @if (selectedOrder.Status.ToLower() != "cancelled" && selectedOrder.Status.ToLower() != "completed")
                        {
                            <button @onclick="() => CancelOrderFromModal(selectedOrder.OrderId)"
                                    class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white text-sm font-semibold rounded-lg transition">
                                <i class="fas fa-times mr-1"></i> Cancel
                            </button>
                        }
                        <button @onclick="CloseDetailsModal"
                                class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-900 text-sm font-semibold rounded-lg transition">
                            Close
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

<!-- Confirmation Modal -->
@if (showConfirmModal)
{
    <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm" @onclick="CloseConfirmModal">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 overflow-hidden" @onclick:stopPropagation>
            <div class="p-6">
                <div class="flex items-center gap-4 mb-4">
                    <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-gray-900">Confirm Cancellation</h3>
                        <p class="text-gray-600 text-sm">This action cannot be undone</p>
                    </div>
                </div>
                <p class="text-gray-700 mb-6">
                    Are you sure you want to cancel Order <span class="font-bold">#ORD-@confirmOrderId.ToString("D6")</span>?
                </p>
                <div class="flex gap-3">
                    <button @onclick="CloseConfirmModal"
                            class="flex-1 px-4 py-2.5 border-2 border-gray-300 text-gray-700 font-semibold rounded-lg hover:bg-gray-50 transition">
                        No, Keep Order
                    </button>
                    <button @onclick="ConfirmCancel"
                            class="flex-1 px-4 py-2.5 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg transition">
                        Yes, Cancel Order
                    </button>
                </div>
            </div>
        </div>
    </div>
}

<!-- Create Order Modal -->
@if (showCreateOrderModal)
{
    <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm" @onclick="CloseCreateOrderModal">
        <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-hidden flex flex-col" @onclick:stopPropagation>
            <!-- Header -->
            <div class="bg-gradient-to-r from-blue-600 to-blue-700 px-6 py-4 flex items-center justify-between flex-shrink-0">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-white/20 rounded-lg flex items-center justify-center">
                        <i class="fas fa-shopping-cart text-white text-lg"></i>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-white">Create Order</h3>
                        <p class="text-blue-100 text-sm">Point of Sale - In-Store Purchase</p>
                    </div>
                </div>
                <button @onclick="CloseCreateOrderModal" class="text-white/80 hover:text-white text-2xl w-8 h-8 flex items-center justify-center">
                    ×
                </button>
            </div>

            <!-- Body -->
            <div class="flex-1 overflow-y-auto p-6">
                <!-- Customer Selection -->
                <div class="mb-6">
                    <label class="block text-sm font-bold text-gray-900 mb-2">
                        <span class="text-red-600">*</span> Customer
                    </label>
                    <Select TValue="int" @bind-SelectedValue="selectedCustomerId" class="w-full !border-gray-300">
                        <SelectItem Value="0">-- Select Customer --</SelectItem>
                        @if (customers != null)
                        {
                            @foreach (var customer in customers)
                            {
                                <SelectItem Value="@customer.CustomerId">@customer.Name - @customer.Phone</SelectItem>
                            }
                        }
                    </Select>
                </div>

                <!-- Product Selection Section -->
                <div class="mb-6">
                    <div class="flex items-center justify-between mb-3">
                        <label class="text-sm font-bold text-gray-900">
                            <i class="fas fa-box mr-1"></i> Add Products
                        </label>
                    </div>

                    <div class="bg-gray-50 border-2 border-dashed border-gray-300 rounded-xl p-4">
                        <div class="grid grid-cols-12 gap-3">
                            <div class="col-span-7">
                                <label class="block text-xs font-semibold text-gray-700 mb-2">Product</label>
                                <Select TValue="int" @bind-SelectedValue="selectedProductId" class="w-full !border-gray-300">
                                    <SelectItem Value="0">-- Select Product --</SelectItem>
                                    @if (products != null)
                                    {
                                        @foreach (var product in products)
                                        {
                                            <SelectItem Value="@product.ProductId">@product.ProductName - $@product.Price.ToString("N2")</SelectItem>
                                        }
                                    }
                                </Select>
                            </div>
                            <div class="col-span-3">
                                <label class="block text-xs font-semibold text-gray-700 mb-2">Quantity</label>
                                <NumericEdit TValue="int" @bind-Value="selectedQuantity" Min="1" class="w-full !border-gray-300" />
                            </div>
                            <div class="col-span-2">
                                <label class="block text-xs font-semibold text-gray-700 mb-2">&nbsp;</label>
                                <Button Color="Color.Primary" Clicked="AddProductToOrder" class="w-full !bg-blue-600 hover:!bg-blue-700">
                                    <i class="fas fa-plus"></i> Add
                                </Button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Order Items List -->
                @if (orderItems.Any())
                {
                    <div class="mb-6">
                        <label class="block text-sm font-bold text-gray-900 mb-3">
                            Products <span class="text-blue-600">(@orderItems.Count)</span>
                        </label>
                        <div class="border-2 border-gray-300 rounded-xl overflow-hidden">
                            <table class="w-full">
                                <thead class="bg-gray-100 border-b-2 border-gray-300">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-bold text-gray-900 uppercase">Product</th>
                                        <th class="px-4 py-3 text-center text-xs font-bold text-gray-900 uppercase w-24">Qty</th>
                                        <th class="px-4 py-3 text-right text-xs font-bold text-gray-900 uppercase w-32">Price</th>
                                        <th class="px-4 py-3 text-right text-xs font-bold text-gray-900 uppercase w-32">Subtotal</th>
                                        <th class="px-4 py-3 text-center text-xs font-bold text-gray-900 uppercase w-20">Action</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200">
                                    @foreach (var (item, index) in orderItems.Select((item, i) => (item, i)))
                                    {
                                        <tr class="bg-white hover:bg-gray-50">
                                            <td class="px-4 py-3">
                                                <span class="font-semibold text-gray-900 text-sm">@item.ProductName</span>
                                            </td>
                                            <td class="px-4 py-3 text-center">
                                                <div class="flex items-center justify-center gap-1">
                                                    <button @onclick="() => DecreaseQuantity(index)" class="w-7 h-7 bg-gray-200 hover:bg-gray-300 rounded text-gray-700 font-bold">−</button>
                                                    <span class="w-10 text-center font-semibold text-gray-900">@item.Quantity</span>
                                                    <button @onclick="() => IncreaseQuantity(index)" class="w-7 h-7 bg-gray-200 hover:bg-gray-300 rounded text-gray-700 font-bold">+</button>
                                                </div>
                                            </td>
                                            <td class="px-4 py-3 text-right font-medium text-gray-900">$@item.Price.ToString("N2")</td>
                                            <td class="px-4 py-3 text-right font-bold text-gray-900">$@item.Subtotal.ToString("N2")</td>
                                            <td class="px-4 py-3 text-center">
                                                <button @onclick="() => RemoveProduct(index)" class="text-red-600 hover:text-red-700">
                                                    <i class="fas fa-trash-alt"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Promotion -->
                    <div class="mb-6">
                        <label class="block text-sm font-bold text-gray-900 mb-2">Promotion (Optional)</label>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs font-semibold text-gray-700 mb-2">Apply Type</label>
                                <Select TValue="string" @bind-SelectedValue="selectedPromotionType" class="w-full !border-gray-300">
                                    <SelectItem Value="@("")">-- All types --</SelectItem>
                                    @if (promotionTypes != null)
                                    {
                                        @foreach (var type in promotionTypes)
                                        {
                                            <SelectItem Value="@type">@GetApplyTypeDisplay(type)</SelectItem>
                                        }
                                    }
                                </Select>
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-gray-700 mb-2">Promo Code</label>
                                <Select TValue="int" @bind-SelectedValue="selectedPromoId" class="w-full !border-gray-300">
                                    <SelectItem Value="0">-- No promotion --</SelectItem>
                                    @if (promotions != null)
                                    {
                                        @foreach (var promo in GetFilteredPromotions())
                                        {
                                            <SelectItem Value="@promo.PromoId">
                                                @promo.PromoCode - @promo.Description (@(promo.DiscountType == "percent" ? $"{promo.DiscountValue}%" : $"${promo.DiscountValue}"))
                                            </SelectItem>
                                        }
                                    }
                                </Select>
                            </div>
                        </div>
                    </div>

                    <!-- Summary -->
                    <div class="bg-gradient-to-br from-blue-50 to-blue-100 border-2 border-blue-300 rounded-xl p-5">
                        <div class="space-y-3">
                            <div class="flex justify-between items-center text-gray-800">
                                <span class="font-semibold">Subtotal:</span>
                                <span class="text-lg font-bold">$@CalculateSubtotal().ToString("N2")</span>
                            </div>
                            @if (selectedPromoId > 0 && promotions != null)
                            {
                                var promo = promotions.FirstOrDefault(p => p.PromoId == selectedPromoId);
                                if (promo != null)
                                {
                                    var subtotal = CalculateSubtotal();
                                    var discount = promo.DiscountType == "percent"
                                        ? subtotal * (promo.DiscountValue / 100)
                                        : promo.DiscountValue;

                                    <div class="flex justify-between items-center text-green-700">
                                        <span class="font-semibold">
                                            <i class="fas fa-tag mr-1"></i> Discount (@promo.PromoCode):
                                        </span>
                                        <span class="text-lg font-bold">-$@discount.ToString("N2")</span>
                                    </div>
                                }
                            }
                            <div class="border-t-2 border-blue-300 pt-3">
                                <div class="flex justify-between items-center">
                                    <span class="text-lg font-bold text-gray-900">Total:</span>
                                    <span class="text-2xl font-bold text-blue-600">$@CalculateTotal().ToString("N2")</span>
                                </div>
                            </div>
                        </div>
                    </div>
                }
                else
                {
                    <div class="text-center py-12 text-gray-500">
                        <i class="fas fa-shopping-basket text-5xl mb-3 text-gray-400"></i>
                        <p class="font-semibold">No products yet</p>
                        <p class="text-sm">Add products to create an order</p>
                    </div>
                }
            </div>

            <!-- Footer -->
            <div class="border-t-2 border-gray-300 px-6 py-4 bg-gray-50 flex justify-between items-center flex-shrink-0">
                <button @onclick="CloseCreateOrderModal"
                        class="px-6 py-2.5 bg-gray-200 hover:bg-gray-300 text-gray-900 font-semibold rounded-lg transition">
                    <i class="fas fa-times mr-1"></i> Cancel
                </button>
                <button @onclick="CreateOrder"
                        disabled="@(!CanCreateOrder())"
                        class="@(CanCreateOrder() ? "bg-blue-600 hover:bg-blue-700" : "bg-gray-400 cursor-not-allowed") px-6 py-2.5 text-white font-semibold rounded-lg transition">
                    <i class="fas fa-check mr-1"></i> Create Order
                </button>
            </div>
        </div>
    </div>
}

<style>
    @@keyframes slide-up {
        from {
            transform: translateY(100%);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    .animate-slide-up {
        animation: slide-up 0.3s ease-out;
    }
</style>

@code {
    private List<Order>? allOrders;
    private List<Order>? orders;
    private bool isProcessing;
    private bool showToast;
    private string toastMessage = "";
    private string toastClass = "";
    private string toastIcon = "";
    private bool showConfirmModal;
    private int confirmOrderId;
    private bool showDetailsModal;
    private Order? selectedOrder;
    private string? amountErrorMessage;
    private string? dateErrorMessage;

    // Pagination
    private int currentPage = 1;
    private int pageSize = 10;
    private int totalItems = 0;

    // Search & Filter
    private OrderSearchDto searchCriteria = new OrderSearchDto
    {
        PageNumber = 1,
        PageSize = 10,
        SortBy = "OrderDate",
        SortDirection = "desc"
    };
    private OrderSearchResultDto? searchResult;

    protected override async Task OnInitializedAsync()
    {
        await LoadOrders();
        await SearchOrders();
    }

    private async Task LoadOrders()
    {
        allOrders = await DbContext.Orders
            .Include(o => o.Customer)
            .OrderByDescending(o => o.OrderDate)
            .ToListAsync();

        totalItems = allOrders?.Count ?? 0;
        UpdatePagedData();
    }

    private async Task SearchOrders()
    {
        try
        {
            // Ensure currentPage is valid
            if (currentPage < 1) currentPage = 1;

            searchCriteria.PageNumber = currentPage;
            searchCriteria.PageSize = pageSize;

            searchResult = await OrderService.SearchOrdersAdvancedAsync(searchCriteria);

            // Convert OrderResponseDto to Order for compatibility
            allOrders = await DbContext.Orders
                .Include(o => o.Customer)
                .Where(o => searchResult.Orders.Select(x => x.OrderId).Contains(o.OrderId))
                .ToListAsync();

            orders = allOrders;
            totalItems = searchResult.TotalCount;

            // If current page is beyond total pages, reset to last page
            if (totalItems > 0)
            {
                var totalPages = (int)Math.Ceiling(totalItems / (double)pageSize);
                if (currentPage > totalPages)
                {
                    currentPage = totalPages;
                    searchCriteria.PageNumber = currentPage;
                    searchResult = await OrderService.SearchOrdersAdvancedAsync(searchCriteria);

                    allOrders = await DbContext.Orders
                        .Include(o => o.Customer)
                        .Where(o => searchResult.Orders.Select(x => x.OrderId).Contains(o.OrderId))
                        .ToListAsync();

                    orders = allOrders;
                }
            }

            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            ShowToast($"Error searching orders: {ex.Message}", "bg-red-600", "fas fa-times");
        }
    }

    private void UpdatePagedData()
    {
        if (allOrders != null)
        {
            orders = allOrders
                .Skip((currentPage - 1) * pageSize)
                .Take(pageSize)
                .ToList();
        }
    }

    private async Task HandlePageChanged(int page)
    {
        currentPage = page;
        await SearchOrders();
    }

    private async Task ClearFilters()
    {
        searchCriteria = new OrderSearchDto
        {
            PageNumber = 1,
            PageSize = pageSize,
            SortBy = "OrderDate",
            SortDirection = "desc"
        };
        amountErrorMessage = null;
        dateErrorMessage = null;
        currentPage = 1;
        await SearchOrders();
    }

    // Auto-search event handlers
    private async Task OnSearchTextChanged(string value)
    {
        searchCriteria.SearchTerm = value;
        currentPage = 1;
        await SearchOrders();
    }

    private async Task OnStatusChanged(string? value)
    {
        searchCriteria.Status = value;
        currentPage = 1;
        await SearchOrders();
    }

    private async Task OnMinAmountChanged(decimal? value)
    {
        searchCriteria.MinAmount = value;

        // Validate: MinAmount should not be greater than MaxAmount
        if (value.HasValue && searchCriteria.MaxAmount.HasValue && value.Value > searchCriteria.MaxAmount.Value)
        {
            amountErrorMessage = $"Min amount ({value:N0}) cannot be greater than max amount ({searchCriteria.MaxAmount:N0})";
            await InvokeAsync(StateHasChanged);
            return;
        }

        amountErrorMessage = null;
        currentPage = 1;
        await SearchOrders();
    }

    private async Task OnMaxAmountChanged(decimal? value)
    {
        searchCriteria.MaxAmount = value;

        // Validate: MaxAmount should not be less than MinAmount
        if (value.HasValue && searchCriteria.MinAmount.HasValue && value.Value < searchCriteria.MinAmount.Value)
        {
            amountErrorMessage = $"Max amount ({value:N0}) cannot be less than min amount ({searchCriteria.MinAmount:N0})";
            await InvokeAsync(StateHasChanged);
            return;
        }

        amountErrorMessage = null;
        currentPage = 1;
        await SearchOrders();
    }

    private async Task OnStartDateChanged(DateTime? value)
    {
        searchCriteria.StartDate = value;

        // Validate: StartDate should not be after EndDate
        if (value.HasValue && searchCriteria.EndDate.HasValue && value.Value > searchCriteria.EndDate.Value)
        {
            dateErrorMessage = $"Start date cannot be after end date";
            await InvokeAsync(StateHasChanged);
            return;
        }

        dateErrorMessage = null;
        currentPage = 1;
        await SearchOrders();
    }

    private async Task OnEndDateChanged(DateTime? value)
    {
        searchCriteria.EndDate = value;

        // Validate: EndDate should not be before StartDate
        if (value.HasValue && searchCriteria.StartDate.HasValue && value.Value < searchCriteria.StartDate.Value)
        {
            dateErrorMessage = $"End date cannot be before start date";
            await InvokeAsync(StateHasChanged);
            return;
        }

        dateErrorMessage = null;
        currentPage = 1;
        await SearchOrders();
    }

    private async Task ViewOrder(int orderId)
    {
        selectedOrder = await DbContext.Orders
            .Include(o => o.Customer)
            .Include(o => o.OrderItems)
                .ThenInclude(oi => oi.Product)
            .Include(o => o.Payments)
            .FirstOrDefaultAsync(o => o.OrderId == orderId);

        if (selectedOrder != null)
        {
            showDetailsModal = true;
        }
        else
        {
            ShowToast("Order not found!", "bg-red-600", "fas fa-times");
        }
    }

    private void CloseDetailsModal()
    {
        showDetailsModal = false;
        selectedOrder = null;
    }

    private void NavigateToBill(int orderId)
    {
        NavigationManager.NavigateTo($"/store/orders/{orderId}/bill");
    }

    private string GetStatusClass(string status)
    {
        return status.ToLower() switch
        {
            "pending" => "bg-orange-100 text-orange-800",
            "completed" or "paid" => "bg-green-100 text-green-800",
            "cancelled" or "canceled" => "bg-red-100 text-red-800",
            "processing" => "bg-blue-100 text-blue-800",
            _ => "bg-gray-100 text-gray-800"
        };
    }

    private async Task UpdateOrderStatus(int orderId, string newStatus)
    {
        if (isProcessing) return;

        isProcessing = true;
        try
        {
            var order = await DbContext.Orders.FindAsync(orderId);
            if (order != null)
            {
                var oldStatus = order.Status;
                order.Status = newStatus;
                await DbContext.SaveChangesAsync();
                await LoadOrders();

                var statusText = newStatus switch
                {
                    "processing" => "marked as Processing",
                    "completed" => "completed successfully",
                    _ => $"updated to {newStatus}"
                };

                ShowToast($"Order #ORD-{orderId:D6} {statusText}!", "bg-green-600", "fas fa-check");
            }
        }
        catch (Exception ex)
        {
            ShowToast($"Failed to update order: {ex.Message}", "bg-red-600", "fas fa-times");
        }
        finally
        {
            isProcessing = false;
        }
    }

    private async Task UpdateOrderStatusFromModal(int orderId, string newStatus)
    {
        CloseDetailsModal();
        await UpdateOrderStatus(orderId, newStatus);
    }

    private void CancelOrderFromModal(int orderId)
    {
        CloseDetailsModal();
        CancelOrder(orderId);
    }

    private void CancelOrder(int orderId)
    {
        if (isProcessing) return;

        confirmOrderId = orderId;
        showConfirmModal = true;
    }

    private async Task ConfirmCancel()
    {
        showConfirmModal = false;
        isProcessing = true;

        try
        {
            var order = await DbContext.Orders.FindAsync(confirmOrderId);
            if (order != null)
            {
                order.Status = "cancelled";
                await DbContext.SaveChangesAsync();
                await LoadOrders();
                ShowToast($"Order #ORD-{confirmOrderId:D6} has been cancelled", "bg-orange-600", "fas fa-ban");
            }
        }
        catch (Exception ex)
        {
            ShowToast($"Failed to cancel order: {ex.Message}", "bg-red-600", "fas fa-times");
        }
        finally
        {
            isProcessing = false;
        }
    }

    private void CloseConfirmModal()
    {
        showConfirmModal = false;
    }

    // Create Order Modal
    private bool showCreateOrderModal = false;
    private List<Customer> customers = new();
    private List<Product> products = new();
    private List<Promotion> promotions = new();
    private List<string> promotionTypes = new();
    private int selectedCustomerId = 0;
    private List<OrderItemViewModel> orderItems = new();
    private int selectedProductId = 0;
    private int selectedQuantity = 1;
    private string selectedPromotionType = "";
    private int selectedPromoId = 0;

    private async Task OpenCreateOrderModal()
    {
        showCreateOrderModal = true;
        selectedCustomerId = 0;
        orderItems.Clear();
        selectedProductId = 0;
        selectedQuantity = 1;
        selectedPromotionType = "";
        selectedPromoId = 0;

        // Load customers, products and promotions
        customers = await DbContext.Customers
            .Where(c => c.Status == "active")
            .OrderBy(c => c.Name)
            .ToListAsync();

        products = await DbContext.Products
            .Where(p => p.Status == "active")
            .OrderBy(p => p.ProductName)
            .ToListAsync();

        promotions = await DbContext.Promotions
            .Where(p => p.Status == "active" && p.StartDate <= DateTime.Now && p.EndDate >= DateTime.Now)
            .OrderBy(p => p.PromoCode)
            .ToListAsync();

        // Get distinct apply types from promotions
        promotionTypes = promotions
            .Select(p => p.ApplyType)
            .Distinct()
            .OrderBy(t => t)
            .ToList();

        StateHasChanged();
    }

    private void CloseCreateOrderModal()
    {
        showCreateOrderModal = false;
        orderItems.Clear();
        selectedCustomerId = 0;
    }

    private async Task AddProductToOrder()
    {
        if (selectedProductId <= 0 || selectedQuantity <= 0)
        {
            ShowToast("Vui lòng chọn sản phẩm và số lượng hợp lệ", "bg-orange-600", "fas fa-exclamation-triangle");
            return;
        }

        var product = products.FirstOrDefault(p => p.ProductId == selectedProductId);
        if (product == null)
        {
            ShowToast("Product not found", "bg-red-600", "fas fa-times");
            return;
        }

        // Check if product already in list
        var existingItem = orderItems.FirstOrDefault(i => i.ProductId == selectedProductId);
        if (existingItem != null)
        {
            existingItem.Quantity += selectedQuantity;
        }
        else
        {
            orderItems.Add(new OrderItemViewModel
            {
                ProductId = product.ProductId,
                ProductName = product.ProductName,
                Quantity = selectedQuantity,
                Price = product.Price
            });
        }

        selectedProductId = 0;
        selectedQuantity = 1;
        ShowToast($"Added {product.ProductName}", "bg-green-600", "fas fa-check");
    }

    private void RemoveProduct(int index)
    {
        if (index >= 0 && index < orderItems.Count)
        {
            orderItems.RemoveAt(index);
        }
    }

    private void IncreaseQuantity(int index)
    {
        if (index >= 0 && index < orderItems.Count)
        {
            orderItems[index].Quantity++;
        }
    }

    private void DecreaseQuantity(int index)
    {
        if (index >= 0 && index < orderItems.Count && orderItems[index].Quantity > 1)
        {
            orderItems[index].Quantity--;
        }
    }

    private decimal CalculateSubtotal()
    {
        return orderItems.Sum(i => i.Subtotal);
    }

    private decimal CalculateTotal()
    {
        var subtotal = CalculateSubtotal();

        // Apply promotion discount if selected
        if (selectedPromoId > 0 && promotions != null)
        {
            var promo = promotions.FirstOrDefault(p => p.PromoId == selectedPromoId);
            if (promo != null)
            {
                if (promo.DiscountType == "percent")
                {
                    var discount = subtotal * (promo.DiscountValue / 100);
                    return subtotal - discount;
                }
                else if (promo.DiscountType == "fixed")
                {
                    return Math.Max(0, subtotal - promo.DiscountValue);
                }
            }
        }

        return subtotal;
    }

    private bool CanCreateOrder()
    {
        return selectedCustomerId > 0 && orderItems.Any();
    }

    private IEnumerable<Promotion> GetFilteredPromotions()
    {
        if (promotions == null) return Enumerable.Empty<Promotion>();

        if (string.IsNullOrWhiteSpace(selectedPromotionType))
            return promotions;

        return promotions.Where(p => p.ApplyType == selectedPromotionType);
    }

    private string GetApplyTypeDisplay(string applyType)
    {
        return applyType switch
        {
            "order" => "Order Discount",
            "product" => "Product Discount",
            "combo" => "Combo Discount",
            _ => applyType
        };
    }

    private async Task CreateOrder()
    {
        if (!CanCreateOrder())
        {
            ShowToast("Please select customer and add products", "bg-orange-600", "fas fa-exclamation-triangle");
            return;
        }

        isProcessing = true;
        try
        {
            // Get promo code from selected promotion
            var selectedPromo = selectedPromoId > 0 ? promotions.FirstOrDefault(p => p.PromoId == selectedPromoId) : null;

            var createOrderDto = new CreateOrderDto
            {
                CustomerId = selectedCustomerId,
                PromoCode = selectedPromo?.PromoCode,
                Items = orderItems.Select(i => new OrderItemDto
                {
                    ProductId = i.ProductId,
                    Quantity = i.Quantity
                }).ToList()
            };

            var result = await OrderService.CreateOrderAsync(createOrderDto);
            if (result != null)
            {
                ShowToast($"Order #ORD-{result.OrderId:D6} created successfully!", "bg-green-600", "fas fa-check");
                CloseCreateOrderModal();
                await LoadOrders();
            }
            else
            {
                ShowToast("Unable to create order", "bg-red-600", "fas fa-times");
            }
        }
        catch (Exception ex)
        {
            ShowToast($"Error: {ex.Message}", "bg-red-600", "fas fa-times");
        }
        finally
        {
            isProcessing = false;
        }
    }

    private void ShowToast(string message, string cssClass, string icon)
    {
        toastMessage = message;
        toastClass = cssClass;
        toastIcon = icon;
        showToast = true;

        Task.Delay(3000).ContinueWith(_ =>
        {
            showToast = false;
            InvokeAsync(StateHasChanged);
        });
    }
}

