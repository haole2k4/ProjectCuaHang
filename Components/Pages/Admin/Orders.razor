@page "/admin/orders"
@rendermode InteractiveServer

@using StoreManagementAPI.Data
@using StoreManagementAPI.Models
@using StoreManagementAPI.DTOs
@using StoreManagementAPI.Services
@using Microsoft.EntityFrameworkCore
@using Blazorise

@inject StoreDbContext DbContext
@inject NavigationManager NavigationManager
@inject IOrderService OrderService

<PageTitle>Orders - Admin</PageTitle>

<div class="flex justify-between items-center mb-6">
    <div>
        <Heading Size="HeadingSize.Is3" class="text-gray-900 font-bold">Orders</Heading>
        <Paragraph class="text-gray-600 mb-0">Manage customer orders</Paragraph>
    </div>
    <div class="flex gap-3">
        <Button Color="Color.Light" class="!bg-white !border-2 !border-gray-300 !text-gray-900 hover:!bg-gray-100 shadow-sm">
            <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.Filter" class="mr-2" /> Filter
        </Button>
        <Button Color="Color.Light" class="!bg-white !border-2 !border-gray-300 !text-gray-900 hover:!bg-gray-100 shadow-sm">
            <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.Download" class="mr-2" /> Export
        </Button>
    </div>
</div>

<!-- Stats Cards -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
    <Card class="shadow-md border-0 !bg-white">
        <CardBody class="p-6">
            <div class="flex items-center justify-between">
                <div>
                    <Paragraph class="text-gray-600 text-sm mb-1">Total Orders</Paragraph>
                    <Heading Size="HeadingSize.Is3" class="text-gray-900 mb-0">@orders?.Count</Heading>
                </div>
                <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
                    <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.ShoppingBag" class="text-blue-600 text-xl" />
                </div>
            </div>
        </CardBody>
    </Card>

    <Card class="shadow-md border-0 !bg-white">
        <CardBody class="p-6">
            <div class="flex items-center justify-between">
                <div>
                    <Paragraph class="text-gray-600 text-sm mb-1">Pending</Paragraph>
                    <Heading Size="HeadingSize.Is3" class="text-orange-600 mb-0">@orders?.Count(o => o.Status == "pending")</Heading>
                </div>
                <div class="w-12 h-12 bg-orange-100 rounded-xl flex items-center justify-center">
                    <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.Clock" class="text-orange-600 text-xl" />
                </div>
            </div>
        </CardBody>
    </Card>

    <Card class="shadow-md border-0 !bg-white">
        <CardBody class="p-6">
            <div class="flex items-center justify-between">
                <div>
                    <Paragraph class="text-gray-600 text-sm mb-1">Completed</Paragraph>
                    <Heading Size="HeadingSize.Is3" class="text-green-600 mb-0">@orders?.Count(o => o.Status == "completed" || o.Status == "paid")</Heading>
                </div>
                <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">
                    <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.CheckCircle" class="text-green-600 text-xl" />
                </div>
            </div>
        </CardBody>
    </Card>

    <Card class="shadow-md border-0 !bg-white">
        <CardBody class="p-6">
            <div class="flex items-center justify-between">
                <div>
                    <Paragraph class="text-gray-600 text-sm mb-1">Revenue</Paragraph>
                    <Heading Size="HeadingSize.Is3" class="text-gray-900 mb-0">$@(orders?.Sum(o => o.TotalAmount).ToString("N0") ?? "0")</Heading>
                </div>
                <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center">
                    <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.DollarSign" class="text-purple-600 text-xl" />
                </div>
            </div>
        </CardBody>
    </Card>
</div>

<!-- Advanced Search Panel -->
<Card class="!bg-white shadow-md border border-gray-200 rounded-xl overflow-hidden mb-6">
    <CardBody>
        <div class="flex items-center justify-between mb-4">
            <Heading Size="HeadingSize.Is5" class="text-gray-900 font-bold mb-0">
                <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.Search" class="mr-2" />
                Search & Filter Orders
            </Heading>
            <Button Color="Color.Light" Size="Size.Small" Clicked="ClearFilters" class="!border !border-gray-300">
                <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.Redo" class="mr-1" /> Clear
            </Button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <!-- Search Term -->
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Order ID / Customer</label>
                <TextEdit Text="@searchCriteria.SearchTerm"
                          TextChanged="@OnSearchTextChanged"
                          Placeholder="Search..."
                          class="w-full !border-gray-300" />
            </div>

            <!-- Status Filter -->
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Status</label>
                <Select TValue="string?"
                        SelectedValue="searchCriteria.Status"
                        SelectedValueChanged="@OnStatusChanged"
                        class="w-full !border-gray-300">
                    <SelectItem Value="@((string?)null)">All Status</SelectItem>
                    <SelectItem Value="@("pending")">Pending</SelectItem>
                    <SelectItem Value="@("completed")">Completed</SelectItem>
                    <SelectItem Value="@("paid")">Paid</SelectItem>
                    <SelectItem Value="@("cancelled")">Cancelled</SelectItem>
                </Select>
            </div>

            <!-- Amount Range -->
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Amount Range</label>
                <div class="grid grid-cols-2 gap-2">
                    <NumericEdit TValue="decimal?"
                                 Value="searchCriteria.MinAmount"
                                 ValueChanged="@OnMinAmountChanged"
                                 Placeholder="Min"
                                 class="w-full !border-gray-300"
                                 Decimals="0" />
                    <NumericEdit TValue="decimal?"
                                 Value="searchCriteria.MaxAmount"
                                 ValueChanged="@OnMaxAmountChanged"
                                 Placeholder="Max"
                                 class="w-full !border-gray-300"
                                 Decimals="0" />
                </div>
                @if (!string.IsNullOrEmpty(amountErrorMessage))
                {
                    <div class="mt-2 text-red-600 text-sm font-semibold">
                        <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.ExclamationTriangle" class="mr-1" />
                        @amountErrorMessage
                    </div>
                }
            </div>

            <!-- Date Range -->
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Date Range</label>
                <div class="grid grid-cols-2 gap-2">
                    <DateEdit TValue="DateTime?"
                              Date="searchCriteria.StartDate"
                              DateChanged="@OnStartDateChanged"
                              Placeholder="Start"
                              class="w-full !border-gray-300" />
                    <DateEdit TValue="DateTime?"
                              Date="searchCriteria.EndDate"
                              DateChanged="@OnEndDateChanged"
                              Placeholder="End"
                              class="w-full !border-gray-300" />
                </div>
                @if (!string.IsNullOrEmpty(dateErrorMessage))
                {
                    <div class="mt-2 text-red-600 text-sm font-semibold">
                        <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.ExclamationTriangle" class="mr-1" />
                        @dateErrorMessage
                    </div>
                }
            </div>
        </div>

        @if (searchResult != null)
        {
            <div class="mt-4 pt-4 border-t border-gray-200">
                <span class="text-gray-600">
                    Found <span class="font-bold text-blue-600">@searchResult.TotalCount</span> orders
                </span>
            </div>
        }
    </CardBody>
</Card>

<!-- Orders Table -->
<Card class="!bg-white shadow-xl border border-gray-200 rounded-xl overflow-hidden">
    <CardBody Padding="Padding.Is0">
        <div class="overflow-x-auto">
            <Table class="mb-0 w-full">
                <TableHeader>
                    <TableRow class="bg-white border-b-2 border-gray-200">
                        <TableHeaderCell class="px-6 py-4 text-center text-gray-900 font-bold text-sm uppercase tracking-wider">Order
                            ID</TableHeaderCell>
                        <TableHeaderCell class="px-6 py-4 text-center text-gray-900 font-bold text-sm uppercase tracking-wider">
                            Customer</TableHeaderCell>
                        <TableHeaderCell class="px-6 py-4 text-center text-gray-900 font-bold text-sm uppercase tracking-wider">
                            Date</TableHeaderCell>
                        <TableHeaderCell class="px-6 py-4 text-center text-gray-900 font-bold text-sm uppercase tracking-wider">
                            Status</TableHeaderCell>
                        <TableHeaderCell class="px-6 py-4 text-center text-gray-900 font-bold text-sm uppercase tracking-wider">
                            Amount</TableHeaderCell>
                        <TableHeaderCell class="px-6 py-4 text-center text-gray-900 font-bold text-sm uppercase tracking-wider">
                            Actions</TableHeaderCell>
                    </TableRow>
                </TableHeader>
                <TableBody class="bg-white divide-y divide-gray-200">
                    @if (orders != null && orders.Any())
                    {
                        @foreach (var order in orders)
                        {
                            <TableRow class="bg-white hover:bg-gray-100 transition-colors duration-150">
                                <TableRowCell class="px-6 py-4 text-center">
                                    <span class="font-bold text-gray-900">#ORD-@order.OrderId.ToString("D6")</span>
                                </TableRowCell>
                                <TableRowCell class="px-6 py-4 text-center">
                                    <div class="flex items-center gap-3">
                                        <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-white text-xs font-bold shadow-md">
                                            @(order.Customer?.Name?.Substring(0, 1).ToUpper() ?? "G")
                                        </div>
                                        <span class="text-gray-900 font-medium">@(order.Customer?.Name ?? "Guest")</span>
                                    </div>
                                </TableRowCell>
                                <TableRowCell class="px-6 py-4 text-center">
                                    <span class="text-gray-900">@order.OrderDate.ToString("dd/MM/yyyy")</span>
                                </TableRowCell>
                                <TableRowCell class="px-6 py-4 text-center">
                                    @{
                                        var statusClass = order.Status.ToLower() switch
                                        {
                                            "pending" => "bg-orange-100 text-orange-800",
                                            "completed" or "paid" => "bg-green-100 text-green-800",
                                            "cancelled" or "canceled" => "bg-red-100 text-red-800",
                                            "processing" => "bg-blue-100 text-blue-800",
                                            _ => "bg-gray-100 text-gray-800"
                                        };
                                    }
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-semibold @statusClass">
                                        @order.Status
                                    </span>
                                </TableRowCell>
                                <TableRowCell class="px-6 py-4 text-center">
                                    <span class="font-bold text-gray-900">$@order.TotalAmount.ToString("N2")</span>
                                </TableRowCell>
                                <TableRowCell class="px-6 py-4 text-right">
                                    <div class="flex gap-2 justify-end">
                                        <button @onclick="() => ViewOrder(order.OrderId)"
                                                class="px-3 py-1.5 bg-blue-50 text-blue-600 hover:bg-blue-100 border border-blue-200 rounded-lg transition text-sm font-medium flex items-center gap-1.5">
                                            <i class="fas fa-eye"></i>
                                            <span>View</span>
                                        </button>
                                        @if (order.Status.ToLower() == "pending")
                                        {
                                            <button @onclick='() => UpdateOrderStatus(order.OrderId, "processing")'
                                                    class="px-3 py-1.5 bg-blue-600 text-white hover:bg-blue-700 rounded-lg transition text-sm font-medium flex items-center gap-1.5">
                                                <i class="fas fa-check"></i>
                                                <span>Process</span>
                                            </button>
                                        }
                                        @if (order.Status.ToLower() == "processing")
                                        {
                                            <button @onclick='() => UpdateOrderStatus(order.OrderId, "completed")'
                                                    class="px-3 py-1.5 bg-green-600 text-white hover:bg-green-700 rounded-lg transition text-sm font-medium flex items-center gap-1.5">
                                                <i class="fas fa-check-circle"></i>
                                                <span>Complete</span>
                                            </button>
                                        }
                                        @if (order.Status.ToLower() != "cancelled" && order.Status.ToLower() != "completed")
                                        {
                                            <button @onclick="() => CancelOrder(order.OrderId)"
                                                    class="px-3 py-1.5 bg-red-50 text-red-600 hover:bg-red-100 border border-red-200 rounded-lg transition text-sm font-medium flex items-center gap-1.5">
                                                <i class="fas fa-times"></i>
                                                <span>Cancel</span>
                                            </button>
                                        }
                                    </div>
                                </TableRowCell>
                            </TableRow>
                        }
                    }
                    else
                    {
                        <TableRow class="bg-white">
                            <TableRowCell ColumnSpan="6" class="text-center py-12">
                                <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.ShoppingBag" class="text-gray-400 text-4xl mb-3" />
                                <p class="text-gray-600 font-medium">No orders found</p>
                            </TableRowCell>
                        </TableRow>
                    }
                </TableBody>
            </Table>
        </div>
        
        <PaginationComponent CurrentPage="@currentPage" PageSize="@pageSize" TotalItems="@totalItems" OnPageChanged="@HandlePageChanged" />
    </CardBody>
</Card>

<!-- Toast Notification -->
@if (showToast)
{
    <div class="fixed bottom-6 right-6 z-50 animate-slide-up">
        <div class="@toastClass text-white px-6 py-4 rounded-xl shadow-2xl flex items-center gap-3 max-w-md">
            <div class="flex-shrink-0">
                <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center">
                    <i class="@toastIcon text-lg"></i>
                </div>
            </div>
            <div class="flex-1">
                <p class="font-semibold">@toastMessage</p>
            </div>
            <button @onclick="() => showToast = false"
                    class="flex-shrink-0 text-white/80 hover:text-white transition">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>
}

<!-- Order Details Modal -->
@if (showDetailsModal && selectedOrder != null)
{
    <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4" @onclick="CloseDetailsModal">
        <div class="bg-white rounded-xl shadow-2xl max-w-3xl w-full max-h-[90vh] border border-gray-200 flex flex-col" @onclick:stopPropagation>
            <!-- Header - Fixed -->
            <div class="bg-white border-b-2 border-black px-6 py-4 rounded-t-xl flex-shrink-0">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-xl font-bold text-black">Order Details</h3>
                        <p class="text-gray-600 text-sm">#ORD-@selectedOrder.OrderId.ToString("D6")</p>
                    </div>
                    <button @onclick="CloseDetailsModal"
                            class="w-8 h-8 bg-gray-100 hover:bg-gray-200 rounded-lg flex items-center justify-center transition">
                        <i class="fas fa-times text-black"></i>
                    </button>
                </div>
            </div>

            <!-- Content - Scrollable -->
            <div class="p-6 space-y-5 overflow-y-auto flex-1">
                <!-- Customer & Order Info -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="border border-gray-300 rounded-lg p-4 bg-white">
                        <h4 class="text-xs font-bold text-gray-700 uppercase mb-3">Customer Information</h4>
                        <div class="space-y-2">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-gray-900 rounded-full flex items-center justify-center text-white font-bold text-sm">
                                    @(selectedOrder.Customer?.Name?.Substring(0, 1).ToUpper() ?? "G")
                                </div>
                                <div>
                                    <p class="font-bold text-black text-sm">@(selectedOrder.Customer?.Name ?? "Guest Customer")</p>
                                    <p class="text-xs text-gray-600">@(selectedOrder.Customer?.Email ?? "N/A")</p>
                                </div>
                            </div>
                            <div class="pt-2 border-t border-gray-200 space-y-1">
                                <p class="text-xs text-black"><i class="fas fa-phone w-4 text-gray-600"></i> @(selectedOrder.Customer?.Phone ?? "N/A")</p>
                                <p class="text-xs text-black"><i class="fas fa-map-marker-alt w-4 text-gray-600"></i> @(selectedOrder.Customer?.Address ?? "N/A")</p>
                            </div>
                        </div>
                    </div>

                    <div class="border border-gray-300 rounded-lg p-4 bg-white">
                        <h4 class="text-xs font-bold text-gray-700 uppercase mb-3">Order Information</h4>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Order Date:</span>
                                <span class="font-semibold text-black">@selectedOrder.OrderDate.ToString("MMM dd, yyyy HH:mm")</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Status:</span>
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold @GetStatusClass(selectedOrder.Status)">
                                    @selectedOrder.Status.ToUpper()
                                </span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Payment:</span>
                                <span class="font-semibold text-black">@(selectedOrder.Payments?.FirstOrDefault()?.PaymentMethod ?? "N/A")</span>
                            </div>
                            @if (selectedOrder.Payments != null && selectedOrder.Payments.Any())
                            {
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Payment Date:</span>
                                    <span class="font-semibold text-black">@selectedOrder.Payments.First().PaymentDate.ToString("MMM dd, yyyy HH:mm")</span>
                                </div>
                            }
                        </div>
                    </div>
                </div>

                <!-- Order Items -->
                <div>
                    <h4 class="text-xs font-bold text-gray-700 uppercase mb-3">Order Items</h4>
                    <div class="border border-gray-300 rounded-lg overflow-hidden">
                        <table class="w-full">
                            <thead class="bg-gray-100 border-b border-gray-300">
                                <tr>
                                    <th class="px-4 py-2 text-left text-xs font-bold text-black uppercase">Product</th>
                                    <th class="px-4 py-2 text-center text-xs font-bold text-black uppercase">Qty</th>
                                    <th class="px-4 py-2 text-right text-xs font-bold text-black uppercase">Price</th>
                                    <th class="px-4 py-2 text-right text-xs font-bold text-black uppercase">Total</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                @if (selectedOrder.OrderItems != null && selectedOrder.OrderItems.Any())
                                {
                                    @foreach (var item in selectedOrder.OrderItems)
                                    {
                                        <tr class="bg-white">
                                            <td class="px-4 py-3">
                                                <div class="flex items-center gap-2">
                                                    @if (!string.IsNullOrEmpty(item.Product?.ImageUrl))
                                                    {
                                                        <img src="@item.Product.ImageUrl" alt="@item.Product.ProductName" class="w-10 h-10 object-cover rounded-lg border border-gray-200" />
                                                    }
                                                    else
                                                    {
                                                        <div class="w-10 h-10 bg-gray-200 rounded-lg flex items-center justify-center">
                                                            <i class="fas fa-box text-gray-500 text-sm"></i>
                                                        </div>
                                                    }
                                                    <div>
                                                        <p class="font-semibold text-black text-sm">@(item.Product?.ProductName ?? "Unknown Product")</p>
                                                        <p class="text-xs text-gray-500">@(item.Product?.Barcode ?? "")</p>
                                                    </div>
                                                </div>
                                            </td>
                                            <td class="px-4 py-3 text-center">
                                                <span class="inline-flex items-center justify-center w-7 h-7 bg-gray-200 text-black rounded-md font-semibold text-xs">
                                                    @item.Quantity
                                                </span>
                                            </td>
                                            <td class="px-4 py-3 text-right font-medium text-black text-sm">$@item.Price.ToString("N2")</td>
                                            <td class="px-4 py-3 text-right font-bold text-black text-sm">$@item.Subtotal.ToString("N2")</td>
                                        </tr>
                                    }
                                }
                                else
                                {
                                    <tr>
                                        <td colspan="4" class="px-4 py-8 text-center text-gray-500 text-sm">No items found</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Order Summary -->
                <div class="border-2 border-gray-300 rounded-lg p-4 bg-gray-50">
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between text-black">
                            <span>Subtotal:</span>
                            <span class="font-medium">$@selectedOrder.TotalAmount.ToString("N2")</span>
                        </div>
                        <div class="flex justify-between text-black">
                            <span>Tax:</span>
                            <span class="font-medium">$0.00</span>
                        </div>
                        <div class="flex justify-between text-black">
                            <span>Shipping:</span>
                            <span class="font-medium">$0.00</span>
                        </div>
                        <div class="border-t-2 border-gray-400 pt-2 mt-2">
                            <div class="flex justify-between items-center">
                                <span class="text-base font-bold text-black">Total Amount:</span>
                                <span class="text-xl font-bold text-black">$@selectedOrder.TotalAmount.ToString("N2")</span>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Footer - Fixed -->
            <div class="border-t border-gray-300 px-6 py-4 bg-white rounded-b-xl flex-shrink-0">
                <div class="flex justify-between items-center">
                    <button @onclick='() => NavigateToBill(selectedOrder.OrderId)'
                            class="px-4 py-2 bg-gray-900 hover:bg-black text-white text-sm font-semibold rounded-lg transition">
                        <i class="fas fa-print mr-1"></i> Print Invoice
                    </button>
                    <div class="flex gap-2">
                        @if (selectedOrder.Status.ToLower() == "pending")
                        {
                            <button @onclick='() => UpdateOrderStatusFromModal(selectedOrder.OrderId, "processing")'
                                    class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold rounded-lg transition">
                                <i class="fas fa-check mr-1"></i> Process
                            </button>
                        }
                        @if (selectedOrder.Status.ToLower() == "processing")
                        {
                            <button @onclick='() => UpdateOrderStatusFromModal(selectedOrder.OrderId, "completed")'
                                    class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white text-sm font-semibold rounded-lg transition">
                                <i class="fas fa-check-circle mr-1"></i> Complete
                            </button>
                        }
                        @if (selectedOrder.Status.ToLower() != "cancelled" && selectedOrder.Status.ToLower() != "completed")
                        {
                            <button @onclick="() => CancelOrderFromModal(selectedOrder.OrderId)"
                                    class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white text-sm font-semibold rounded-lg transition">
                                <i class="fas fa-times mr-1"></i> Cancel
                            </button>
                        }
                        <button @onclick="CloseDetailsModal"
                                class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-900 text-sm font-semibold rounded-lg transition">
                            Close
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

<!-- Confirmation Modal -->
@if (showConfirmModal)
{
    <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm" @onclick="CloseConfirmModal">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 overflow-hidden" @onclick:stopPropagation>
            <div class="p-6">
                <div class="flex items-center gap-4 mb-4">
                    <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-gray-900">Confirm Cancellation</h3>
                        <p class="text-gray-600 text-sm">This action cannot be undone</p>
                    </div>
                </div>
                <p class="text-gray-700 mb-6">
                    Are you sure you want to cancel Order <span class="font-bold">#ORD-@confirmOrderId.ToString("D6")</span>?
                </p>
                <div class="flex gap-3">
                    <button @onclick="CloseConfirmModal"
                            class="flex-1 px-4 py-2.5 border-2 border-gray-300 text-gray-700 font-semibold rounded-lg hover:bg-gray-50 transition">
                        No, Keep Order
                    </button>
                    <button @onclick="ConfirmCancel"
                            class="flex-1 px-4 py-2.5 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg transition">
                        Yes, Cancel Order
                    </button>
                </div>
            </div>
        </div>
    </div>
}

<style>
    @@keyframes slide-up {
        from {
            transform: translateY(100%);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    .animate-slide-up {
        animation: slide-up 0.3s ease-out;
    }
</style>

@code {
    private List<Order>? allOrders;
    private List<Order>? orders;
    private bool isProcessing;
    private bool showToast;
    private string toastMessage = "";
    private string toastClass = "";
    private string toastIcon = "";
    private bool showConfirmModal;
    private int confirmOrderId;
    private bool showDetailsModal;
    private Order? selectedOrder;
    private string? amountErrorMessage;
    private string? dateErrorMessage;

    // Pagination
    private int currentPage = 1;
    private int pageSize = 10;
    private int totalItems = 0;

    // Search & Filter
    private OrderSearchDto searchCriteria = new OrderSearchDto
    {
        PageNumber = 1,
        PageSize = 10,
        SortBy = "OrderDate",
        SortDirection = "desc"
    };
    private OrderSearchResultDto? searchResult;

    protected override async Task OnInitializedAsync()
    {
        await LoadOrders();
        await SearchOrders();
    }

    private async Task LoadOrders()
    {
        allOrders = await DbContext.Orders
            .Include(o => o.Customer)
            .OrderByDescending(o => o.OrderDate)
            .ToListAsync();
        
        totalItems = allOrders?.Count ?? 0;
        UpdatePagedData();
    }

    private async Task SearchOrders()
    {
        try
        {
            searchCriteria.PageNumber = currentPage;
            searchCriteria.PageSize = pageSize;

            searchResult = await OrderService.SearchOrdersAdvancedAsync(searchCriteria);

            // Convert OrderResponseDto to Order for compatibility
            allOrders = await DbContext.Orders
                .Include(o => o.Customer)
                .Where(o => searchResult.Orders.Select(x => x.OrderId).Contains(o.OrderId))
                .ToListAsync();

            orders = allOrders;
            totalItems = searchResult.TotalCount;

            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            ShowToast($"Error searching orders: {ex.Message}", "bg-red-600", "fas fa-times");
        }
    }

    private void UpdatePagedData()
    {
        if (allOrders != null)
        {
            orders = allOrders
                .Skip((currentPage - 1) * pageSize)
                .Take(pageSize)
                .ToList();
        }
    }

    private async Task HandlePageChanged(int page)
    {
        currentPage = page;
        await SearchOrders();
    }

    private async Task ClearFilters()
    {
        searchCriteria = new OrderSearchDto
        {
            PageNumber = 1,
            PageSize = pageSize,
            SortBy = "OrderDate",
            SortDirection = "desc"
        };
        amountErrorMessage = null;
        dateErrorMessage = null;
        currentPage = 1;
        await SearchOrders();
    }

    // Auto-search event handlers
    private async Task OnSearchTextChanged(string value)
    {
        searchCriteria.SearchTerm = value;
        currentPage = 1;
        await SearchOrders();
    }

    private async Task OnStatusChanged(string? value)
    {
        searchCriteria.Status = value;
        currentPage = 1;
        await SearchOrders();
    }

    private async Task OnMinAmountChanged(decimal? value)
    {
        searchCriteria.MinAmount = value;
        
        // Validate: MinAmount should not be greater than MaxAmount
        if (value.HasValue && searchCriteria.MaxAmount.HasValue && value.Value > searchCriteria.MaxAmount.Value)
        {
            amountErrorMessage = $"Min amount ({value:N0}) cannot be greater than max amount ({searchCriteria.MaxAmount:N0})";
            await InvokeAsync(StateHasChanged);
            return;
        }
        
        amountErrorMessage = null;
        currentPage = 1;
        await SearchOrders();
    }

    private async Task OnMaxAmountChanged(decimal? value)
    {
        searchCriteria.MaxAmount = value;
        
        // Validate: MaxAmount should not be less than MinAmount
        if (value.HasValue && searchCriteria.MinAmount.HasValue && value.Value < searchCriteria.MinAmount.Value)
        {
            amountErrorMessage = $"Max amount ({value:N0}) cannot be less than min amount ({searchCriteria.MinAmount:N0})";
            await InvokeAsync(StateHasChanged);
            return;
        }
        
        amountErrorMessage = null;
        currentPage = 1;
        await SearchOrders();
    }

    private async Task OnStartDateChanged(DateTime? value)
    {
        searchCriteria.StartDate = value;
        
        // Validate: StartDate should not be after EndDate
        if (value.HasValue && searchCriteria.EndDate.HasValue && value.Value > searchCriteria.EndDate.Value)
        {
            dateErrorMessage = $"Start date cannot be after end date";
            await InvokeAsync(StateHasChanged);
            return;
        }
        
        dateErrorMessage = null;
        currentPage = 1;
        await SearchOrders();
    }

    private async Task OnEndDateChanged(DateTime? value)
    {
        searchCriteria.EndDate = value;
        
        // Validate: EndDate should not be before StartDate
        if (value.HasValue && searchCriteria.StartDate.HasValue && value.Value < searchCriteria.StartDate.Value)
        {
            dateErrorMessage = $"End date cannot be before start date";
            await InvokeAsync(StateHasChanged);
            return;
        }
        
        dateErrorMessage = null;
        currentPage = 1;
        await SearchOrders();
    }

    private async Task ViewOrder(int orderId)
    {
        selectedOrder = await DbContext.Orders
            .Include(o => o.Customer)
            .Include(o => o.OrderItems)
                .ThenInclude(oi => oi.Product)
            .Include(o => o.Payments)
            .FirstOrDefaultAsync(o => o.OrderId == orderId);

        if (selectedOrder != null)
        {
            showDetailsModal = true;
        }
        else
        {
            ShowToast("Order not found!", "bg-red-600", "fas fa-times");
        }
    }

    private void CloseDetailsModal()
    {
        showDetailsModal = false;
        selectedOrder = null;
    }

    private void NavigateToBill(int orderId)
    {
        NavigationManager.NavigateTo($"/store/orders/{orderId}/bill");
    }

    private string GetStatusClass(string status)
    {
        return status.ToLower() switch
        {
            "pending" => "bg-orange-100 text-orange-800",
            "completed" or "paid" => "bg-green-100 text-green-800",
            "cancelled" or "canceled" => "bg-red-100 text-red-800",
            "processing" => "bg-blue-100 text-blue-800",
            _ => "bg-gray-100 text-gray-800"
        };
    }

    private async Task UpdateOrderStatus(int orderId, string newStatus)
    {
        if (isProcessing) return;

        isProcessing = true;
        try
        {
            var order = await DbContext.Orders.FindAsync(orderId);
            if (order != null)
            {
                var oldStatus = order.Status;
                order.Status = newStatus;
                await DbContext.SaveChangesAsync();
                await LoadOrders();

                var statusText = newStatus switch
                {
                    "processing" => "marked as Processing",
                    "completed" => "completed successfully",
                    _ => $"updated to {newStatus}"
                };

                ShowToast($"Order #ORD-{orderId:D6} {statusText}!", "bg-green-600", "fas fa-check");
            }
        }
        catch (Exception ex)
        {
            ShowToast($"Failed to update order: {ex.Message}", "bg-red-600", "fas fa-times");
        }
        finally
        {
            isProcessing = false;
        }
    }

    private async Task UpdateOrderStatusFromModal(int orderId, string newStatus)
    {
        CloseDetailsModal();
        await UpdateOrderStatus(orderId, newStatus);
    }

    private void CancelOrderFromModal(int orderId)
    {
        CloseDetailsModal();
        CancelOrder(orderId);
    }

    private void CancelOrder(int orderId)
    {
        if (isProcessing) return;

        confirmOrderId = orderId;
        showConfirmModal = true;
    }

    private async Task ConfirmCancel()
    {
        showConfirmModal = false;
        isProcessing = true;

        try
        {
            var order = await DbContext.Orders.FindAsync(confirmOrderId);
            if (order != null)
            {
                order.Status = "cancelled";
                await DbContext.SaveChangesAsync();
                await LoadOrders();
                ShowToast($"Order #ORD-{confirmOrderId:D6} has been cancelled", "bg-orange-600", "fas fa-ban");
            }
        }
        catch (Exception ex)
        {
            ShowToast($"Failed to cancel order: {ex.Message}", "bg-red-600", "fas fa-times");
        }
        finally
        {
            isProcessing = false;
        }
    }

    private void CloseConfirmModal()
    {
        showConfirmModal = false;
    }

    private void ShowToast(string message, string cssClass, string icon)
    {
        toastMessage = message;
        toastClass = cssClass;
        toastIcon = icon;
        showToast = true;

        Task.Delay(3000).ContinueWith(_ =>
        {
            showToast = false;
            InvokeAsync(StateHasChanged);
        });
    }
}
