@page "/admin/orders"
@rendermode InteractiveServer

@using StoreManagementAPI.Data
@using StoreManagementAPI.Models
@using Microsoft.EntityFrameworkCore
@using Blazorise

@inject StoreDbContext DbContext

<PageTitle>Orders - Admin</PageTitle>

<div class="flex justify-between items-center mb-6">
    <div>
        <Heading Size="HeadingSize.Is3" class="text-gray-900 font-bold">Orders</Heading>
        <Paragraph class="text-gray-600 mb-0">Manage customer orders</Paragraph>
    </div>
    <div class="flex gap-3">
        <Button Color="Color.Light" class="!bg-white !border-2 !border-gray-300 !text-gray-900 hover:!bg-gray-100 shadow-sm">
            <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.Filter" class="mr-2" /> Filter
        </Button>
        <Button Color="Color.Light" class="!bg-white !border-2 !border-gray-300 !text-gray-900 hover:!bg-gray-100 shadow-sm">
            <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.Download" class="mr-2" /> Export
        </Button>
    </div>
</div>

<!-- Stats Cards -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
    <Card class="shadow-md border-0 !bg-white">
        <CardBody class="p-6">
            <div class="flex items-center justify-between">
                <div>
                    <Paragraph class="text-gray-600 text-sm mb-1">Total Orders</Paragraph>
                    <Heading Size="HeadingSize.Is3" class="text-gray-900 mb-0">@orders?.Count</Heading>
                </div>
                <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
                    <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.ShoppingBag" class="text-blue-600 text-xl" />
                </div>
            </div>
        </CardBody>
    </Card>

    <Card class="shadow-md border-0 !bg-white">
        <CardBody class="p-6">
            <div class="flex items-center justify-between">
                <div>
                    <Paragraph class="text-gray-600 text-sm mb-1">Pending</Paragraph>
                    <Heading Size="HeadingSize.Is3" class="text-orange-600 mb-0">@orders?.Count(o => o.Status == "pending")</Heading>
                </div>
                <div class="w-12 h-12 bg-orange-100 rounded-xl flex items-center justify-center">
                    <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.Clock" class="text-orange-600 text-xl" />
                </div>
            </div>
        </CardBody>
    </Card>

    <Card class="shadow-md border-0 !bg-white">
        <CardBody class="p-6">
            <div class="flex items-center justify-between">
                <div>
                    <Paragraph class="text-gray-600 text-sm mb-1">Completed</Paragraph>
                    <Heading Size="HeadingSize.Is3" class="text-green-600 mb-0">@orders?.Count(o => o.Status == "completed" || o.Status == "paid")</Heading>
                </div>
                <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">
                    <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.CheckCircle" class="text-green-600 text-xl" />
                </div>
            </div>
        </CardBody>
    </Card>

    <Card class="shadow-md border-0 !bg-white">
        <CardBody class="p-6">
            <div class="flex items-center justify-between">
                <div>
                    <Paragraph class="text-gray-600 text-sm mb-1">Revenue</Paragraph>
                    <Heading Size="HeadingSize.Is3" class="text-gray-900 mb-0">$@(orders?.Sum(o => o.TotalAmount).ToString("N0") ?? "0")</Heading>
                </div>
                <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center">
                    <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.DollarSign" class="text-purple-600 text-xl" />
                </div>
            </div>
        </CardBody>
    </Card>
</div>

<!-- Orders Table -->
<Card class="!bg-white shadow-xl border border-gray-200 rounded-xl overflow-hidden">
    <CardBody Padding="Padding.Is0">
        <div class="overflow-x-auto">
            <Table class="mb-0 w-full">
                <TableHeader>
                    <TableRow class="bg-white border-b-2 border-gray-200">
                        <TableHeaderCell class="px-6 py-4 text-center text-gray-900 font-bold text-sm uppercase tracking-wider">Order
                            ID</TableHeaderCell>
                        <TableHeaderCell class="px-6 py-4 text-center text-gray-900 font-bold text-sm uppercase tracking-wider">
                            Customer</TableHeaderCell>
                        <TableHeaderCell class="px-6 py-4 text-center text-gray-900 font-bold text-sm uppercase tracking-wider">
                            Date</TableHeaderCell>
                        <TableHeaderCell class="px-6 py-4 text-center text-gray-900 font-bold text-sm uppercase tracking-wider">
                            Status</TableHeaderCell>
                        <TableHeaderCell class="px-6 py-4 text-center text-gray-900 font-bold text-sm uppercase tracking-wider">
                            Amount</TableHeaderCell>
                        <TableHeaderCell class="px-6 py-4 text-center text-gray-900 font-bold text-sm uppercase tracking-wider">
                            Actions</TableHeaderCell>
                    </TableRow>
                </TableHeader>
                <TableBody class="bg-white divide-y divide-gray-200">
                    @if (orders != null && orders.Any())
                    {
                        @foreach (var order in orders)
                        {
                            <TableRow class="bg-white hover:bg-gray-100 transition-colors duration-150">
                                <TableRowCell class="px-6 py-4 text-center">
                                    <span class="font-bold text-gray-900">#ORD-@order.OrderId.ToString("D6")</span>
                                </TableRowCell>
                                <TableRowCell class="px-6 py-4 text-center">
                                    <div class="flex items-center gap-3">
                                        <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-white text-xs font-bold shadow-md">
                                            @(order.Customer?.Name?.Substring(0, 1).ToUpper() ?? "G")
                                        </div>
                                        <span class="text-gray-900 font-medium">@(order.Customer?.Name ?? "Guest")</span>
                                    </div>
                                </TableRowCell>
                                <TableRowCell class="px-6 py-4 text-center">
                                    <span class="text-gray-900">@order.OrderDate.ToString("MMM dd, yyyy")</span>
                                </TableRowCell>
                                <TableRowCell class="px-6 py-4 text-center">
                                    @{
                                        var statusClass = order.Status.ToLower() switch
                                        {
                                            "pending" => "bg-orange-100 text-orange-800",
                                            "completed" or "paid" => "bg-green-100 text-green-800",
                                            "cancelled" or "canceled" => "bg-red-100 text-red-800",
                                            "processing" => "bg-blue-100 text-blue-800",
                                            _ => "bg-gray-100 text-gray-800"
                                        };
                                    }
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-semibold @statusClass">
                                        @order.Status
                                    </span>
                                </TableRowCell>
                                <TableRowCell class="px-6 py-4 text-right">
                                    <span class="font-bold text-gray-900">$@order.TotalAmount.ToString("N2")</span>
                                </TableRowCell>
                                <TableRowCell class="px-6 py-4 text-right">
                                    <div class="flex gap-2 justify-end">
                                        <button @onclick="() => ViewOrder(order.OrderId)"
                                                class="px-3 py-1.5 bg-blue-50 text-blue-600 hover:bg-blue-100 border border-blue-200 rounded-lg transition text-sm font-medium flex items-center gap-1.5">
                                            <i class="fas fa-eye"></i>
                                            <span>View</span>
                                        </button>
                                        @if (order.Status.ToLower() == "pending")
                                        {
                                            <button @onclick='() => UpdateOrderStatus(order.OrderId, "processing")'
                                                    class="px-3 py-1.5 bg-blue-600 text-white hover:bg-blue-700 rounded-lg transition text-sm font-medium flex items-center gap-1.5">
                                                <i class="fas fa-check"></i>
                                                <span>Process</span>
                                            </button>
                                        }
                                        @if (order.Status.ToLower() == "processing")
                                        {
                                            <button @onclick='() => UpdateOrderStatus(order.OrderId, "completed")'
                                                    class="px-3 py-1.5 bg-green-600 text-white hover:bg-green-700 rounded-lg transition text-sm font-medium flex items-center gap-1.5">
                                                <i class="fas fa-check-circle"></i>
                                                <span>Complete</span>
                                            </button>
                                        }
                                        @if (order.Status.ToLower() != "cancelled" && order.Status.ToLower() != "completed")
                                        {
                                            <button @onclick="() => CancelOrder(order.OrderId)"
                                                    class="px-3 py-1.5 bg-red-50 text-red-600 hover:bg-red-100 border border-red-200 rounded-lg transition text-sm font-medium flex items-center gap-1.5">
                                                <i class="fas fa-times"></i>
                                                <span>Cancel</span>
                                            </button>
                                        }
                                    </div>
                                </TableRowCell>
                            </TableRow>
                        }
                    }
                    else
                    {
                        <TableRow class="bg-white">
                            <TableRowCell ColumnSpan="6" class="text-center py-12">
                                <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.ShoppingBag" class="text-gray-400 text-4xl mb-3" />
                                <p class="text-gray-600 font-medium">No orders found</p>
                            </TableRowCell>
                        </TableRow>
                    }
                </TableBody>
            </Table>
        </div>
        
        <PaginationComponent CurrentPage="@currentPage" PageSize="@pageSize" TotalItems="@totalItems" OnPageChanged="@HandlePageChanged" />
    </CardBody>
</Card>

<!-- Toast Notification -->
@if (showToast)
{
    <div class="fixed bottom-6 right-6 z-50 animate-slide-up">
        <div class="@toastClass text-white px-6 py-4 rounded-xl shadow-2xl flex items-center gap-3 max-w-md">
            <div class="flex-shrink-0">
                <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center">
                    <i class="@toastIcon text-lg"></i>
                </div>
            </div>
            <div class="flex-1">
                <p class="font-semibold">@toastMessage</p>
            </div>
            <button @onclick="() => showToast = false"
                    class="flex-shrink-0 text-white/80 hover:text-white transition">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>
}

<!-- Order Details Modal -->
@if (showDetailsModal && selectedOrder != null)
{
    <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4" @onclick="CloseDetailsModal">
        <div class="bg-white rounded-2xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto" @onclick:stopPropagation>
            <!-- Header -->
            <div class="sticky top-0 bg-gradient-to-r from-blue-600 to-purple-600 text-white p-6 rounded-t-2xl">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-2xl font-bold">Order Details</h3>
                        <p class="text-blue-100 text-sm">#ORD-@selectedOrder.OrderId.ToString("D6")</p>
                    </div>
                    <button @onclick="CloseDetailsModal"
                            class="w-10 h-10 bg-white/20 hover:bg-white/30 rounded-full flex items-center justify-center transition">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>

            <div class="p-6 space-y-6">
                <!-- Customer & Order Info -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-gray-50 rounded-xl p-4">
                        <h4 class="text-sm font-bold text-gray-500 uppercase mb-3">Customer Information</h4>
                        <div class="space-y-2">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-white font-bold">
                                    @(selectedOrder.Customer?.Name?.Substring(0, 1).ToUpper() ?? "G")
                                </div>
                                <div>
                                    <p class="font-bold text-gray-900">@(selectedOrder.Customer?.Name ?? "Guest Customer")</p>
                                    <p class="text-sm text-gray-600">@(selectedOrder.Customer?.Email ?? "N/A")</p>
                                </div>
                            </div>
                            <div class="pt-2 border-t border-gray-200">
                                <p class="text-sm text-gray-600"><i class="fas fa-phone w-4"></i> @(selectedOrder.Customer?.Phone ?? "N/A")</p>
                                <p class="text-sm text-gray-600 mt-1"><i class="fas fa-map-marker-alt w-4"></i> @(selectedOrder.Customer?.Address ?? "N/A")</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-gray-50 rounded-xl p-4">
                        <h4 class="text-sm font-bold text-gray-500 uppercase mb-3">Order Information</h4>
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Order Date:</span>
                                <span class="font-bold text-gray-900">@selectedOrder.OrderDate.ToString("MMM dd, yyyy HH:mm")</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Status:</span>
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold @GetStatusClass(selectedOrder.Status)">
                                    @selectedOrder.Status
                                </span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Payment Method:</span>
                                <span class="font-bold text-gray-900">@(selectedOrder.Payments?.FirstOrDefault()?.PaymentMethod ?? "N/A")</span>
                            </div>
                            @if (selectedOrder.Payments != null && selectedOrder.Payments.Any())
                            {
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Payment Date:</span>
                                    <span class="font-bold text-gray-900">@selectedOrder.Payments.First().PaymentDate.ToString("MMM dd, yyyy HH:mm")</span>
                                </div>
                            }
                        </div>
                    </div>
                </div>

                <!-- Order Items -->
                <div>
                    <h4 class="text-sm font-bold text-gray-500 uppercase mb-3">Order Items</h4>
                    <div class="bg-gray-50 rounded-xl overflow-hidden">
                        <table class="w-full">
                            <thead class="bg-gray-200">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase">Product</th>
                                    <th class="px-4 py-3 text-center text-xs font-bold text-gray-700 uppercase">Quantity</th>
                                    <th class="px-4 py-3 text-right text-xs font-bold text-gray-700 uppercase">Price</th>
                                    <th class="px-4 py-3 text-right text-xs font-bold text-gray-700 uppercase">Total</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                @if (selectedOrder.OrderItems != null && selectedOrder.OrderItems.Any())
                                {
                                    @foreach (var item in selectedOrder.OrderItems)
                                    {
                                        <tr class="bg-white">
                                            <td class="px-4 py-3">
                                                <div class="flex items-center gap-3">
                                                    <div class="w-12 h-12 bg-gray-200 rounded-lg flex items-center justify-center">
                                                        <i class="fas fa-box text-gray-400"></i>
                                                    </div>
                                                    <div>
                                                        <p class="font-bold text-gray-900">@(item.Product?.ProductName ?? "Unknown Product")</p>
                                                        <p class="text-xs text-gray-500">@(item.Product?.Barcode ?? "")</p>
                                                    </div>
                                                </div>
                                            </td>
                                            <td class="px-4 py-3 text-center">
                                                <span class="inline-flex items-center justify-center w-8 h-8 bg-blue-100 text-blue-800 rounded-full font-bold text-sm">
                                                    @item.Quantity
                                                </span>
                                            </td>
                                            <td class="px-4 py-3 text-right font-medium text-gray-900">$@item.Price.ToString("N2")</td>
                                            <td class="px-4 py-3 text-right font-bold text-gray-900">$@item.Subtotal.ToString("N2")</td>
                                        </tr>
                                    }
                                }
                                else
                                {
                                    <tr>
                                        <td colspan="4" class="px-4 py-8 text-center text-gray-500">No items found</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Order Summary -->
                <div class="bg-gradient-to-br from-blue-50 to-purple-50 rounded-xl p-6 border-2 border-blue-200">
                    <div class="space-y-2">
                        <div class="flex justify-between text-gray-700">
                            <span>Subtotal:</span>
                            <span class="font-medium">$@selectedOrder.TotalAmount.ToString("N2")</span>
                        </div>
                        <div class="flex justify-between text-gray-700">
                            <span>Tax:</span>
                            <span class="font-medium">$0.00</span>
                        </div>
                        <div class="flex justify-between text-gray-700">
                            <span>Shipping:</span>
                            <span class="font-medium">$0.00</span>
                        </div>
                        <div class="border-t-2 border-blue-300 pt-2 mt-2">
                            <div class="flex justify-between items-center">
                                <span class="text-lg font-bold text-gray-900">Total Amount:</span>
                                <span class="text-2xl font-bold text-blue-600">$@selectedOrder.TotalAmount.ToString("N2")</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex gap-3 pt-4 border-t-2 border-gray-200">
                    @if (selectedOrder.Status.ToLower() == "pending")
                    {
                        <button @onclick='() => UpdateOrderStatusFromModal(selectedOrder.OrderId, "processing")'
                                class="flex-1 px-4 py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg transition flex items-center justify-center gap-2">
                            <i class="fas fa-check"></i>
                            <span>Process Order</span>
                        </button>
                    }
                    @if (selectedOrder.Status.ToLower() == "processing")
                    {
                        <button @onclick='() => UpdateOrderStatusFromModal(selectedOrder.OrderId, "completed")'
                                class="flex-1 px-4 py-3 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg transition flex items-center justify-center gap-2">
                            <i class="fas fa-check-circle"></i>
                            <span>Complete Order</span>
                        </button>
                    }
                    @if (selectedOrder.Status.ToLower() != "cancelled" && selectedOrder.Status.ToLower() != "completed")
                    {
                        <button @onclick="() => CancelOrderFromModal(selectedOrder.OrderId)"
                                class="flex-1 px-4 py-3 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg transition flex items-center justify-center gap-2">
                            <i class="fas fa-times"></i>
                            <span>Cancel Order</span>
                        </button>
                    }
                    <button @onclick="CloseDetailsModal"
                            class="px-6 py-3 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold rounded-lg transition">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>
}

<!-- Confirmation Modal -->
@if (showConfirmModal)
{
    <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm" @onclick="CloseConfirmModal">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 overflow-hidden" @onclick:stopPropagation>
            <div class="p-6">
                <div class="flex items-center gap-4 mb-4">
                    <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-gray-900">Confirm Cancellation</h3>
                        <p class="text-gray-600 text-sm">This action cannot be undone</p>
                    </div>
                </div>
                <p class="text-gray-700 mb-6">
                    Are you sure you want to cancel Order <span class="font-bold">#ORD-@confirmOrderId.ToString("D6")</span>?
                </p>
                <div class="flex gap-3">
                    <button @onclick="CloseConfirmModal"
                            class="flex-1 px-4 py-2.5 border-2 border-gray-300 text-gray-700 font-semibold rounded-lg hover:bg-gray-50 transition">
                        No, Keep Order
                    </button>
                    <button @onclick="ConfirmCancel"
                            class="flex-1 px-4 py-2.5 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg transition">
                        Yes, Cancel Order
                    </button>
                </div>
            </div>
        </div>
    </div>
}

<style>
    @@keyframes slide-up {
        from {
            transform: translateY(100%);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    .animate-slide-up {
        animation: slide-up 0.3s ease-out;
    }
</style>

@code {
    private List<Order>? allOrders;
    private List<Order>? orders;
    private bool isProcessing;
    private bool showToast;
    private string toastMessage = "";
    private string toastClass = "";
    private string toastIcon = "";
    private bool showConfirmModal;
    private int confirmOrderId;
    private bool showDetailsModal;
    private Order? selectedOrder;

    // Pagination
    private int currentPage = 1;
    private int pageSize = 10;
    private int totalItems = 0;

    protected override async Task OnInitializedAsync()
    {
        await LoadOrders();
    }

    private async Task LoadOrders()
    {
        allOrders = await DbContext.Orders
            .Include(o => o.Customer)
            .OrderByDescending(o => o.OrderDate)
            .ToListAsync();
        
        totalItems = allOrders?.Count ?? 0;
        UpdatePagedData();
    }

    private void UpdatePagedData()
    {
        if (allOrders != null)
        {
            orders = allOrders
                .Skip((currentPage - 1) * pageSize)
                .Take(pageSize)
                .ToList();
        }
    }

    private void HandlePageChanged(int page)
    {
        currentPage = page;
        UpdatePagedData();
    }

    private async Task ViewOrder(int orderId)
    {
        selectedOrder = await DbContext.Orders
            .Include(o => o.Customer)
            .Include(o => o.OrderItems)
                .ThenInclude(oi => oi.Product)
            .Include(o => o.Payments)
            .FirstOrDefaultAsync(o => o.OrderId == orderId);

        if (selectedOrder != null)
        {
            showDetailsModal = true;
        }
        else
        {
            ShowToast("Order not found!", "bg-red-600", "fas fa-times");
        }
    }

    private void CloseDetailsModal()
    {
        showDetailsModal = false;
        selectedOrder = null;
    }

    private string GetStatusClass(string status)
    {
        return status.ToLower() switch
        {
            "pending" => "bg-orange-100 text-orange-800",
            "completed" or "paid" => "bg-green-100 text-green-800",
            "cancelled" or "canceled" => "bg-red-100 text-red-800",
            "processing" => "bg-blue-100 text-blue-800",
            _ => "bg-gray-100 text-gray-800"
        };
    }

    private async Task UpdateOrderStatus(int orderId, string newStatus)
    {
        if (isProcessing) return;

        isProcessing = true;
        try
        {
            var order = await DbContext.Orders.FindAsync(orderId);
            if (order != null)
            {
                var oldStatus = order.Status;
                order.Status = newStatus;
                await DbContext.SaveChangesAsync();
                await LoadOrders();

                var statusText = newStatus switch
                {
                    "processing" => "marked as Processing",
                    "completed" => "completed successfully",
                    _ => $"updated to {newStatus}"
                };

                ShowToast($"Order #ORD-{orderId:D6} {statusText}!", "bg-green-600", "fas fa-check");
            }
        }
        catch (Exception ex)
        {
            ShowToast($"Failed to update order: {ex.Message}", "bg-red-600", "fas fa-times");
        }
        finally
        {
            isProcessing = false;
        }
    }

    private async Task UpdateOrderStatusFromModal(int orderId, string newStatus)
    {
        CloseDetailsModal();
        await UpdateOrderStatus(orderId, newStatus);
    }

    private void CancelOrderFromModal(int orderId)
    {
        CloseDetailsModal();
        CancelOrder(orderId);
    }

    private void CancelOrder(int orderId)
    {
        if (isProcessing) return;

        confirmOrderId = orderId;
        showConfirmModal = true;
    }

    private async Task ConfirmCancel()
    {
        showConfirmModal = false;
        isProcessing = true;

        try
        {
            var order = await DbContext.Orders.FindAsync(confirmOrderId);
            if (order != null)
            {
                order.Status = "cancelled";
                await DbContext.SaveChangesAsync();
                await LoadOrders();
                ShowToast($"Order #ORD-{confirmOrderId:D6} has been cancelled", "bg-orange-600", "fas fa-ban");
            }
        }
        catch (Exception ex)
        {
            ShowToast($"Failed to cancel order: {ex.Message}", "bg-red-600", "fas fa-times");
        }
        finally
        {
            isProcessing = false;
        }
    }

    private void CloseConfirmModal()
    {
        showConfirmModal = false;
    }

    private void ShowToast(string message, string cssClass, string icon)
    {
        toastMessage = message;
        toastClass = cssClass;
        toastIcon = icon;
        showToast = true;

        Task.Delay(3000).ContinueWith(_ =>
        {
            showToast = false;
            InvokeAsync(StateHasChanged);
        });
    }
}
