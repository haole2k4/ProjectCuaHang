@page "/store/checkout"
@layout StoreLayout
@rendermode InteractiveServer

@using BlazorApp1.Services
@using System.ComponentModel.DataAnnotations
@using System.Security.Claims
@using Blazorise
@using Microsoft.AspNetCore.Components.Authorization
@using StoreManagementAPI.Data
@using Microsoft.EntityFrameworkCore

@inject ICartService CartService
@inject ICustomerOrderService OrderService
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject StoreDbContext DbContext

<PageTitle>Checkout</PageTitle>

<div class="max-w-7xl mx-auto mb-8">
    <h1 class="text-3xl font-bold text-gray-900 mb-2 flex items-center gap-3">
        <i class="fas fa-credit-card text-blue-600"></i>
        Checkout
    </h1>
    <p class="text-gray-600">Complete your order in just a few steps</p>
</div>

@if (cartItems == null || !cartItems.Any())
{
    <div class="empty-state bg-white rounded-lg shadow-lg p-12">
        <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.ShoppingCart" class="text-6xl text-gray-400 mb-4" />
        <Heading Size="HeadingSize.Is4" class="mb-2">Your cart is empty</Heading>
        <Paragraph TextColor="TextColor.Muted" class="mb-6">Add some products before checking out.</Paragraph>
        <Button Color="Color.Primary" To="/store" Type="ButtonType.Link">
            <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.Store" class="mr-2" /> Browse Products
        </Button>
    </div>
}
else if (orderPlaced)
{
    <div class="text-center py-16 bg-white rounded-lg shadow-lg">
        <div class="text-green-500 text-7xl mb-6">
            <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.CheckCircle" />
        </div>
        <Heading Size="HeadingSize.Is3" class="mb-4">Order Placed Successfully!</Heading>
        <Paragraph Lead class="mb-2">Thank you for your order. Your order number is:</Paragraph>
        <Heading Size="HeadingSize.Is4" TextColor="TextColor.Primary" class="mb-8">#@orderId</Heading>
        <Buttons class="justify-center">
            <Button Color="Color.Primary" To="@($"/store/orders/{orderId}")" Type="ButtonType.Link">
                <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.Receipt" class="mr-2" /> View Order
            </Button>
            <Button Color="Color.Primary" Outline To="/store" Type="ButtonType.Link">
                <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.Store" class="mr-2" /> Continue Shopping
            </Button>
        </Buttons>
    </div>
}
else
{
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="lg:col-span-2 space-y-6">
            <Validations @ref="validationsRef" Mode="ValidationMode.Auto" Model="@checkoutModel">
                <!-- Customer Information -->
                <Card class="card-shadow">
                    <CardHeader>
                        <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.User" class="mr-2" /> Customer Information
                    </CardHeader>
                    <CardBody>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <Validation>
                                <Field>
                                    <FieldLabel>Full Name *</FieldLabel>
                                    <TextEdit @bind-Text="@checkoutModel.CustomerName" Placeholder="Enter your name">
                                        <Feedback>
                                            <ValidationError />
                                        </Feedback>
                                    </TextEdit>
                                </Field>
                            </Validation>
                            <Validation>
                                <Field>
                                    <FieldLabel>Email *</FieldLabel>
                                    <TextEdit @bind-Text="@checkoutModel.Email" Placeholder="Enter your email" Role="TextRole.Email">
                                        <Feedback>
                                            <ValidationError />
                                        </Feedback>
                                    </TextEdit>
                                </Field>
                            </Validation>
                        </div>
                        <Validation>
                            <Field class="mt-4">
                                <FieldLabel>Phone *</FieldLabel>
                                <TextEdit @bind-Text="@checkoutModel.Phone" Placeholder="Enter your phone number">
                                    <Feedback>
                                        <ValidationError />
                                    </Feedback>
                                </TextEdit>
                            </Field>
                        </Validation>
                    </CardBody>
                </Card>

                <!-- Shipping Address -->
                <Card class="card-shadow">
                    <CardHeader>
                        <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.MapMarkerAlt" class="mr-2" /> Shipping Address
                    </CardHeader>
                    <CardBody>
                        <Validation>
                            <Field>
                                <FieldLabel>Address *</FieldLabel>
                                <MemoEdit @bind-Text="@checkoutModel.Address" Rows="3" Placeholder="Enter your full address">
                                    <Feedback>
                                        <ValidationError />
                                    </Feedback>
                                </MemoEdit>
                            </Field>
                        </Validation>
                        <Field class="mt-4">
                            <FieldLabel>Notes (optional)</FieldLabel>
                            <MemoEdit @bind-Text="@checkoutModel.Notes" Rows="2" Placeholder="Special delivery instructions..." />
                        </Field>
                    </CardBody>
                </Card>

                <!-- Payment Method -->
                <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                    <div class="bg-gray-50 border-b border-gray-200 px-6 py-4">
                        <h3 class="text-lg font-bold text-gray-900 flex items-center gap-2">
                            <i class="fas fa-wallet text-blue-600"></i>
                            Payment Method
                        </h3>
                    </div>
                    <div class="p-6">
                        <RadioGroup TValue="string" @bind-CheckedValue="@checkoutModel.PaymentMethod" Name="paymentMethod">
                            <div class="space-y-3">
                                <label class="@GetPaymentClass("cash")" @onclick='() => checkoutModel.PaymentMethod = "cash"'>
                                    <Radio TValue="string" Value="@("cash")" class="flex-shrink-0" />
                                    <div class="flex items-center gap-3 ml-3 flex-1">
                                        <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center">
                                            <i class="fas fa-money-bill-alt text-green-600"></i>
                                        </div>
                                        <div>
                                            <p class="font-semibold text-gray-900">Cash on Delivery</p>
                                            <p class="text-sm text-gray-500">Pay when you receive</p>
                                        </div>
                                    </div>
                                </label>
                                <label class="@GetPaymentClass("card")" @onclick='() => checkoutModel.PaymentMethod = "card"'>
                                    <Radio TValue="string" Value="@("card")" class="flex-shrink-0" />
                                    <div class="flex items-center gap-3 ml-3 flex-1">
                                        <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                                            <i class="fas fa-credit-card text-blue-600"></i>
                                        </div>
                                        <div>
                                            <p class="font-semibold text-gray-900">Credit/Debit Card</p>
                                            <p class="text-sm text-gray-500">Visa, Mastercard accepted</p>
                                        </div>
                                    </div>
                                </label>
                                <label class="@GetPaymentClass("transfer")" @onclick='() => checkoutModel.PaymentMethod = "transfer"'>
                                    <Radio TValue="string" Value="@("transfer")" class="flex-shrink-0" />
                                    <div class="flex items-center gap-3 ml-3 flex-1">
                                        <div class="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center">
                                            <i class="fas fa-university text-purple-600"></i>
                                        </div>
                                        <div>
                                            <p class="font-semibold text-gray-900">Bank Transfer</p>
                                            <p class="text-sm text-gray-500">Direct bank payment</p>
                                        </div>
                                    </div>
                                </label>
                            </div>
                        </RadioGroup>
                    </div>
                </div>

                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <div class="bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded-lg flex items-start gap-3">
                        <i class="fas fa-exclamation-triangle mt-0.5"></i>
                        <span>@errorMessage</span>
                    </div>
                }

                <!-- Place Order Button -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <button @onclick="PlaceOrder"
                            disabled="@isProcessing"
                            class="w-full bg-green-600 hover:bg-green-700 disabled:bg-gray-400 text-white text-lg font-bold py-4 px-6 rounded-xl transition duration-200 shadow-lg hover:shadow-xl flex items-center justify-center gap-3">
                        @if (isProcessing)
                        {
                            <div class="animate-spin rounded-full h-5 w-5 border-2 border-white border-t-transparent"></div>
                            <span>Processing Order...</span>
                        }
                        else
                        {
                            <i class="fas fa-check-circle text-xl"></i>
                            <span>Place Order & Pay</span>
                        }
                    </button>
                    <p class="text-center text-gray-500 text-sm mt-3">
                        <i class="fas fa-lock mr-1"></i>
                        Your payment information is secure
                    </p>
                </div>
            </Validations>
        </div>

        <!-- Order Summary Sidebar -->
        <div class="lg:col-span-1">
            <div class="bg-white rounded-xl shadow-lg overflow-hidden sticky top-24">
                <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-4">
                    <h3 class="text-lg font-bold flex items-center gap-2">
                        <i class="fas fa-shopping-bag"></i>
                        Order Summary
                    </h3>
                </div>
                <div class="p-5">
                    <div class="space-y-3 max-h-64 overflow-y-auto">
                        @foreach (var item in cartItems)
                        {
                            <div class="flex justify-between items-start text-sm border-b border-gray-100 pb-3">
                                <div class="flex-1">
                                    <p class="font-medium text-gray-900">@item.ProductName</p>
                                    <p class="text-gray-500 text-xs">Qty: @item.Quantity Ã— $@item.Price.ToString("N2")</p>
                                </div>
                                <span class="font-semibold text-gray-900 ml-2">$@item.Subtotal.ToString("N2")</span>
                            </div>
                        }
                    </div>

                    <div class="mt-5 space-y-3 border-t border-gray-200 pt-4">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Subtotal</span>
                            <span class="font-medium">$@(cartItems?.Sum(x => x.Subtotal).ToString("N2") ?? "0.00")</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Shipping</span>
                            <span class="text-green-600 font-semibold">Free</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Tax</span>
                            <span class="font-medium">$0.00</span>
                        </div>
                        <div class="flex justify-between items-center pt-3 border-t-2 border-gray-300">
                            <span class="text-lg font-bold text-gray-900">Total</span>
                            <span class="text-2xl font-bold text-green-600">$@(cartItems?.Sum(x => x.Subtotal).ToString("N2") ?? "0.00")</span>
                        </div>
                    </div>
                </div>
                <div class="p-4 bg-gray-50 border-t border-gray-200">
                    <a href="/store/cart" class="w-full flex items-center justify-center gap-2 px-4 py-2.5 border-2 border-gray-300 text-gray-700 font-semibold rounded-lg hover:bg-gray-100 transition">
                        <i class="fas fa-arrow-left"></i>
                        Back to Cart
                    </a>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [CascadingParameter]
    private HttpContext? HttpContext { get; set; }

    private Validations? validationsRef;
    private List<CartItemDto>? cartItems;
    private CheckoutModel checkoutModel = new();
    private bool isProcessing;
    private bool orderPlaced;
    private int orderId;
    private string? errorMessage;
    private int? customerId;

    protected override async Task OnInitializedAsync()
    {
        cartItems = await CartService.GetCartItemsAsync();

        // Get current user's customer ID
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            var userId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;
            if (userId != null)
            {
                var customer = await DbContext.Customers
                    .FirstOrDefaultAsync(c => c.ApplicationUserId == userId);
                if (customer != null)
                {
                    customerId = customer.CustomerId;
                    // Pre-fill customer info
                    checkoutModel.CustomerName = customer.Name;
                    checkoutModel.Email = customer.Email ?? "";
                    checkoutModel.Phone = customer.Phone ?? "";
                    checkoutModel.Address = customer.Address ?? "";
                }
            }
        }
    }

    private string GetPaymentClass(string method)
    {
        var isSelected = checkoutModel.PaymentMethod == method;
        return isSelected
            ? "flex items-center p-4 border-2 rounded-xl cursor-pointer border-blue-500 bg-blue-50 transition duration-200"
            : "flex items-center p-4 border-2 rounded-xl cursor-pointer border-gray-200 hover:border-blue-300 hover:bg-gray-50 transition duration-200";
    }

    private async Task PlaceOrder()
    {
        if (validationsRef != null && !await validationsRef.ValidateAll())
            return;

        isProcessing = true;
        errorMessage = null;

        try
        {
            // Convert CartItemDto to the format CustomerOrderService expects
            var orderItems = cartItems!.Select(ci => new
            {
                ProductId = ci.ProductId,
                Quantity = ci.Quantity
            }).ToList();

            // Pass customerId (can be null for guest checkout)
            var order = await OrderService.CreateOrderAsync(customerId, orderItems, checkoutModel.PaymentMethod);
            orderId = order.OrderId;
            await CartService.ClearCartAsync();
            orderPlaced = true;
        }
        catch (Exception ex)
        {
            errorMessage = "Failed to place order. Please try again. " + ex.Message;
        }
        finally
        {
            isProcessing = false;
        }
    }

    private class CheckoutModel
    {
        [Required(ErrorMessage = "Name is required")]
        public string CustomerName { get; set; } = "";

        [Required(ErrorMessage = "Email is required")]
        [EmailAddress(ErrorMessage = "Invalid email address")]
        public string Email { get; set; } = "";

        [Required(ErrorMessage = "Phone is required")]
        public string Phone { get; set; } = "";

        [Required(ErrorMessage = "Address is required")]
        public string Address { get; set; } = "";

        public string? Notes { get; set; }

        public string PaymentMethod { get; set; } = "cash";
    }
}
