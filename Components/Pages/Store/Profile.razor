@page "/store/profile"
@layout StoreLayout
@rendermode InteractiveServer
@attribute [Microsoft.AspNetCore.Authorization.Authorize]

@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.EntityFrameworkCore
@using StoreManagementAPI.Data
@using StoreManagementAPI.Models
@using System.Security.Claims
@using Blazorise
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Identity
@using BlazorApp1.Data
@using BlazorApp1.Services

@inject AuthenticationStateProvider AuthenticationStateProvider
@inject StoreDbContext DbContext
@inject NavigationManager NavigationManager
@inject UserManager<ApplicationUser> UserManager
@inject ToastService ToastService

<PageTitle>My Profile</PageTitle>

<div class="max-w-4xl mx-auto">
    <Heading Size="HeadingSize.Is2" class="mb-6">
        <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.UserCircle" class="mr-2" /> My Profile
    </Heading>

    @if (isLoading)
    {
        <div class="loading-spinner">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
        </div>
    }
    else if (customer == null)
    {
        <Alert Color="Color.Warning" Visible="true">
            <AlertMessage>Customer profile not found. Please contact support.</AlertMessage>
        </Alert>
    }
    else
    {
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Profile Navigation -->
            <div class="lg:col-span-1">
                <Card class="card-shadow">
                    <CardBody>
                        <div class="text-center mb-4">
                            <div class="w-24 h-24 mx-auto mb-4 rounded-full bg-blue-100 flex items-center justify-center">
                                <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.User" IconSize="IconSize.x3" TextColor="TextColor.Primary" />
                            </div>
                            <Heading Size="HeadingSize.Is5" class="mb-1">@customer.Name</Heading>
                            <Paragraph class="text-sm text-gray-600">@customer.Email</Paragraph>
                        </div>
                        <Divider />
                        <ListGroup Flush>
                            <ListGroupItem Clicked="() => activeTab = ProfileTab.Info"
                                           Class="@GetTabClass(ProfileTab.Info)">
                                <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.InfoCircle" class="mr-2" /> Personal Info
                            </ListGroupItem>
                            <ListGroupItem Clicked="() => activeTab = ProfileTab.Orders"
                                           Class="@GetTabClass(ProfileTab.Orders)">
                                <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.ShoppingBag" class="mr-2" /> Order History
                            </ListGroupItem>
                            <ListGroupItem Clicked="() => activeTab = ProfileTab.Password"
                                           Class="@GetTabClass(ProfileTab.Password)">
                                <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.Key" class="mr-2" /> Change Password
                            </ListGroupItem>
                            <ListGroupItem Clicked='() => NavigationManager.NavigateTo("/Account/Manage/Passkeys")' Class="cursor-pointer hover:bg-gray-50">
                                <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.Fingerprint" class="mr-2" /> Passkeys
                            </ListGroupItem>
                            <ListGroupItem Clicked='() => NavigationManager.NavigateTo("/store")' Class="cursor-pointer hover:bg-gray-50">
                                <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.Store" class="mr-2" /> Back to Store
                            </ListGroupItem>
                        </ListGroup>
                    </CardBody>
                </Card>
            </div>

            <!-- Profile Content -->
            <div class="lg:col-span-2">
                @if (activeTab == ProfileTab.Info)
                {
                    <Card class="card-shadow">
                        <CardHeader>
                            <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.User" class="mr-2" /> Personal Information
                        </CardHeader>
                        <CardBody>
                            @if (errorMessage != null)
                            {
                                <Alert Color="Color.Danger" Visible="true" class="mb-4">
                                    <AlertMessage>@errorMessage</AlertMessage>
                                    <CloseButton Clicked="() => errorMessage = null" />
                                </Alert>
                            }

                            <Validations @ref="validationsRef" Mode="ValidationMode.Manual" Model="@profileModel">
                                <Validation>
                                    <Field>
                                        <FieldLabel>Full Name *</FieldLabel>
                                        <TextEdit @bind-Text="@profileModel.Name" Placeholder="Enter your name">
                                            <Feedback>
                                                <ValidationError />
                                            </Feedback>
                                        </TextEdit>
                                    </Field>
                                </Validation>
                                <Validation>
                                    <Field class="mt-3">
                                        <FieldLabel>Email *</FieldLabel>
                                        <TextEdit @bind-Text="@profileModel.Email" Placeholder="Enter your email" Role="TextRole.Email">
                                            <Feedback>
                                                <ValidationError />
                                            </Feedback>
                                        </TextEdit>
                                    </Field>
                                </Validation>
                                <Validation>
                                    <Field class="mt-3">
                                        <FieldLabel>Phone</FieldLabel>
                                        <TextEdit @bind-Text="@profileModel.Phone" Placeholder="Enter your phone number">
                                            <Feedback>
                                                <ValidationError />
                                            </Feedback>
                                        </TextEdit>
                                    </Field>
                                </Validation>
                                <Validation>
                                    <Field class="mt-3">
                                        <FieldLabel>Address</FieldLabel>
                                        <MemoEdit @bind-Text="@profileModel.Address" Rows="3" Placeholder="Enter your address">
                                            <Feedback>
                                                <ValidationError />
                                            </Feedback>
                                        </MemoEdit>
                                    </Field>
                                </Validation>
                            </Validations>
                        </CardBody>
                        <CardFooter class="bg-gray-50 px-6 py-4">
                            <Button Color="Color.Primary" Clicked="SaveProfile" Loading="@isSaving" class="!bg-blue-600 hover:!bg-blue-700 !text-white font-semibold">
                                <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.Save" class="mr-2" /> Save Changes
                            </Button>
                        </CardFooter>
                    </Card>
                }
                else if (activeTab == ProfileTab.Orders)
                {
                    <Card class="card-shadow">
                        <CardHeader>
                            <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.ShoppingBag" class="mr-2" /> Order History
                        </CardHeader>
                        <CardBody>
                            @if (orders == null || !orders.Any())
                            {
                                <div class="text-center py-8">
                                    <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.ShoppingBag" class="text-4xl text-gray-400 mb-3" />
                                    <Paragraph TextColor="TextColor.Muted">No orders yet</Paragraph>
                                </div>
                            }
                            else
                            {
                                <div class="space-y-3">
                                    @foreach (var order in orders)
                                    {
                                        <div class="p-4 border rounded-lg hover:bg-gray-50 cursor-pointer" @onclick="() => ViewOrder(order.OrderId)">
                                            <div class="flex justify-between items-start mb-2">
                                                <div>
                                                    <Heading Size="HeadingSize.Is6" class="mb-1">Order #@order.OrderId</Heading>
                                                    <small class="text-gray-500">@order.OrderDate.ToString("MMM dd, yyyy")</small>
                                                </div>
                                                <Badge Color="@GetStatusColor(order.Status)" Pill>@order.Status</Badge>
                                            </div>
                                            <div class="flex justify-between items-center">
                                                <small class="text-gray-600">@order.OrderItems.Count item(s)</small>
                                                <span class="font-semibold text-green-600">$@order.TotalAmount.ToString("N2")</span>
                                            </div>
                                        </div>
                                    }
                                </div>
                            }
                        </CardBody>
                        <CardFooter>
                            <Button Color="Color.Primary" To="/store/orders" Type="ButtonType.Link">
                                <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.List" class="mr-2" /> View All Orders
                            </Button>
                        </CardFooter>
                    </Card>
                }
                else if (activeTab == ProfileTab.Password)
                {
                    <Card class="card-shadow">
                        <CardHeader>
                            <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.Key" class="mr-2" /> Change Password
                        </CardHeader>
                        <CardBody>
                            @if (errorMessage != null)
                            {
                                <Alert Color="Color.Danger" Visible="true" class="mb-4">
                                    <AlertMessage>@errorMessage</AlertMessage>
                                    <CloseButton Clicked="() => errorMessage = null" />
                                </Alert>
                            }

                            <Validations @ref="passwordValidationsRef" Mode="ValidationMode.Manual" Model="@passwordModel">
                                <Validation>
                                    <Field>
                                        <FieldLabel>Current Password *</FieldLabel>
                                        <TextEdit @bind-Text="@passwordModel.CurrentPassword" Role="TextRole.Password" Placeholder="Enter current password">
                                            <Feedback>
                                                <ValidationError />
                                            </Feedback>
                                        </TextEdit>
                                    </Field>
                                </Validation>
                                <Validation>
                                    <Field class="mt-3">
                                        <FieldLabel>New Password *</FieldLabel>
                                        <TextEdit @bind-Text="@passwordModel.NewPassword" Role="TextRole.Password" Placeholder="Enter new password">
                                            <Feedback>
                                                <ValidationError />
                                            </Feedback>
                                        </TextEdit>
                                        <FieldHelp>Password must be at least 6 characters long.</FieldHelp>
                                    </Field>
                                </Validation>
                                <Validation>
                                    <Field class="mt-3">
                                        <FieldLabel>Confirm New Password *</FieldLabel>
                                        <TextEdit @bind-Text="@passwordModel.ConfirmPassword" Role="TextRole.Password" Placeholder="Confirm new password">
                                            <Feedback>
                                                <ValidationError />
                                            </Feedback>
                                        </TextEdit>
                                    </Field>
                                </Validation>
                            </Validations>
                        </CardBody>
                        <CardFooter class="bg-gray-50 px-6 py-4">
                            <Button Color="Color.Primary" Clicked="ChangePassword" Loading="@isChangingPassword" class="!bg-blue-600 hover:!bg-blue-700 !text-white font-semibold">
                                <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.Key" class="mr-2" /> Change Password
                            </Button>
                        </CardFooter>
                    </Card>
                }
            </div>
        </div>
    }
</div>

@code {
    private Customer? customer;
    private List<Order>? orders;
    private bool isLoading = true;
    private bool isSaving = false;
    private bool isChangingPassword = false;
    private ProfileTab activeTab = ProfileTab.Info;
    private Validations? validationsRef;
    private Validations? passwordValidationsRef;
    private ProfileModel profileModel = new();
    private PasswordChangeModel passwordModel = new();
    private string? errorMessage;
    private string? userId;

    private enum ProfileTab
    {
        Info,
        Orders,
        Password
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadCustomerData();
    }

    private async Task LoadCustomerData()
    {
        isLoading = true;

        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            userId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;
            if (userId != null)
            {
                customer = await DbContext.Customers
                    .FirstOrDefaultAsync(c => c.ApplicationUserId == userId);

                if (customer != null)
                {
                    // Populate form model
                    profileModel.Name = customer.Name;
                    profileModel.Email = customer.Email ?? "";
                    profileModel.Phone = customer.Phone ?? "";
                    profileModel.Address = customer.Address ?? "";

                    // Load recent orders
                    orders = await DbContext.Orders
                        .Include(o => o.OrderItems)
                        .Where(o => o.CustomerId == customer.CustomerId)
                        .OrderByDescending(o => o.OrderDate)
                        .Take(5)
                        .ToListAsync();
                }
            }
        }

        isLoading = false;
    }

    private string GetTabClass(ProfileTab tab)
    {
        return activeTab == tab
            ? "cursor-pointer bg-blue-50 text-blue-600 font-semibold"
            : "cursor-pointer hover:bg-gray-50";
    }

    private async Task SaveProfile()
    {
        if (validationsRef != null && !await validationsRef.ValidateAll())
            return;

        isSaving = true;
        errorMessage = null;

        try
        {
            if (customer != null)
            {
                customer.Name = profileModel.Name;
                customer.Email = profileModel.Email;
                customer.Phone = profileModel.Phone;
                customer.Address = profileModel.Address;

                await DbContext.SaveChangesAsync();
                ToastService.ShowSuccess("Profile updated successfully!", "Success");
            }
        }
        catch (Exception ex)
        {
            errorMessage = "Failed to update profile. Please try again.";
            ToastService.ShowError("Failed to update profile.", "Error");
        }
        finally
        {
            isSaving = false;
        }
    }

    private void ViewOrder(int orderId)
    {
        NavigationManager.NavigateTo($"/store/orders/{orderId}");
    }

    private Color GetStatusColor(string status) => status.ToLower() switch
    {
        "pending" => Color.Warning,
        "completed" => Color.Success,
        "cancelled" or "canceled" => Color.Danger,
        "processing" => Color.Info,
        _ => Color.Secondary
    };

    private async Task ChangePassword()
    {
        if (passwordValidationsRef != null && !await passwordValidationsRef.ValidateAll())
            return;

        if (passwordModel.NewPassword != passwordModel.ConfirmPassword)
        {
            errorMessage = "New password and confirmation password do not match.";
            return;
        }

        isChangingPassword = true;
        errorMessage = null;

        try
        {
            if (userId != null)
            {
                var user = await UserManager.FindByIdAsync(userId);
                if (user != null)
                {
                    var result = await UserManager.ChangePasswordAsync(user, passwordModel.CurrentPassword, passwordModel.NewPassword);
                    if (result.Succeeded)
                    {
                        ToastService.ShowSuccess("Password changed successfully!", "Success");
                        passwordModel = new PasswordChangeModel();
                        await InvokeAsync(StateHasChanged);
                    }
                    else
                    {
                        errorMessage = string.Join(", ", result.Errors.Select(e => e.Description));
                        ToastService.ShowError(errorMessage, "Error");
                    }
                }
                else
                {
                    errorMessage = "User not found.";
                }
            }
        }
        catch (Exception ex)
        {
            errorMessage = "Failed to change password. Please check your current password and try again.";
            ToastService.ShowError("Failed to change password.", "Error");
        }
        finally
        {
            isChangingPassword = false;
        }
    }

    private class ProfileModel
    {
        [Required(ErrorMessage = "Name is required")]
        public string Name { get; set; } = "";

        [Required(ErrorMessage = "Email is required")]
        [EmailAddress(ErrorMessage = "Invalid email address")]
        public string Email { get; set; } = "";

        public string? Phone { get; set; }

        public string? Address { get; set; }
    }

    private class PasswordChangeModel
    {
        [Required(ErrorMessage = "Current password is required")]
        public string CurrentPassword { get; set; } = "";

        [Required(ErrorMessage = "New password is required")]
        [MinLength(6, ErrorMessage = "Password must be at least 6 characters long")]
        public string NewPassword { get; set; } = "";

        [Required(ErrorMessage = "Please confirm your new password")]
        [Compare(nameof(NewPassword), ErrorMessage = "Passwords do not match")]
        public string ConfirmPassword { get; set; } = "";
    }
}
