@page "/store/cart"
@layout StoreLayout
@rendermode InteractiveServer

@using BlazorApp1.Services
@using Blazorise
@using StoreManagementAPI.Services
@using StoreManagementAPI.DTOs
@using BlazorApp1.Components.Controls

@inject ICartService CartService
@inject IPromotionService PromotionService
@inject INotificationService NotificationService
@inject NavigationManager NavigationManager

<PageTitle>Shopping Cart</PageTitle>

<div class="flex flex-wrap justify-between items-center mb-6 gap-4">
  <Heading Size="HeadingSize.Is2" class="!text-blue-600 !font-bold">
    <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.ShoppingCart" class="!mr-2" /> Shopping Cart
  </Heading>
  <Button Color="Color.Primary" Outline To="/store" Type="ButtonType.Link" 
          class="!border-2 !border-blue-600 !text-blue-600 hover:!bg-blue-600 hover:!text-white !font-semibold">
    <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.ArrowLeft" class="!mr-2" /> Continue Shopping
  </Button>
</div>

@if (cartItems == null || !cartItems.Any())
{
  <div class="empty-state bg-white rounded-lg shadow-lg p-12">
    <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.ShoppingCart" class="text-6xl text-gray-400 mb-4" />
    <Heading Size="HeadingSize.Is4" class="mb-2">Your cart is empty</Heading>
    <Paragraph TextColor="TextColor.Muted" class="mb-6">Add some products to get started!</Paragraph>
    <Button Color="Color.Primary" To="/store" Type="ButtonType.Link">
      <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.Store" class="mr-2" /> Browse Products
    </Button>
  </div>
}
else
{
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Cart Items -->
    <div class="lg:col-span-2">
      <Card class="card-shadow">
        <CardHeader Background="Background.Light">
          <div class="grid grid-cols-12 gap-4 font-semibold text-gray-600">
            <div class="col-span-6">Product</div>
            <div class="col-span-2 text-center">Price</div>
            <div class="col-span-2 text-center">Quantity</div>
            <div class="col-span-2 text-right">Subtotal</div>
          </div>
        </CardHeader>
        <CardBody>
          @foreach (var item in cartItems)
          {
            <div class="cart-item">
              <div class="grid grid-cols-12 gap-4 items-center">
                <div class="col-span-6">
                  <div class="flex items-center gap-4">
                    @if (!string.IsNullOrEmpty(item.ImageUrl))
                    {
                      <img src="@item.ImageUrl" class="cart-item-image" alt="@item.ProductName" />
                    }
                    else
                    {
                      <div class="cart-item-placeholder">
                        <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.BoxOpen" />
                      </div>
                    }
                    <div>
                      <Heading Size="HeadingSize.Is6" class="mb-1">@item.ProductName</Heading>
                      <Button Color="Color.Danger" Size="Size.Small" Outline Clicked="() => RemoveItem(item.ProductId)">
                        <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.TrashAlt" class="mr-1" /> Remove
                      </Button>
                    </div>
                  </div>
                </div>
                <div class="col-span-2 text-center text-gray-600">
                  $@item.Price.ToString("N2")
                </div>
                <div class="col-span-2">
                  <div class="quantity-control justify-center">
                    <Button Color="Color.Light" Size="Size.Small"
                      Clicked="() => UpdateQuantity(item.ProductId, item.Quantity - 1)">
                      <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.Minus" />
                    </Button>
                    <NumericEdit TValue="int" Value="@item.Quantity"
                      ValueChanged="(val) => UpdateQuantity(item.ProductId, val)" class="w-16 text-center" Min="1" />
                    <Button Color="Color.Light" Size="Size.Small"
                      Clicked="() => UpdateQuantity(item.ProductId, item.Quantity + 1)">
                      <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.Plus" />
                    </Button>
                  </div>
                </div>
                <div class="col-span-2 text-right">
                  <span class="price">$@item.Subtotal.ToString("N2")</span>
                </div>
              </div>
            </div>
          }
        </CardBody>
        <CardFooter Background="Background.Light">
          <Button Color="Color.Danger" Outline Clicked="ClearCart"
                  class="!border-2 !border-red-600 !text-red-600 hover:!bg-red-600 hover:!text-white !font-semibold">
            <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.TrashAlt" class="!mr-2" /> Clear Cart
          </Button>
        </CardFooter>
      </Card>
    </div>

    <!-- Order Summary -->
    <div class="lg:col-span-1">
      <Card class="card-shadow sticky top-20">
        <CardHeader Background="Background.Primary" TextColor="TextColor.White">
          <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.Receipt" class="mr-2" /> Order Summary
        </CardHeader>
        <CardBody>
          <div class="space-y-3">
            <div class="flex justify-between">
              <span>Subtotal (@cartItems.Sum(x => x.Quantity) items)</span>
              <span>$@subtotal.ToString("N2")</span>
            </div>
            <div class="flex justify-between">
              <span>Shipping</span>
              <span class="text-green-600">Free</span>
            </div>
            <div class="flex justify-between">
              <span>Tax</span>
              <span>$0.00</span>
            </div>
            @if (discount > 0)
            {
              <div class="flex justify-between text-green-600">
                <span>Discount (@appliedPromoCode)</span>
                <span>-$@discount.ToString("N2")</span>
              </div>
            }
            <Divider />
            <div class="flex justify-between font-bold text-lg">
              <span>Total</span>
              <span class="price">$@total.ToString("N2")</span>
            </div>
          </div>

          <Field class="mt-6">
            <FieldLabel>Mã Giảm Giá</FieldLabel>
            @if (string.IsNullOrEmpty(appliedPromoCode))
            {
              <Select TValue="int?" SelectedValue="@selectedPromoId" SelectedValueChanged="OnPromotionSelected" 
                      class="w-full !border-gray-300 mb-2" Disabled="@isLoadingPromotions">
                <SelectItem Value="@((int?)null)">-- Chọn mã giảm giá --</SelectItem>
                @if (availablePromotions != null)
                {
                  @foreach (var promo in availablePromotions)
                  {
                    <SelectItem Value="@promo.PromoId">@promo.DisplayText</SelectItem>
                  }
                }
              </Select>
              @if (availablePromotions == null || !availablePromotions.Any())
              {
                <Paragraph TextColor="TextColor.Muted" class="text-sm mt-2">
                  <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.InfoCircle" class="mr-1" />
                  Không có mã giảm giá nào khả dụng cho đơn hàng này.
                </Paragraph>
              }
            }
            else
            {
              <div class="flex items-center justify-between p-3 bg-green-50 border border-green-200 rounded-lg">
                <div class="flex-1">
                  <div class="font-semibold text-green-800">@appliedPromoCode</div>
                  <div class="text-sm text-green-600">Bạn đang tiết kiệm: $@discount.ToString("N2")</div>
                </div>
                <Button Color="Color.Danger" Size="Size.Small" Clicked="RemovePromo" class="!bg-red-600 hover:!bg-red-700 !text-white !border-red-600">
                  <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.Times" class="mr-1" /> Xóa
                </Button>
              </div>
            }
          </Field>

          <Button Color="Color.Success" Size="Size.Large" Block
            class="mt-6 !bg-green-600 hover:!bg-green-700 !text-white !border-green-600" Clicked="ProceedToCheckout">
            <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.CreditCard" class="mr-2" /> Proceed to Checkout
          </Button>
        </CardBody>
      </Card>

      <Card class="card-shadow mt-4">
        <CardBody>
          <Heading Size="HeadingSize.Is6" class="mb-2">
            <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.ShieldAlt" TextColor="TextColor.Success"
              class="mr-2" /> Secure Checkout
          </Heading>
          <Paragraph TextColor="TextColor.Muted" class="text-sm mb-0">
            Your payment information is processed securely.
          </Paragraph>
        </CardBody>
      </Card>
    </div>
  </div>
}

<PromoNotification @ref="promoNotification" />

@code {
  private List<CartItemDto>? cartItems;
  private List<PromotionDisplayDto>? availablePromotions;
  private int? selectedPromoId = null;
  private bool isLoadingPromotions = false;
  private PromoNotification promoNotification;

  private decimal subtotal => cartItems?.Sum(x => x.Subtotal) ?? 0;
  private decimal discount => CartService.DiscountAmount;
  private decimal total => subtotal - discount;
  private string appliedPromoCode => CartService.AppliedPromoCode;

  protected override async Task OnInitializedAsync()
  {
    CartService.OnChange += async () => await RefreshCart();
    await RefreshCart();
    await LoadAvailablePromotions();
  }

  private async Task RefreshCart()
  {
    cartItems = await CartService.GetCartItemsAsync();
    // Recalculate discount based on current subtotal if a promo is active
    if (!string.IsNullOrEmpty(CartService.AppliedPromoCode))
    {
        // We need to know if it was percent or fixed to recalculate correctly.
        // However, CartService only stores the result values now.
        // Ideally CartService should store DiscountType and Value.
        // For now, let's assume if Percent > 0 it's percent, otherwise fixed.

        decimal newDiscount = 0;
        if (CartService.DiscountPercent > 0)
        {
             newDiscount = subtotal * (CartService.DiscountPercent / 100);
        }
        else
        {
             // Fixed amount, it stays the same unless it exceeds subtotal?
             // Usually fixed amount is constant.
             newDiscount = CartService.DiscountAmount;
             if (newDiscount > subtotal) newDiscount = subtotal;
        }

        if (newDiscount != CartService.DiscountAmount)
        {
            CartService.ApplyDiscount(CartService.AppliedPromoCode, CartService.AppliedPromoId ?? 0, CartService.DiscountPercent, newDiscount);
        }
    }
    await LoadAvailablePromotions();
    await InvokeAsync(StateHasChanged);
  }

  private async Task LoadAvailablePromotions()
  {
    if (!string.IsNullOrEmpty(appliedPromoCode))
    {
      availablePromotions = new List<PromotionDisplayDto>();
      return;
    }

    isLoadingPromotions = true;
    try
    {
      // Get list of product IDs in cart (distinct)
      var productIds = cartItems?.Select(item => item.ProductId).Distinct().ToList() ?? new List<int>();

      availablePromotions = await PromotionService.GetValidPromotionsForOrderAsync(subtotal, productIds);
    }
    catch (Exception ex)
    {
      Console.WriteLine($"[Cart] Error loading promotions: {ex.Message}");
      availablePromotions = new List<PromotionDisplayDto>();
    }
    finally
    {
      isLoadingPromotions = false;
    }
  }

  private async Task OnPromotionSelected(int? promoId)
  {
    selectedPromoId = promoId;
    
    if (promoId.HasValue)
    {
      await ApplySelectedPromotion(promoId.Value);
    }
  }

  private async Task UpdateQuantity(int productId, int quantity)
  {
    var (success, message) = await CartService.UpdateQuantityAsync(productId, quantity);
    if (!success)
    {
      await promoNotification.Show("Thông báo", message, PromoNotification.NotificationType.Error);
    }
  }

  private async Task RemoveItem(int productId)
  {
    await CartService.RemoveFromCartAsync(productId);
  }

  private async Task ClearCart()
  {
    await CartService.ClearCartAsync();
    await RemovePromo();
  }

  private async Task ApplySelectedPromotion(int promoId)
  {
    try
    {
      var selectedPromo = availablePromotions?.FirstOrDefault(p => p.PromoId == promoId);
      
      if (selectedPromo == null)
      {
        await promoNotification.Show("Lỗi", "Không tìm thấy mã giảm giá", PromoNotification.NotificationType.Error);
        return;
      }

      decimal discountAmount = 0;
      decimal discountPercent = 0;

      if (selectedPromo.DiscountType == "percent")
      {
        discountPercent = selectedPromo.DiscountValue;
        discountAmount = subtotal * (discountPercent / 100);
      }
      else // fixed
      {
        discountAmount = Math.Min(selectedPromo.DiscountValue, subtotal);
      }

      CartService.ApplyDiscount(selectedPromo.PromoCode, selectedPromo.PromoId, discountPercent, discountAmount);

      string saveMessage = selectedPromo.DiscountType == "percent"
          ? $"${discountAmount:N2} ({discountPercent}% off)"
          : $"${discountAmount:N2}";

      await promoNotification.Show("Áp dụng thành công", $"Mã giảm giá đã được áp dụng! Bạn tiết kiệm {saveMessage}", PromoNotification.NotificationType.Success);
      
      selectedPromoId = null;
      await LoadAvailablePromotions();
    }
    catch (Exception ex)
    {
      Console.WriteLine($"[Cart] Error applying promo: {ex.Message}");
      await promoNotification.Show("Lỗi", "Không thể áp dụng mã giảm giá", PromoNotification.NotificationType.Error);
    }
  }

  private async Task RemovePromo()
  {
    CartService.RemoveDiscount();
    selectedPromoId = null;
    await LoadAvailablePromotions();
    await promoNotification.Show("Đã xóa", "Mã giảm giá đã được gỡ bỏ", PromoNotification.NotificationType.Info);
  }

  private void ProceedToCheckout()
  {
    NavigationManager.NavigateTo("/store/checkout");
  }

  public void Dispose()
  {
    CartService.OnChange -= async () => await RefreshCart();
  }
}
