@page "/store/orders/{OrderId:int}"
@layout StoreLayout
@rendermode InteractiveServer
@attribute [Microsoft.AspNetCore.Authorization.Authorize]

@using BlazorApp1.Services
@using StoreManagementAPI.Models
@using StoreManagementAPI.Data
@using Microsoft.EntityFrameworkCore
@using Blazorise
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims

@inject ICustomerOrderService OrderService
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject StoreDbContext DbContext

<PageTitle>Order Details</PageTitle>

@if (isLoading)
{
    <div class="loading-spinner">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
    </div>
}
else if (order == null)
{
    <div class="empty-state bg-white rounded-lg shadow-lg p-12">
        <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.ExclamationCircle" class="text-6xl text-gray-400 mb-4" />
        <Heading Size="HeadingSize.Is4" class="mb-2">Order not found</Heading>
        <Paragraph TextColor="TextColor.Muted" class="mb-6">The order you're looking for doesn't exist.</Paragraph>
        <Button Color="Color.Primary" To="/store/orders" Type="ButtonType.Link" class="!bg-blue-600 !text-white hover:!bg-blue-700 hover:!text-white">
            <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.ArrowLeft" class="mr-2" /> Back to Orders
        </Button>
    </div>
}
else
{
    <div class="flex flex-wrap justify-between items-start mb-6 gap-4">
        <div>
            <Heading Size="HeadingSize.Is3" class="text-2xl font-bold mb-3">
                <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.ShoppingBag" class="mr-2" /> Order #@order.OrderId
            </Heading>
            <Paragraph class="mb-0 text-sm text-black">
                Placed on @order.OrderDate.ToString("MMMM dd, yyyy 'at' hh:mm tt")
            </Paragraph>
        </div>
        <Buttons>
            <Button Color="Color.Primary" Size="Size.Small" To="@($"/store/orders/{order.OrderId}/bill")" Type="ButtonType.Link" class="font-medium !bg-blue-600 !text-white hover:!bg-blue-700 hover:!text-white">
                <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.Receipt" class="mr-1" /> View Bill
            </Button>
            <Button Color="Color.Primary" Size="Size.Small" To="/store/orders" Type="ButtonType.Link" class="font-medium !bg-blue-600 !text-white hover:!bg-blue-700 hover:!text-white">
                <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.ArrowLeft" class="mr-1" /> Back to Orders
            </Button>
        </Buttons>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="lg:col-span-2 space-y-6">
            <!-- Order Status -->
            <Card class="card-shadow">
                <CardBody class="flex items-center gap-4">
                    <span class="@GetStatusBadgeClass(order.Status) px-3 py-1.5 rounded-full text-sm font-semibold text-white inline-block">
                        @order.Status.ToUpper()
                    </span>
                    <span class="text-sm">
                        @switch (order.Status.ToLower())
                        {
                            case "pending":
                                <text>Your order is being processed</text>
                                break;
                            case "processing":
                                <text>Your order is being prepared</text>
                                break;
                            case "completed":
                                <text>Your order has been delivered</text>
                                break;
                            case "cancelled":
                            case "canceled":
                                <text>Your order has been cancelled</text>
                                break;
                            default:
                                <text>Order status: @order.Status</text>
                                break;
                        }
                    </span>
                </CardBody>
            </Card>

            <!-- Order Items -->
            <Card class="card-shadow">
                <CardHeader class="text-base font-semibold">
                    <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.BoxOpen" class="mr-2" /> Order Items
                </CardHeader>
                <CardBody Padding="Padding.Is0">
                    <Table Striped Hoverable class="mb-0">
                        <TableHeader>
                            <TableRow>
                                <TableHeaderCell>Product</TableHeaderCell>
                                <TableHeaderCell TextAlignment="TextAlignment.Center">Quantity</TableHeaderCell>
                                <TableHeaderCell TextAlignment="TextAlignment.End">Price</TableHeaderCell>
                                <TableHeaderCell TextAlignment="TextAlignment.End">Subtotal</TableHeaderCell>
                            </TableRow>
                        </TableHeader>
                        <TableBody>
                            @foreach (var item in order.OrderItems)
                            {
                                <TableRow>
                                    <TableRowCell>
                                        <div class="flex items-center gap-3">
                                            @if (!string.IsNullOrEmpty(item.Product?.ImageUrl))
                                            {
                                                <img src="@item.Product.ImageUrl" class="w-16 h-16 rounded-lg object-cover shadow" alt="@item.Product?.ProductName" />
                                            }
                                            else
                                            {
                                                <div class="w-16 h-16 rounded-lg bg-gray-200 flex items-center justify-center">
                                                    <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.BoxOpen" TextColor="TextColor.Muted" />
                                                </div>
                                            }
                                            <div>
                                                <p class="font-semibold text-sm mb-0">@item.Product?.ProductName</p>
                                                <small class="text-gray-500 text-xs">@item.Product?.Unit</small>
                                            </div>
                                        </div>
                                    </TableRowCell>
                                    <TableRowCell TextAlignment="TextAlignment.Center" class="text-sm">@item.Quantity</TableRowCell>
                                    <TableRowCell TextAlignment="TextAlignment.End" class="text-sm">$@item.Price.ToString("N2")</TableRowCell>
                                    <TableRowCell TextAlignment="TextAlignment.End" class="font-semibold text-sm">$@item.Subtotal.ToString("N2")</TableRowCell>
                                </TableRow>
                            }
                        </TableBody>
                    </Table>
                </CardBody>
            </Card>

            <!-- Payment Information -->
            @if (order.Payments.Any())
            {
                <Card class="card-shadow">
                    <CardHeader class="text-base font-semibold">
                        <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.CreditCard" class="mr-2" /> Payment Information
                    </CardHeader>
                    <CardBody>
                        @foreach (var payment in order.Payments)
                        {
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <small class="text-gray-500 text-xs font-semibold uppercase block">Payment Method</small>
                                    <Paragraph class="mb-0 text-sm">
                                        @switch (payment.PaymentMethod.ToLower())
                                        {
                                            case "cash":
                                                <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.MoneyBillAlt" TextColor="TextColor.Success" class="mr-1" />
                                                <text>Cash on Delivery</text>
                                                break;
                                            case "card":
                                                <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.CreditCard" TextColor="TextColor.Primary" class="mr-1" />
                                                <text>Credit/Debit Card</text>
                                                break;
                                            case "transfer":
                                                <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.University" TextColor="TextColor.Info" class="mr-1" />
                                                <text>Bank Transfer</text>
                                                break;
                                            default:
                                                @payment.PaymentMethod
                                                break;
                                        }
                                    </Paragraph>
                                </div>
                                <div>
                                    <small class="text-gray-500 text-xs font-semibold uppercase block">Payment Date</small>
                                    <Paragraph class="mb-0 text-sm">@payment.PaymentDate.ToString("MMM dd, yyyy hh:mm tt")</Paragraph>
                                </div>
                                <div>
                                    <small class="text-gray-500 text-xs font-semibold uppercase block">Amount Paid</small>
                                    <Paragraph TextColor="TextColor.Success" class="font-bold mb-0 text-sm">$@payment.Amount.ToString("N2")</Paragraph>
                                </div>
                            </div>
                        }
                    </CardBody>
                </Card>
            }
        </div>

        @* <div class="lg:col-span-1 space-y-4">
            <!-- Order Summary -->
            <Card class="card-shadow" style="position: sticky; top: 80px; z-index: 10;">
                <CardHeader Background="Background.Primary" TextColor="TextColor.White">
                    <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.Calculator" class="mr-2" /> Order Summary
                </CardHeader>
                <CardBody>
                    <div class="space-y-3">
                        <div class="flex justify-between text-sm font-bold text-black">
                            <span>Subtotal</span>
                            <span>$@((order.TotalAmount + order.DiscountAmount).ToString("N2"))</span>
                        </div>
                        @if (order.DiscountAmount > 0)
                        {
                            <div class="flex justify-between text-green-600 text-sm font-bold">
                                <span>Discount</span>
                                <span>-$@order.DiscountAmount.ToString("N2")</span>
                            </div>
                        }
                        <div class="flex justify-between text-sm font-bold text-black">
                            <span>Shipping</span>
                            <span class="text-green-600">Free</span>
                        </div>
                        <Divider />
                        <div class="flex justify-between font-bold text-lg text-black">
                            <span>Total</span>
                            <span class="price">$@order.TotalAmount.ToString("N2")</span>
                        </div>
                    </div>
                </CardBody>
            </Card>

            <!-- Customer Info -->
            @if (order.Customer != null)
            {
                <Card class="card-shadow">
                    <CardHeader class="text-base font-semibold">
                        <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.User" class="mr-2" /> Customer
                    </CardHeader>
                    <CardBody>
                        <Paragraph class="font-bold mb-2 text-black">@order.Customer.Name</Paragraph>
                        @if (!string.IsNullOrEmpty(order.Customer.Email))
                        {
                            <Paragraph class="mb-2 text-sm text-black">
                                <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.Envelope" class="mr-1" /> @order.Customer.Email
                            </Paragraph>
                        }
                        @if (!string.IsNullOrEmpty(order.Customer.Phone))
                        {
                            <Paragraph class="mb-2 text-sm text-black">
                                <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.Phone" class="mr-1" /> @order.Customer.Phone
                            </Paragraph>
                        }
                        @if (!string.IsNullOrEmpty(order.Customer.Address))
                        {
                            <Paragraph class="mb-0 text-sm text-black">
                                <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.MapMarkerAlt" class="mr-1" /> @order.Customer.Address
                            </Paragraph>
                        }
                    </CardBody>
                </Card>
            }
        </div> *@
        <div class="lg:col-span-1 space-y-4">
            <Card class="!bg-white border border-gray-200 shadow-md rounded-xl overflow-hidden" style="position: sticky; top: 80px; z-index: 10;">
                <CardHeader class="!bg-gray-50 border-b border-gray-200 py-3 px-4">
                    <span class="text-gray-900 font-bold text-base">
                        <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.Calculator" class="mr-2 text-gray-500" /> Order Summary
                    </span>
                </CardHeader>
                <CardBody class="p-5">
                    <div class="space-y-3">
                        <div class="flex justify-between text-sm font-medium text-gray-600">
                            <span>Subtotal</span>
                            <span class="text-gray-900 font-bold">$@((order.TotalAmount + order.DiscountAmount).ToString("N2"))</span>
                        </div>
                        @if (order.DiscountAmount > 0)
                        {
                            <div class="flex justify-between text-sm font-medium text-green-600">
                                <span>Discount</span>
                                <span>-$@order.DiscountAmount.ToString("N2")</span>
                            </div>
                        }
                        <div class="flex justify-between text-sm font-medium text-gray-600">
                            <span>Shipping</span>
                            <span class="text-green-600 font-bold">Free</span>
                        </div>
                        
                        <Divider class="!my-3 !border-gray-200" />
                        
                        <div class="flex justify-between items-center">
                            <span class="text-lg font-bold text-gray-900">Total</span>
                            <span class="text-xl font-bold text-blue-600">$@order.TotalAmount.ToString("N2")</span>
                        </div>
                    </div>
                </CardBody>
            </Card>

            @if (order.Customer != null)
            {
                <Card class="!bg-white border border-gray-200 shadow-md rounded-xl overflow-hidden">
                    <CardHeader class="!bg-gray-50 border-b border-gray-200 py-3 px-4">
                        <span class="text-gray-900 font-bold text-base">
                            <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.User" class="mr-2 text-gray-500" /> Customer
                        </span>
                    </CardHeader>
                    <CardBody class="p-5">
                        <Paragraph class="font-bold mb-3 text-gray-900 text-lg">@order.Customer.Name</Paragraph>
                        
                        <div class="space-y-2">
                            @if (!string.IsNullOrEmpty(order.Customer.Email))
                            {
                                <div class="flex items-center text-sm text-gray-600">
                                    <div class="w-8 flex-shrink-0">
                                        <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.Envelope" class="text-gray-400" />
                                    </div>
                                    <span class="truncate">@order.Customer.Email</span>
                                </div>
                            }
                            @if (!string.IsNullOrEmpty(order.Customer.Phone))
                            {
                                <div class="flex items-center text-sm text-gray-600">
                                    <div class="w-8 flex-shrink-0">
                                        <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.Phone" class="text-gray-400" />
                                    </div>
                                    <span>@order.Customer.Phone</span>
                                </div>
                            }
                            @if (!string.IsNullOrEmpty(order.Customer.Address))
                            {
                                <div class="flex items-start text-sm text-gray-600">
                                    <div class="w-8 flex-shrink-0 mt-0.5">
                                        <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.MapMarkerAlt" class="text-gray-400" />
                                    </div>
                                    <span>@order.Customer.Address</span>
                                </div>
                            }
                        </div>
                    </CardBody>
                </Card>
            }
        </div>
    </div>
}

@code {
    [Parameter]
    public int OrderId { get; set; }

    private Order? order;
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadOrder();
    }

    private async Task LoadOrder()
    {
        isLoading = true;
        
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        var isAdmin = user.IsInRole("ADMIN");

        if (isAdmin)
        {
            // ADMIN: Can view any order
            order = await OrderService.GetOrderWithDetailsAsync(OrderId);
        }
        else
        {
            // CUSTOMER: Check if order belongs to them
            var userId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;
            if (userId != null)
            {
                var customer = await DbContext.Customers
                    .FirstOrDefaultAsync(c => c.ApplicationUserId == userId);
                
                if (customer != null)
                {
                    order = await DbContext.Orders
                        .Include(o => o.Customer)
                        .Include(o => o.OrderItems)
                            .ThenInclude(oi => oi.Product)
                        .Include(o => o.Payments)
                        .FirstOrDefaultAsync(o => o.OrderId == OrderId && o.CustomerId == customer.CustomerId);
                }
            }
        }
        
        isLoading = false;
    }

    private string GetStatusBadgeClass(string status) => status.ToLower() switch
    {
        "pending" => "bg-red-600",
        "completed" => "bg-green-600",
        "cancelled" or "canceled" => "bg-gray-600",
        "processing" => "bg-blue-600",
        "shipped" => "bg-cyan-600",
        _ => "bg-gray-500"
    };
}
