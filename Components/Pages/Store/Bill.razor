@page "/store/orders/{OrderId:int}/bill"
@layout StoreLayout
@rendermode InteractiveServer
@attribute [Microsoft.AspNetCore.Authorization.Authorize]

@using BlazorApp1.Services
@using StoreManagementAPI.Models
@using StoreManagementAPI.Data
@using Microsoft.EntityFrameworkCore
@using Blazorise
@using Microsoft.JSInterop
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims

@inject ICustomerOrderService OrderService
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject StoreDbContext DbContext

<PageTitle>Invoice #@OrderId</PageTitle>

@if (isLoading)
{
    <div class="loading-spinner">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
    </div>
}
else if (order == null)
{
    <div class="empty-state bg-white rounded-lg shadow-lg p-12">
        <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.ExclamationCircle" class="text-6xl text-gray-400 mb-4" />
        <Heading Size="HeadingSize.Is4" class="mb-2">Order not found</Heading>
        <Paragraph TextColor="TextColor.Muted" class="mb-6">The order you're looking for doesn't exist.</Paragraph>
        <Button Color="Color.Primary" To="/store/orders" Type="ButtonType.Link" class="!bg-blue-600 !text-white hover:!bg-blue-700 hover:!text-white">
            <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.ArrowLeft" class="mr-2" /> Back to Orders
        </Button>
    </div>
}
else
{
    <div class="mb-6 no-print">
        <Button Color="Color.Primary" Size="Size.Small" Clicked="PrintInvoice" class="font-medium !bg-blue-600 !text-white hover:!bg-blue-700 hover:!text-white">
            <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.Print" class="mr-1" /> Print Invoice
        </Button>
    </div>

    <BillContent Order="order" />
}

@code {
    [Parameter]
    public int OrderId { get; set; }

    private Order? order;
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadOrder();
    }

    private async Task LoadOrder()
    {
        isLoading = true;
        
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        var isAdmin = user.IsInRole("ADMIN");

        if (isAdmin)
        {
            // ADMIN: Can view any order bill
            order = await OrderService.GetOrderWithDetailsAsync(OrderId);
        }
        else
        {
            // CUSTOMER: Check if order belongs to them
            var userId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;
            if (userId != null)
            {
                var customer = await DbContext.Customers
                    .FirstOrDefaultAsync(c => c.ApplicationUserId == userId);
                
                if (customer != null)
                {
                    order = await DbContext.Orders
                        .Include(o => o.Customer)
                        .Include(o => o.OrderItems)
                            .ThenInclude(oi => oi.Product)
                        .Include(o => o.Payments)
                        .FirstOrDefaultAsync(o => o.OrderId == OrderId && o.CustomerId == customer.CustomerId);
                }
            }
        }
        
        isLoading = false;
    }

    private async Task PrintInvoice()
    {
        await JSRuntime.InvokeVoidAsync("window.print");
    }
}

<style>
    @@media print {
        /* Hide everything except invoice content */
        body * {
            visibility: hidden;
        }

        .card-shadow-lg, .card-shadow-lg * {
            visibility: visible;
        }

        .card-shadow-lg {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            max-width: 100% !important;
            box-shadow: none !important;
            border: none !important;
        }

        /* Hide non-printable elements */
        .no-print {
            display: none !important;
        }

        /* Set page size to A4 */
        @@page {
            size: A4;
            margin: 8mm 10mm;
        }

        /* Reset body styles for print */
        body {
            background: white !important;
            margin: 0;
            padding: 0;
        }

        /* Ensure proper colors print */
        * {
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
            color-adjust: exact !important;
        }

        /* Remove page breaks inside elements */
        .card, .card-body, table, tr, td, th {
            page-break-inside: avoid;
        }

        /* Remove borders and shadows from nested cards */
        .card {
            border: none !important;
            box-shadow: none !important;
        }

        /* Ensure grid layout works in print */
        .grid {
            display: grid !important;
        }

        .grid-cols-1 {
            grid-template-columns: repeat(1, minmax(0, 1fr)) !important;
        }

        .md\:grid-cols-2 {
            grid-template-columns: repeat(2, minmax(0, 1fr)) !important;
        }

        /* Optimize spacing for print */
        .card-shadow-lg .border-b-2 {
            padding: 0.75rem 1.5rem !important;
        }

        .card-shadow-lg .p-8 {
            padding: 1.25rem !important;
        }

        .card-shadow-lg .gap-8 {
            gap: 0.75rem !important;
        }

        .card-shadow-lg .mb-8 {
            margin-bottom: 0.75rem !important;
        }

        .card-shadow-lg .mt-8 {
            margin-top: 0.75rem !important;
        }

        .card-shadow-lg .pt-8 {
            padding-top: 0.75rem !important;
        }

        .card-shadow-lg .mb-3 {
            margin-bottom: 0.5rem !important;
        }

        .card-shadow-lg .space-y-2 > * + * {
            margin-top: 0.35rem !important;
        }

        /* Reduce font sizes for compact print */
        body {
            font-size: 8.5pt;
        }

        h1 { font-size: 15pt; }
        h2 { font-size: 13pt; }
        h3 { font-size: 12pt; }
        h4 { font-size: 11pt; }
        h5 { font-size: 9.5pt; }
        h6 { font-size: 8.5pt; }

        .text-sm {
            font-size: 7.5pt !important;
        }

        .text-xs {
            font-size: 6.5pt !important;
        }

        .text-lg {
            font-size: 10pt !important;
        }

        /* Optimize table spacing */
        table {
            margin-bottom: 0.5rem !important;
        }

        td, th {
            padding: 0.3rem 0.4rem !important;
        }

        /* Reduce icon sizes */
        .card-shadow-lg svg {
            width: 0.9em !important;
            height: 0.9em !important;
        }
    }
</style>
