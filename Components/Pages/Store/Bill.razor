@page "/store/orders/{OrderId:int}/bill"
@layout StoreLayout
@rendermode InteractiveServer

@using BlazorApp1.Services
@using StoreManagementAPI.Models
@using Blazorise
@using Microsoft.JSInterop

@inject ICustomerOrderService OrderService
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime

<PageTitle>Invoice #@OrderId</PageTitle>

@if (isLoading)
{
    <div class="loading-spinner">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
    </div>
}
else if (order == null)
{
    <div class="empty-state bg-white rounded-lg shadow-lg p-12">
        <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.ExclamationCircle" class="text-6xl text-gray-400 mb-4" />
        <Heading Size="HeadingSize.Is4" class="mb-2">Order not found</Heading>
        <Paragraph TextColor="TextColor.Muted" class="mb-6">The order you're looking for doesn't exist.</Paragraph>
        <Button Color="Color.Primary" To="/store/orders" Type="ButtonType.Link" class="!bg-blue-600 !text-white hover:!bg-blue-700 hover:!text-white">
            <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.ArrowLeft" class="mr-2" /> Back to Orders
        </Button>
    </div>
}
else
{
    <div class="mb-6 no-print">
        <Buttons>
            <Button Color="Color.Primary" Size="Size.Small" To="@($"/store/orders/{OrderId}")" Type="ButtonType.Link" class="font-medium !bg-blue-600 !text-white hover:!bg-blue-700 hover:!text-white">
                <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.ArrowLeft" class="mr-1" /> Back to Order
            </Button>
            <Button Color="Color.Primary" Size="Size.Small" Clicked="PrintInvoice" class="font-medium !bg-blue-600 !text-white hover:!bg-blue-700 hover:!text-white">
                <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.Print" class="mr-1" /> Print Invoice
            </Button>
        </Buttons>
    </div>

    <Card class="card-shadow-lg max-w-4xl mx-auto">
        <!-- Invoice Header -->
        <div class="bg-white border-b-2 border-black px-8 py-6">
            <div class="flex flex-wrap justify-between items-center gap-4">
                <div>
                    <Heading Size="HeadingSize.Is3" class="mb-1 text-black font-bold">
                        <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.Store" class="mr-2" /> E-Store
                    </Heading>
                    <Paragraph class="text-gray-600 mb-0 text-sm">Your trusted online shopping destination</Paragraph>
                </div>
                <div class="text-right">
                    <Heading Size="HeadingSize.Is4" class="mb-1 text-black font-bold">INVOICE</Heading>
                    <Paragraph class="text-gray-700 mb-0 text-sm font-semibold">#INV-@order.OrderId.ToString("D6")</Paragraph>
                </div>
            </div>
        </div>

        <CardBody class="p-8">
            <!-- Invoice Info -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                <div>
                    <Heading Size="HeadingSize.Is6" class="uppercase tracking-wide mb-3 text-xs font-bold text-gray-700">Bill To</Heading>
                    @if (order.Customer != null)
                    {
                        <Heading Size="HeadingSize.Is6" class="mb-2 text-black font-bold">@order.Customer.Name</Heading>
                        @if (!string.IsNullOrEmpty(order.Customer.Address))
                        {
                            <Paragraph class="mb-1 text-sm text-black">@order.Customer.Address</Paragraph>
                        }
                        @if (!string.IsNullOrEmpty(order.Customer.Email))
                        {
                            <Paragraph class="mb-1 text-sm text-black">@order.Customer.Email</Paragraph>
                        }
                        @if (!string.IsNullOrEmpty(order.Customer.Phone))
                        {
                            <Paragraph class="mb-0 text-sm text-black">@order.Customer.Phone</Paragraph>
                        }
                    }
                    else
                    {
                        <Paragraph class="text-gray-600 text-sm">Guest Customer</Paragraph>
                    }
                </div>
                <div class="md:text-right">
                    <div class="space-y-2">
                        <div class="flex justify-between md:justify-end md:gap-8 text-sm">
                            <span class="text-gray-600">Invoice Date:</span>
                            <span class="font-semibold text-black">@DateTime.Now.ToString("MMM dd, yyyy")</span>
                        </div>
                        <div class="flex justify-between md:justify-end md:gap-8 text-sm">
                            <span class="text-gray-600">Order Date:</span>
                            <span class="font-semibold text-black">@order.OrderDate.ToString("MMM dd, yyyy")</span>
                        </div>
                        <div class="flex justify-between md:justify-end md:gap-8 items-center text-sm">
                            <span class="text-gray-600">Status:</span>
                            <span class="@GetStatusBadgeClass(order.Status) px-3 py-1 rounded-full text-xs font-semibold text-white inline-block">@order.Status.ToUpper()</span>
                        </div>
                        @if (order.Payments.Any())
                        {
                            <div class="flex justify-between md:justify-end md:gap-8 text-sm">
                                <span class="text-gray-600">Payment:</span>
                                <span class="font-semibold text-black">@GetPaymentMethodDisplay(order.Payments.First().PaymentMethod)</span>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Invoice Items Table -->
            <Table Striped class="mb-8">
                <TableHeader class="bg-gray-100">
                    <TableRow>
                        <TableHeaderCell class="w-1/2 text-xs font-bold text-black uppercase">Description</TableHeaderCell>
                        <TableHeaderCell TextAlignment="TextAlignment.Center" class="text-xs font-bold text-black uppercase">Quantity</TableHeaderCell>
                        <TableHeaderCell TextAlignment="TextAlignment.End" class="text-xs font-bold text-black uppercase">Unit Price</TableHeaderCell>
                        <TableHeaderCell TextAlignment="TextAlignment.End" class="text-xs font-bold text-black uppercase">Amount</TableHeaderCell>
                    </TableRow>
                </TableHeader>
                <TableBody>
                    @foreach (var item in order.OrderItems)
                    {
                        <TableRow>
                            <TableRowCell class="text-sm">
                                <strong class="text-black">@item.Product?.ProductName</strong>
                                @if (!string.IsNullOrEmpty(item.Product?.Unit))
                                {
                                    <br /><small class="text-gray-600 text-xs">Unit: @item.Product.Unit</small>
                                }
                            </TableRowCell>
                            <TableRowCell TextAlignment="TextAlignment.Center" class="text-sm text-black">@item.Quantity</TableRowCell>
                            <TableRowCell TextAlignment="TextAlignment.End" class="text-sm text-black">$@item.Price.ToString("N2")</TableRowCell>
                            <TableRowCell TextAlignment="TextAlignment.End" class="text-sm font-semibold text-black">$@item.Subtotal.ToString("N2")</TableRowCell>
                        </TableRow>
                    }
                </TableBody>
            </Table>

            <!-- Invoice Summary -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <Card class="!border-0 !shadow-none">
                    <CardBody>
                        <Heading Size="HeadingSize.Is6" class="mb-3 text-sm font-bold text-black uppercase">Payment Information</Heading>
                        @if (order.Payments.Any())
                        {
                            var payment = order.Payments.First();
                            <Paragraph class="mb-1 text-sm">
                                <small class="text-gray-600 text-xs">Method:</small> <span class="text-black font-medium">@GetPaymentMethodDisplay(payment.PaymentMethod)</span>
                            </Paragraph>
                            <Paragraph class="mb-1 text-sm">
                                <small class="text-gray-600 text-xs">Date:</small> <span class="text-black font-medium">@payment.PaymentDate.ToString("MMM dd, yyyy hh:mm tt")</span>
                            </Paragraph>
                            <Paragraph class="mb-0 text-sm">
                                <small class="text-gray-600 text-xs">Status:</small>
                                <span class="text-green-600 font-semibold">Paid</span>
                            </Paragraph>
                        }
                        else
                        {
                            <Paragraph class="text-red-600 mb-0 text-sm font-semibold">Payment Pending</Paragraph>
                        }
                    </CardBody>
                </Card>
                <Card class="!border-0 !shadow-none">
                    <CardBody>
                        <div class="space-y-2">
                            <div class="flex justify-between text-sm">
                                <span class="text-black">Subtotal:</span>
                                <span class="text-black font-medium">$@((order.TotalAmount + order.DiscountAmount).ToString("N2"))</span>
                            </div>
                            @if (order.DiscountAmount > 0)
                            {
                                <div class="flex justify-between text-green-600 text-sm">
                                    <span>Discount:</span>
                                    <span class="font-medium">-$@order.DiscountAmount.ToString("N2")</span>
                                </div>
                            }
                            <div class="flex justify-between text-sm">
                                <span class="text-black">Shipping:</span>
                                <span class="text-black font-medium">$0.00</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-black">Tax:</span>
                                <span class="text-black font-medium">$0.00</span>
                            </div>
                            <Divider />
                            <div class="flex justify-between text-lg font-bold">
                                <span class="text-black">Total:</span>
                                <span class="text-black">$@order.TotalAmount.ToString("N2")</span>
                            </div>
                        </div>
                    </CardBody>
                </Card>
            </div>

            <!-- Footer -->
            <div class="text-center mt-8 pt-8 border-t-2 border-gray-300">
                <Paragraph class="mb-1 text-sm font-semibold text-black">Thank you for shopping with us!</Paragraph>
                <Paragraph class="text-xs mb-0 text-gray-600">
                    For questions about your order, please contact support@estore.com
                </Paragraph>
            </div>
        </CardBody>
    </Card>
}

@code {
    [Parameter]
    public int OrderId { get; set; }

    private Order? order;
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadOrder();
    }

    private async Task LoadOrder()
    {
        isLoading = true;
        order = await OrderService.GetOrderWithDetailsAsync(OrderId);
        isLoading = false;
    }

    private async Task PrintInvoice()
    {
        await JSRuntime.InvokeVoidAsync("window.print");
    }

    private string GetStatusBadgeClass(string status) => status.ToLower() switch
    {
        "pending" => "bg-red-600",
        "completed" => "bg-green-600",
        "cancelled" or "canceled" => "bg-gray-600",
        "processing" => "bg-blue-600",
        "shipped" => "bg-cyan-600",
        _ => "bg-gray-500"
    };

    private string GetPaymentMethodDisplay(string method) => method.ToLower() switch
    {
        "cash" => "Cash on Delivery",
        "card" => "Credit/Debit Card",
        "transfer" => "Bank Transfer",
        _ => method
    };
}

<style>
    @@media print {
        /* Hide everything except invoice content */
        body * {
            visibility: hidden;
        }

        .card-shadow-lg, .card-shadow-lg * {
            visibility: visible;
        }

        .card-shadow-lg {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            max-width: 100% !important;
            box-shadow: none !important;
            border: none !important;
        }

        /* Hide non-printable elements */
        .no-print {
            display: none !important;
        }

        /* Set page size to A4 */
        @@page {
            size: A4;
            margin: 8mm 10mm;
        }

        /* Reset body styles for print */
        body {
            background: white !important;
            margin: 0;
            padding: 0;
        }

        /* Ensure proper colors print */
        * {
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
            color-adjust: exact !important;
        }

        /* Remove page breaks inside elements */
        .card, .card-body, table, tr, td, th {
            page-break-inside: avoid;
        }

        /* Remove borders and shadows from nested cards */
        .card {
            border: none !important;
            box-shadow: none !important;
        }

        /* Ensure grid layout works in print */
        .grid {
            display: grid !important;
        }

        .grid-cols-1 {
            grid-template-columns: repeat(1, minmax(0, 1fr)) !important;
        }

        .md\:grid-cols-2 {
            grid-template-columns: repeat(2, minmax(0, 1fr)) !important;
        }

        /* Optimize spacing for print */
        .card-shadow-lg .border-b-2 {
            padding: 0.75rem 1.5rem !important;
        }

        .card-shadow-lg .p-8 {
            padding: 1.25rem !important;
        }

        .card-shadow-lg .gap-8 {
            gap: 0.75rem !important;
        }

        .card-shadow-lg .mb-8 {
            margin-bottom: 0.75rem !important;
        }

        .card-shadow-lg .mt-8 {
            margin-top: 0.75rem !important;
        }

        .card-shadow-lg .pt-8 {
            padding-top: 0.75rem !important;
        }

        .card-shadow-lg .mb-3 {
            margin-bottom: 0.5rem !important;
        }

        .card-shadow-lg .space-y-2 > * + * {
            margin-top: 0.35rem !important;
        }

        /* Reduce font sizes for compact print */
        body {
            font-size: 8.5pt;
        }

        h1 { font-size: 15pt; }
        h2 { font-size: 13pt; }
        h3 { font-size: 12pt; }
        h4 { font-size: 11pt; }
        h5 { font-size: 9.5pt; }
        h6 { font-size: 8.5pt; }

        .text-sm {
            font-size: 7.5pt !important;
        }

        .text-xs {
            font-size: 6.5pt !important;
        }

        .text-lg {
            font-size: 10pt !important;
        }

        /* Optimize table spacing */
        table {
            margin-bottom: 0.5rem !important;
        }

        td, th {
            padding: 0.3rem 0.4rem !important;
        }

        /* Reduce icon sizes */
        .card-shadow-lg svg {
            width: 0.9em !important;
            height: 0.9em !important;
        }
    }
</style>
