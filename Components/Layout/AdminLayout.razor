@inherits LayoutComponentBase
@using Blazorise
@using System.Security.Claims
@using BlazorApp1.Components.Shared
@using Microsoft.AspNetCore.Components.Authorization
@using StoreManagementAPI.Data
@using StoreManagementAPI.Models
@using Microsoft.EntityFrameworkCore

@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IDbContextFactory<StoreDbContext> DbContextFactory

<div class="admin-layout flex min-h-screen bg-gray-100">
    <!-- Sidebar -->
    <aside class="admin-sidebar w-64 bg-white shadow-lg flex flex-col fixed h-full z-40 border-r border-gray-200">
        <!-- Logo -->
        <div class="px-6 h-20 flex items-center border-b border-gray-200">
            <a href="/admin/dashboard" class="flex items-center gap-3 no-underline">
                <div class="w-10 h-10 bg-gradient-to-br from-blue-600 to-purple-600 rounded-xl flex items-center justify-center shadow-md">
                    <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.Store" class="text-white" />
                </div>
                <div>
                    <span class="font-bold text-xl text-gray-900">E-Store</span>
                    <span class="text-xs text-gray-500 block font-medium">Admin Panel</span>
                </div>
            </a>
        </div>

        <!-- Navigation -->
        <nav class="flex-1 px-4 py-2 overflow-y-auto">
            <div class="space-y-1">
                <!-- Dashboard - visible to all -->
                <NavLink href="/admin/dashboard" class="nav-link flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-50 transition-all no-underline font-medium" ActiveClass="!bg-blue-50 !text-blue-600" Match="NavLinkMatch.All">
                    <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.ChartLine" />
                    <span>Dashboard</span>
                </NavLink>

                <!-- Products - visible to admin and sales_staff -->
                @if (userRole == "admin" || userRole == "sales_staff")
                {
                    <NavLink href="/admin/products" class="nav-link flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-50 transition-all no-underline font-medium" ActiveClass="!bg-blue-50 !text-blue-600">
                        <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.BoxOpen" />
                        <span>Products</span>
                    </NavLink>
                }

                <!-- Categories - visible to admin and sales_staff -->
                @if (userRole == "admin" || userRole == "sales_staff")
                {
                    <NavLink href="/admin/categories" class="nav-link flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-50 transition-all no-underline font-medium" ActiveClass="!bg-blue-50 !text-blue-600">
                        <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.Tags" />
                        <span>Categories</span>
                    </NavLink>
                }

                <!-- Orders - visible to admin and sales_staff -->
                @if (userRole == "admin" || userRole == "sales_staff")
                {
                    <NavLink href="/admin/orders" class="nav-link flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-50 transition-all no-underline font-medium" ActiveClass="!bg-blue-50 !text-blue-600">
                        <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.ShoppingBag" />
                        <span>Orders</span>
                    </NavLink>
                }

                <!-- Customers - visible to admin only -->
                @if (userRole == "admin")
                {
                    <NavLink href="/admin/customers" class="nav-link flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-50 transition-all no-underline font-medium" ActiveClass="!bg-blue-50 !text-blue-600">
                        <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.Users" />
                        <span>Customers</span>
                    </NavLink>
                }

                <!-- Employees - visible to admin only -->
                @if (userRole == "admin")
                {
                    <NavLink href="/admin/employees" class="nav-link flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-50 transition-all no-underline font-medium" ActiveClass="!bg-blue-50 !text-blue-600">
                        <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.UserTag" />
                        <span>Employees</span>
                    </NavLink>
                }

                <!-- Suppliers - visible to admin and warehouse_staff -->
                @if (userRole == "admin" || userRole == "warehouse_staff")
                {
                    <NavLink href="/admin/suppliers" class="nav-link flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-50 transition-all no-underline font-medium" ActiveClass="!bg-blue-50 !text-blue-600">
                        <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.TruckMoving" />
                        <span>Suppliers</span>
                    </NavLink>
                }

                <!-- Warehouses - visible to admin and warehouse_staff -->
                @if (userRole == "admin" || userRole == "warehouse_staff")
                {
                    <NavLink href="/admin/warehouses" class="nav-link flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-50 transition-all no-underline font-medium" ActiveClass="!bg-blue-50 !text-blue-600">
                        <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.Warehouse" />
                        <span>Warehouses</span>
                    </NavLink>
                }

                <!-- Purchase Orders - visible to admin and warehouse_staff -->
                @if (userRole == "admin" || userRole == "warehouse_staff")
                {
                    <NavLink href="/admin/purchase-orders" class="nav-link flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-50 transition-all no-underline font-medium" ActiveClass="!bg-blue-50 !text-blue-600">
                        <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.FileInvoice" />
                        <span>Purchase Orders</span>
                    </NavLink>
                }

                <!-- Inventories - visible to admin and warehouse_staff -->
                @if (userRole == "admin" || userRole == "warehouse_staff")
                {
                    <NavLink href="/admin/inventories" class="nav-link flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-50 transition-all no-underline font-medium" ActiveClass="!bg-blue-50 !text-blue-600">
                        <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.BoxesStacked" />
                        <span>Inventories</span>
                    </NavLink>
                }

                <!-- Promotions - visible to admin and sales_staff -->
                @if (userRole == "admin" || userRole == "sales_staff")
                {
                    <NavLink href="/admin/promotions" class="nav-link flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-50 transition-all no-underline font-medium" ActiveClass="!bg-blue-50 !text-blue-600">
                        <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.Percent" />
                        <span>Promotions</span>
                    </NavLink>
                }
            </div>
        </nav>
    </aside>

    <!-- Main Content -->
    <div class="flex-1 ml-64">
        <!-- Top Header -->
        <header class="bg-white shadow-sm sticky top-0 z-30">
            <div class="flex items-center justify-between px-8 h-20">
                <!-- Left: Greeting -->
                <div>
                    <AuthorizeView>
                        <Authorized>
                            <h4 class="text-xl font-semibold text-gray-900 mb-0">
                                Hey, @(context.User.FindFirst("FullName")?.Value ?? context.User.Identity?.Name ?? "Administrator") ðŸ‘‹
                            </h4>
                        </Authorized>
                        <NotAuthorized>
                            <h4 class="text-xl font-semibold text-gray-900 mb-0">
                                Welcome ðŸ‘‹
                            </h4>
                        </NotAuthorized>
                    </AuthorizeView>
                    <p class="text-gray-500 text-sm mb-0 font-medium">
                        @DateTime.Now.ToString("dd/MM/yyyy")
                    </p>
                </div>

                <!-- Right: Actions -->
                <div class="flex items-center gap-4">
                    <!-- Role Badge -->
                    <AuthorizeView>
                        <Authorized>
                            @{
                                var roleBadge = GetRoleBadge(userRole);
                            }
                            <div class="@roleBadge.bgClass px-4 py-2 rounded-lg shadow-sm">
                                <div class="flex items-center gap-2">
                                    <Icon Name="@roleBadge.icon" class="@roleBadge.textClass" />
                                    <span class="@roleBadge.textClass font-semibold text-sm">@roleBadge.label</span>
                                </div>
                            </div>
                        </Authorized>
                    </AuthorizeView>

                    <!-- User Dropdown -->
                    <AuthorizeView>
                        <Authorized>
                            <div class="relative group">
                                <button class="flex items-center gap-3 bg-white hover:bg-gray-50 text-gray-700 px-3 py-2 rounded-lg transition border border-gray-200 shadow-sm">
                                    <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-white text-sm font-semibold shadow-sm">
                                        @(context.User.Identity?.Name?.Substring(0, 1).ToUpper() ?? "A")
                                    </div>
                                    <span class="text-gray-900 font-medium text-sm">@(context.User.Identity?.Name ?? "admin")</span>
                                    <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.ChevronDown" class="text-xs text-gray-500" />
                                </button>
                                <div class="absolute right-0 w-48 bg-white rounded-lg shadow-xl py-2 hidden group-hover:block z-50 border border-gray-100">
                                    <a href="/" class="flex items-center gap-3 px-4 py-2.5 text-gray-700 hover:bg-gray-50 text-sm transition">
                                        <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.Store" /> View Store
                                    </a>
                                    <hr class="my-1 border-gray-100" />
                                    <a href="/Account/Logout" class="flex items-center gap-3 px-4 py-2.5 text-red-600 hover:bg-red-50 text-sm transition">
                                        <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.SignOutAlt" /> Logout
                                    </a>
                                </div>
                            </div>
                        </Authorized>
                        <NotAuthorized>
                            <a href="/login" class="flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-lg transition font-medium shadow-sm">
                                <Icon Name="Blazorise.Icons.FontAwesome.FontAwesomeIcons.SignInAlt" /> Login
                            </a>
                        </NotAuthorized>
                    </AuthorizeView>
                </div>
            </div>
        </header>

        <!-- Page Content -->
        <main class="p-8">
            @Body
        </main>
    </div>
</div>

<div id="blazor-error-ui" data-nosnippet class="fixed bottom-0 left-0 right-0 bg-red-600 text-white p-4 text-center hidden">
    An unhandled error has occurred.
    <a href="." class="reload underline ml-2">Reload</a>
    <span class="dismiss cursor-pointer ml-4">?</span>
</div>

<style>
    .admin-layout .nav-link.active {
        background-color: rgb(239 246 255) !important;
        color: rgb(37 99 235) !important;
        font-weight: 500;
    }

    .admin-sidebar {
        transition: transform 0.3s ease;
    }

    @@media (max-width: 1024px) {
        .admin-sidebar {
            transform: translateX(-100%);
        }
        .admin-layout .ml-64 {
            margin-left: 0;
        }
    }
</style>

<ToastContainer />

@code {
    private int cartItemCount = 0;
    private string userRole = "";

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var claimsPrincipal = authState.User;

        if (claimsPrincipal.Identity?.IsAuthenticated == true)
        {
            // Try to get role from claim (ApplicationUser role - "Admin" role)
            var roleClaim = claimsPrincipal.FindFirst(ClaimTypes.Role);
            if (roleClaim != null && roleClaim.Value.ToLower() == "admin")
            {
                userRole = "admin";
            }
            else
            {
                // Try to get username and lookup role from User table
                var username = claimsPrincipal.Identity.Name;
                if (!string.IsNullOrEmpty(username))
                {
                    await using var context = await DbContextFactory.CreateDbContextAsync();
                    var user = await context.Users
                        .FirstOrDefaultAsync(u => u.Username == username);

                    if (user != null)
                    {
                        userRole = user.Role;
                    }
                    else
                    {
                        userRole = "admin"; // Default to admin if user not found in User table
                    }
                }
                else
                {
                    userRole = "admin"; // Default to admin if no username
                }
            }
        }
    }

    private (string label, string bgClass, string textClass, string icon) GetRoleBadge(string role)
    {
        return role switch
        {
            "admin" => ("Administrator", "bg-gradient-to-r from-purple-500 to-pink-500", "text-white", "Blazorise.Icons.FontAwesome.FontAwesomeIcons.Crown"),
            "sales_staff" => ("Sales Staff", "bg-gradient-to-r from-blue-500 to-cyan-500", "text-white", "Blazorise.Icons.FontAwesome.FontAwesomeIcons.ShoppingCart"),
            "warehouse_staff" => ("Warehouse Staff", "bg-gradient-to-r from-green-500 to-teal-500", "text-white", "Blazorise.Icons.FontAwesome.FontAwesomeIcons.Warehouse"),
            _ => ("Staff", "bg-gray-500", "text-white", "Blazorise.Icons.FontAwesome.FontAwesomeIcons.User")
        };
    }
}
